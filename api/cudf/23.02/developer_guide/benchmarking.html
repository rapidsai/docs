<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport"><meta content="Docutils 0.17.1: http://docutils.sourceforge.net/" name="generator">

    <title>Benchmarking cuDF &mdash; cudf 23.02.00 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=796348d33e8b1d947c94" rel="stylesheet">
<link href="../_static/styles/bootstrap.css?digest=796348d33e8b1d947c94" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=796348d33e8b1d947c94" rel="stylesheet">

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=796348d33e8b1d947c94" rel="stylesheet">
  <link as="font" crossorigin="" href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" rel="preload" type="font/woff2">
<link as="font" crossorigin="" href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" rel="preload" type="font/woff2">
<link as="font" crossorigin="" href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" rel="preload" type="font/woff2">

    <link href="../_static/pygments.css" rel="stylesheet" type="text/css">
    <link href="../_static/copybutton.css" rel="stylesheet" type="text/css">
    <link href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" rel="stylesheet" type="text/css">
    <link href="https://docs.rapids.ai/assets/css/custom.css" rel="stylesheet" type="text/css">
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link as="script" href="../_static/scripts/bootstrap.js?digest=796348d33e8b1d947c94" rel="preload">
<link as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=796348d33e8b1d947c94" rel="preload">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script defer="defer" src="https://docs.rapids.ai/assets/js/custom.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'developer_guide/benchmarking';</script>
    <link href="../genindex.html" rel="index" title="Index">
    <link href="../search.html" rel="search" title="Search">
    <link href="options.html" rel="next" title="Options">
    <link href="testing.html" rel="prev" title="Testing cuDF">
  <meta content="width=device-width, initial-scale=1" name="viewport">
  <meta content="en" name="docsearch:language">
  <script id="rapids-selector-pixel-src" src="https://assets.adobedtm.com/5d4962a43b79/814eb6e9b4e1/launch-4bc07f1e0b0b.min.js"></script><link href="/assets/css/custom.css" id="rapids-selector-css" rel="stylesheet"></head>
  
  
  <body data-default-mode="" data-offset="180" data-spy="scroll" data-target="#bd-toc-nav">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>

  
  <input class="sidebar-toggle" id="__primary" name="__primary" type="checkbox">
  <label class="overlay overlay-primary" for="__primary"></label>

  
  <input class="sidebar-toggle" id="__secondary" name="__secondary" type="checkbox">
  <label class="overlay overlay-secondary" for="__secondary"></label>

  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
      
<form action="../search.html" class="bd-search d-flex align-items-center" method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input aria-label="Search the docs ..." autocapitalize="off" autocomplete="off" autocorrect="off" class="form-control" id="search-input" name="q" placeholder="Search the docs ..." spellcheck="false" type="search">
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
    </div>
  </div>

  
  <nav class="bd-header navbar navbar-expand-lg bd-navbar" id="navbar-main"><div class="bd-header__inner bd-page-width">
  <label class="sidebar-toggle primary-toggle" for="__primary">
      <span class="fa-solid fa-bars"></span>
  </label>
  <div id="navbar-start">
    
    
  


<a class="navbar-brand logo" href="../index.html">

  
  
  
  
  
  
  

  
    <img alt="Logo image" class="logo__image only-light" src="../_static/RAPIDS-logo-purple.png">
    <img alt="Logo image" class="logo__image only-dark" src="../_static/RAPIDS-logo-purple.png">
  
  
</a>
    
  </div>

  
  <div class="navbar-header-items">
    <div class="ml-auto" id="navbar-center">
      
      <div class="navbar-center-item">
        <nav class="navbar-nav">
    <p aria-label="Site Navigation" aria-level="1" class="sidebar-header-items__title" role="heading">
        Site Navigation
    </p>
    <ul class="navbar-nav" id="navbar-main-elements">
        
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../user_guide/index.html">
                        User Guide
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../api_docs/index.html">
                        API reference
                      </a>
                    </li>
                

                    <li class="nav-item current active">
                      <a class="nav-link nav-internal" href="index.html">
                        Developer Guide
                      </a>
                    </li>
                
    </ul>
</nav>
      </div>
      
    </div>

    <div id="navbar-end">
      
        <div class="navbar-end-item navbar-persistent--container">
          
<button aria-label="Search" class="btn btn-sm navbar-btn search-button search-button__button" data-toggle="tooltip" title="Search">
  <i class="fa-solid fa-magnifying-glass"></i>
</button>
        </div>
      
      
      <div class="navbar-end-item">
        <button aria-label="light/dark" class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" data-toggle="tooltip" title="light/dark">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
</button>
      </div>
      
      <div class="navbar-end-item">
        <ul aria-label="Icon Links" class="navbar-nav" id="navbar-icon-links">
        <li class="nav-item">
          
          
          
          
          
          
          
          <a class="nav-link" data-toggle="tooltip" href="https://github.com/rapidsai/cudf" rel="noopener" target="_blank" title="GitHub"><span><i class="fa-brands fa-square-github"></i></span>
            <label class="sr-only">GitHub</label></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          <a class="nav-link" data-toggle="tooltip" href="https://twitter.com/rapidsai" rel="noopener" target="_blank" title="Twitter"><span><i class="fa-brands fa-square-twitter"></i></span>
            <label class="sr-only">Twitter</label></a>
        </li>
      </ul>
      </div>
      
    </div>
  </div>


  
  
    <div class="navbar-persistent--mobile">
<button aria-label="Search" class="btn btn-sm navbar-btn search-button search-button__button" data-toggle="tooltip" title="Search">
  <i class="fa-solid fa-magnifying-glass"></i>
</button>
    </div>
  

  
  <label class="sidebar-toggle secondary-toggle" for="__secondary">
      <span class="fa-solid fa-outdent"></span>
  </label>
  

</div>
  </nav>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar"><div id="rapids-pydata-container"><div class="rapids-home-container"><a class="rapids-home-container__home-btn" href="/api">Home</a></div><div class="rapids-selector__container rapids-selector--hidden"><div class="rapids-selector__selected">cudf</div><div class="rapids-selector__menu"><a class="rapids-selector__menu-item" href="/api/clx/stable/api.html">clx</a><a class="rapids-selector__menu-item" href="/api/cucim/stable/api.html">cucim</a><a class="rapids-selector__menu-item rapids-selector__menu-item--selected" href="/api/cudf/stable/index.html">cudf</a><a class="rapids-selector__menu-item" href="/api/cudf-java/nightly">cudf-java</a><a class="rapids-selector__menu-item" href="/api/cugraph/stable">cugraph</a><a class="rapids-selector__menu-item" href="/api/cuml/stable/api.html">cuml</a><a class="rapids-selector__menu-item" href="/api/cusignal/stable/api.html">cusignal</a><a class="rapids-selector__menu-item" href="/api/cuspatial/stable">cuspatial</a><a class="rapids-selector__menu-item" href="/api/cuxfilter/stable">cuxfilter</a><a class="rapids-selector__menu-item" href="/api/dask-cuda/stable/api.html">dask-cuda</a><a class="rapids-selector__menu-item" href="/api/kvikio/stable/api.html">kvikio</a><a class="rapids-selector__menu-item" href="/api/libcudf/stable/namespacecudf.html">libcudf</a><a class="rapids-selector__menu-item" href="/api/libcugraph/stable">libcugraph</a><a class="rapids-selector__menu-item" href="/api/libcuml/stable">libcuml</a><a class="rapids-selector__menu-item" href="/api/libcuspatial/stable">libcuspatial</a><a class="rapids-selector__menu-item" href="/api/libkvikio/stable">libkvikio</a><a class="rapids-selector__menu-item" href="/api/librmm/stable/annotated.html">librmm</a><a class="rapids-selector__menu-item" href="/api/raft/stable">raft</a><a class="rapids-selector__menu-item" href="/api/rapids-cmake/stable/api.html">rapids-cmake</a><a class="rapids-selector__menu-item" href="/api/rmm/stable/api.html">rmm</a></div></div><div class="rapids-selector__container rapids-selector--hidden"><div class="rapids-selector__selected">nightly (23.02)</div><div class="rapids-selector__menu"><a class="rapids-selector__menu-item rapids-selector__menu-item--selected" href="/api/cudf/nightly/index.html">nightly (23.02)</a><a class="rapids-selector__menu-item" href="/api/cudf/stable/index.html">stable (22.12)</a><a class="rapids-selector__menu-item" href="/api/cudf/legacy/index.html">legacy (22.10)</a></div></div></div>
        
  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
      
      <div class="navbar-center-item">
        <nav class="navbar-nav">
    <p aria-label="Site Navigation" aria-level="1" class="sidebar-header-items__title" role="heading">
        Site Navigation
    </p>
    <ul class="navbar-nav" id="navbar-main-elements">
        
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../user_guide/index.html">
                        User Guide
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../api_docs/index.html">
                        API reference
                      </a>
                    </li>
                

                    <li class="nav-item current active">
                      <a class="nav-link nav-internal" href="index.html">
                        Developer Guide
                      </a>
                    </li>
                
    </ul>
</nav>
      </div>
      
      </div>
    

    
    
    <div class="sidebar-header-items__end">
      
      <div class="navbar-end-item">
        <button aria-label="light/dark" class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" data-toggle="tooltip" title="light/dark">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
</button>
      </div>
      
      <div class="navbar-end-item">
        <ul aria-label="Icon Links" class="navbar-nav" id="navbar-icon-links">
        <li class="nav-item">
          
          
          
          
          
          
          
          <a class="nav-link" data-toggle="tooltip" href="https://github.com/rapidsai/cudf" rel="noopener" target="_blank" title="GitHub"><span><i class="fa-brands fa-square-github"></i></span>
            <label class="sr-only">GitHub</label></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          <a class="nav-link" data-toggle="tooltip" href="https://twitter.com/rapidsai" rel="noopener" target="_blank" title="Twitter"><span><i class="fa-brands fa-square-twitter"></i></span>
            <label class="sr-only">Twitter</label></a>
        </li>
      </ul>
      </div>
      
    </div>
    
  </div>

  
  <div class="sidebar-start-items sidebar-primary__section">
    <div class="sidebar-start-items__item"><nav aria-label="Section navigation" class="bd-links" id="bd-docs-nav">
  <p aria-level="1" class="bd-links__title" role="heading">
    Section Navigation
  </p>
  <div class="bd-toc-item navbar-nav">
    <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="library_design.html">Library Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributing_guide.html">Contributing Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="documentation.html">Writing documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="testing.html">Testing cuDF</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Benchmarking cuDF</a></li>
<li class="toctree-l1"><a class="reference internal" href="options.html">Options</a></li>
</ul>

  </div>
</nav>
    </div>
  </div>
  

  
  <div class="sidebar-end-items sidebar-primary__section">
    <div class="sidebar-end-items__item">
    </div>
  </div>

  
  <div id="rtd-footer-container"></div>

      </div>
      <main class="bd-main" id="main-content">
        
        
        <div class="bd-content">
          <div class="bd-article-container">
            
            <div class="bd-header-article">
                
            </div>
            
            
            <article class="bd-article" role="main">
              
  <section id="benchmarking-cudf">
<h1>Benchmarking cuDF<a class="headerlink" href="#benchmarking-cudf" title="Permalink to this heading">#</a></h1>
<p>The goal of the benchmarks in this repository is to measure the performance of various cuDF APIs.
Benchmarks in cuDF are written using the
<a class="reference external" href="https://pytest-benchmark.readthedocs.io/en/latest/index.html"><code class="docutils literal notranslate"><span class="pre">pytest-benchmark</span></code></a> plugin to the
<a class="reference external" href="https://docs.pytest.org/en/latest/"><code class="docutils literal notranslate"><span class="pre">pytest</span></code></a> Python testing framework.
Using <code class="docutils literal notranslate"><span class="pre">pytest-benchmark</span></code> provides a seamless experience for developers familiar with <code class="docutils literal notranslate"><span class="pre">pytest</span></code>.
We include benchmarks of both public APIs and internal functions.
The former give us a macro view of our performance, especially vis-&agrave;-vis pandas.
The latter help us quantify and minimize the overhead of our Python bindings.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Our current benchmarks focus entirely on measuring run time.
However, minimizing memory footprint can be just as important for some cases.
In the future, we may update our benchmarks to also include memory usage measurements.</p>
</div>
<section id="benchmark-organization">
<h2>Benchmark organization<a class="headerlink" href="#benchmark-organization" title="Permalink to this heading">#</a></h2>
<p>At the top level benchmarks are divided into <code class="docutils literal notranslate"><span class="pre">internal</span></code> and <code class="docutils literal notranslate"><span class="pre">API</span></code> directories.
API benchmarks are for public features that we expect users to consume.
Internal benchmarks capture the performance of cuDF internals that have no stability guarantees.</p>
<p>Within each directory, benchmarks are organized based on the type of function.
Functions in cuDF generally fall into two groups:</p>
<ol class="arabic simple">
<li><p>Methods of classes like <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code> or <code class="docutils literal notranslate"><span class="pre">Series</span></code>.</p></li>
<li><p>Free functions operating on the above classes like <code class="docutils literal notranslate"><span class="pre">cudf.merge</span></code>.</p></li>
</ol>
<p>The former should be organized into files named <code class="docutils literal notranslate"><span class="pre">bench_class.py</span></code>.
For example, benchmarks of <code class="docutils literal notranslate"><span class="pre">DataFrame.eval</span></code> belong in <code class="docutils literal notranslate"><span class="pre">API/bench_dataframe.py</span></code>.
Benchmarks should be written at the highest level of generality possible with respect to the class hierarchy.
For instance, all classes support the <code class="docutils literal notranslate"><span class="pre">take</span></code> method, so those benchmarks belong in <code class="docutils literal notranslate"><span class="pre">API/bench_frame_or_index.py</span></code>.
If a method has a slightly different API for different classes, benchmarks should use a minimal common API,
<em>unless</em> developers expect certain arguments to trigger code paths with very different performance characteristics.
One example, is <code class="docutils literal notranslate"><span class="pre">DataFrame.where</span></code>, which supports a wide range of inputs (like other <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code>s) that other classes don&rsquo;t support.
Therefore, we have separate benchmarks for <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code>, in addition to the general benchmarks for all <code class="docutils literal notranslate"><span class="pre">Frame</span></code> and <code class="docutils literal notranslate"><span class="pre">Index</span></code> classes.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code class="docutils literal notranslate"><span class="pre">pytest</span></code> does not support having two benchmark files with the same name, even if they are in separate directories.
Therefore, benchmarks of internal methods of <em>public</em> classes go in files suffixed with <code class="docutils literal notranslate"><span class="pre">_internal</span></code>.
Benchmarks of <code class="docutils literal notranslate"><span class="pre">DataFrame._apply_boolean_mask</span></code>, for instance, belong in <code class="docutils literal notranslate"><span class="pre">internal/bench_dataframe_internal.py</span></code>.</p>
</div>
<p>Free functions have more flexibility.
Broadly speaking, they should be grouped into benchmark files containing similar functionality.
For example, I/O benchmarks can all live in <code class="docutils literal notranslate"><span class="pre">bench_io.py</span></code>.
For now those groupings are left to the discretion of developers.</p>
</section>
<section id="running-benchmarks">
<h2>Running benchmarks<a class="headerlink" href="#running-benchmarks" title="Permalink to this heading">#</a></h2>
<p>By default, pytest discovers test files and functions prefixed with <code class="docutils literal notranslate"><span class="pre">test_</span></code>.
For benchmarks, we configure <code class="docutils literal notranslate"><span class="pre">pytest</span></code> to instead search using the <code class="docutils literal notranslate"><span class="pre">bench_</span></code> prefix.
After installing <code class="docutils literal notranslate"><span class="pre">pytest-benchmark</span></code>, running benchmarks is as simple as just running <code class="docutils literal notranslate"><span class="pre">pytest</span></code>.</p>
<p>When benchmarks are run, the default behavior is to output the results in a table to the terminal.
A common requirement is to then compare the performance of benchmarks before and after a change.
We can generate these comparisons by saving the output using the <code class="docutils literal notranslate"><span class="pre">--benchmark-autosave</span></code> option to pytest.
When using this option, after the benchmarks are run the output will contain a line:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Saved</span> <span class="n">benchmark</span> <span class="n">data</span> <span class="ow">in</span><span class="p">:</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">XXXX_</span><span class="o">*.</span><span class="n">json</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">XXXX</span></code> is a four-digit number identifying the benchmark.
If preferred, a user may also use the <code class="docutils literal notranslate"><span class="pre">--benchmark-save=NAME</span></code> option,
which allows more control over the resulting filename.
Given two benchmark runs <code class="docutils literal notranslate"><span class="pre">XXXX</span></code> and <code class="docutils literal notranslate"><span class="pre">YYYY</span></code>, benchmarks can then be compared using</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pytest</span><span class="o">-</span><span class="n">benchmark</span> <span class="n">compare</span> <span class="n">XXXX</span> <span class="n">YYYY</span>
</pre></div>
</div>
<p>Note that the comparison uses the <code class="docutils literal notranslate"><span class="pre">pytest-benchmark</span></code> command rather than the <code class="docutils literal notranslate"><span class="pre">pytest</span></code> command.
<code class="docutils literal notranslate"><span class="pre">pytest-benchmark</span></code> has a number of additional options that can be used to customize the output.
The next line contains one useful example, but developers should experiment to find a useful output</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pytest</span><span class="o">-</span><span class="n">benchmark</span> <span class="n">compare</span> <span class="n">XXXX</span> <span class="n">YYYY</span> <span class="o">--</span><span class="n">sort</span><span class="o">=</span><span class="s2">"name"</span> <span class="o">--</span><span class="n">columns</span><span class="o">=</span><span class="n">Mean</span> <span class="o">--</span><span class="n">name</span><span class="o">=</span><span class="n">short</span> <span class="o">--</span><span class="n">group</span><span class="o">-</span><span class="n">by</span><span class="o">=</span><span class="n">param</span>
</pre></div>
</div>
<p>For more details, see the <a class="reference external" href="https://pytest-benchmark.readthedocs.io/en/latest/comparing.html"><code class="docutils literal notranslate"><span class="pre">pytest-benchmark</span></code> documentation</a>.</p>
</section>
<section id="benchmark-contents">
<h2>Benchmark contents<a class="headerlink" href="#benchmark-contents" title="Permalink to this heading">#</a></h2>
<section id="benchmark-configuration">
<h3>Benchmark configuration<a class="headerlink" href="#benchmark-configuration" title="Permalink to this heading">#</a></h3>
<p>Benchmarks must support <a class="reference internal" href="#comparing-to-pandas"><span class="std std-doc">comparing to pandas</span></a> and <a class="reference internal" href="#testing-benchmarks"><span class="std std-doc">being run as tests</span></a>.
To satisfy these requirements, one must follow these rules when writing benchmarks:</p>
<ol class="arabic">
<li><p>Import <code class="docutils literal notranslate"><span class="pre">cudf</span></code> and <code class="docutils literal notranslate"><span class="pre">cupy</span></code> from the config module:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>    <span class="kn">from</span> <span class="nn">..common.config</span> <span class="kn">import</span> <span class="n">cudf</span><span class="p">,</span> <span class="n">cupy</span> <span class="c1"># Do this</span>
    <span class="kn">import</span> <span class="nn">cudf</span><span class="o">,</span> <span class="nn">cupy</span> <span class="c1"># Not this</span>
</pre></div>
</div>
<p>This enables swapping out for <code class="docutils literal notranslate"><span class="pre">pandas</span></code> and <code class="docutils literal notranslate"><span class="pre">numpy</span></code> respectively.</p>
</li>
<li><p>Avoid hard-coding benchmark dataset sizes, and instead use the sizes advertised by <code class="docutils literal notranslate"><span class="pre">config.py</span></code>.
This enables running the benchmarks in &ldquo;test&rdquo; mode on small datasets, which will be much faster.</p></li>
</ol>
</section>
<section id="writing-benchmarks">
<h3>Writing benchmarks<a class="headerlink" href="#writing-benchmarks" title="Permalink to this heading">#</a></h3>
<p>Just as benchmarks should be written in terms of the highest level classes in the hierarchy,
they should also assume as little as possible about the nature of the data.
For instance, unless there are meaningful functional differences,
benchmarks should not care about the dtype or nullability of the data.
Objects that differ in these ways should be interchangeable for most benchmarks.
The goal of writing benchmarks in this way is to then automatically benchmark objects with different properties.
We support this use case with the <code class="docutils literal notranslate"><span class="pre">benchmark_with_object</span></code> decorator.</p>
<p>The use of this decorator is best demonstrated by example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@benchmark_with_object</span><span class="p">(</span><span class="bp">cls</span><span class="o">=</span><span class="s2">"dataframe"</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">"int"</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">bench_foo</span><span class="p">(</span><span class="n">benchmark</span><span class="p">,</span> <span class="n">dataframe</span><span class="p">):</span>
    <span class="n">benchmark</span><span class="p">(</span><span class="n">dataframe</span><span class="o">.</span><span class="n">foo</span><span class="p">)</span>
</pre></div>
</div>
<p>In the example above <code class="docutils literal notranslate"><span class="pre">bench_foo</span></code> will be run for DataFrames containing six columns of integer data.
The decorator allows automatically parametrizing the following object properties:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">cls</span></code>: Objects of a specific class, e.g. <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dtype</span></code>: Objects of a specific dtype.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">nulls</span></code>: Objects with and without null entries.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cols</span></code>: Objects with a certain number of columns.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">rows</span></code>: Objects with a certain number of rows.</p></li>
</ul>
<p>In the example, since we did not specify the number of rows or nullability,
it will be run once for each valid number of rows and for both nullable and non-nullable data.
The valid set of all parameters (e.g. the numbers of rows) is stored in the <code class="docutils literal notranslate"><span class="pre">common/config.py</span></code> file.
This decorator allows a developer to write a generic benchmark that works for many types of objects,
then have that benchmark automatically run for all objects of interest.</p>
</section>
<section id="parametrizing-tests">
<h3>Parametrizing tests<a class="headerlink" href="#parametrizing-tests" title="Permalink to this heading">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">benchmark_with_object</span></code> decorator covers most use cases and automatically guarantees a baseline of benchmark coverage.
However, many benchmarks will require more customized objects.
In some cases those will be the primary targets whose methods are called.
For instance, a benchmark may require a <code class="docutils literal notranslate"><span class="pre">Series</span></code> with a specific data distribution.
In others, those objects will be arguments passed to other functions.
An example of this is <code class="docutils literal notranslate"><span class="pre">DataFrame.where</span></code>, which accepts many types of objects to filter with.</p>
<p>In the first case, fixtures should follow certain rules.
When writing fixtures, developers should make the data sizes dependent on the benchmarks configuration.
The <code class="docutils literal notranslate"><span class="pre">benchmarks/common/config.py</span></code> file defines standard data sizes to be used in benchmarks.
These data sizes can be tweaked for debugging purposes (see <a class="reference internal" href="#testing-benchmarks"><span class="std std-doc">Testing benchmarks</span></a> below).
Fixture sizes should be relative to the <code class="docutils literal notranslate"><span class="pre">NUM_ROWS</span></code> and/or <code class="docutils literal notranslate"><span class="pre">NUM_COLS</span></code> variables defined in the config module.
These rules ensure consistency between these fixtures and those provided by <code class="docutils literal notranslate"><span class="pre">benchmark_with_object</span></code>.</p>
</section>
</section>
<section id="comparing-to-pandas">
<h2>Comparing to pandas<a class="headerlink" href="#comparing-to-pandas" title="Permalink to this heading">#</a></h2>
<p>An important aspect of benchmarking cuDF is comparing it to pandas.
We often want to generate quantitative comparisons, so we need to make that as easy as possible.
Our benchmarks support this by setting the environment variable <code class="docutils literal notranslate"><span class="pre">CUDF_BENCHMARKS_USE_PANDAS</span></code>.
When this variable is detected, all benchmarks will automatically be run using pandas instead of cuDF.
Therefore, comparisons can easily be generated by simply running the benchmarks twice,
once with the variable set and once without.
Note that this variable only affects API benchmarks, not internal benchmarks,
since the latter are not even guaranteed to be valid pandas code.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code class="docutils literal notranslate"><span class="pre">CUDF_BENCHMARKS_USE_PANDAS</span></code> effectively remaps <code class="docutils literal notranslate"><span class="pre">cudf</span></code> to <code class="docutils literal notranslate"><span class="pre">pandas</span></code> and <code class="docutils literal notranslate"><span class="pre">cupy</span></code> to <code class="docutils literal notranslate"><span class="pre">numpy</span></code>.
It does so by aliasing these modules in <code class="docutils literal notranslate"><span class="pre">common.config.py</span></code>.
This aliasing is why it is critical for developers to import these packages from <code class="docutils literal notranslate"><span class="pre">config.py</span></code>.</p>
</div>
</section>
<section id="testing-benchmarks">
<h2>Testing benchmarks<a class="headerlink" href="#testing-benchmarks" title="Permalink to this heading">#</a></h2>
<p>Benchmarks need to be kept up to date with API changes in cuDF.
However, we cannot simply run benchmarks in CI.
Doing so would consume too many resources, and it would significantly slow down the development cycle</p>
<p>To balance these issues, our benchmarks also support running in &ldquo;testing&rdquo; mode.
To do so, developers can set the <code class="docutils literal notranslate"><span class="pre">CUDF_BENCHMARKS_DEBUG_ONLY</span></code> environment variable.
When benchmarks are run with this variable, all data sizes are set to a minimum and the number of sizes are reduced.
Our CI testing takes advantage of this to ensure that benchmarks remain valid code.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The objects provided by <code class="docutils literal notranslate"><span class="pre">benchmark_with_object</span></code> respect the <code class="docutils literal notranslate"><span class="pre">NUM_ROWS</span></code> and <code class="docutils literal notranslate"><span class="pre">NUM_COLS</span></code> defined in <code class="docutils literal notranslate"><span class="pre">common/config.py</span></code>.
<code class="docutils literal notranslate"><span class="pre">CUDF_BENCHMARKS_DEBUG_ONLY</span></code> works by conditionally redefining these values.
This is why it is crucial for developers to use these variables when defining custom fixtures or cases.</p>
</div>
</section>
<section id="profiling">
<h2>Profiling<a class="headerlink" href="#profiling" title="Permalink to this heading">#</a></h2>
<p>Although not strictly part of our benchmarking suite, profiling is a common need so we provide some guidelines here.
Here are two easy ways (there may be others) to profile benchmarks:</p>
<ol class="arabic simple">
<li><p>The <a class="reference external" href="https://github.com/man-group/pytest-plugins/tree/master/pytest-profiling"><code class="docutils literal notranslate"><span class="pre">pytest-profiling</span></code></a> plugin.</p></li>
<li><p>The <a class="reference external" href="https://github.com/benfred/py-spy"><code class="docutils literal notranslate"><span class="pre">py-spy</span></code></a> package.</p></li>
</ol>
<p>Using the former is as simple as adding the <code class="docutils literal notranslate"><span class="pre">--profile</span></code> (or <code class="docutils literal notranslate"><span class="pre">--profile-svg</span></code>) arguments to the <code class="docutils literal notranslate"><span class="pre">pytest</span></code> invocation.
The latter requires instead invoking pytest from py-spy, like so:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">py</span><span class="o">-</span><span class="n">spy</span> <span class="n">record</span> <span class="o">--</span> <span class="n">pytest</span> <span class="n">bench_foo</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<p>Each tool has different strengths and provides somewhat different information.
Developers should try both and see what works for a particular workflow.
Developers are also encouraged to share useful alternatives that they discover.</p>
</section>
<section id="advanced-topics">
<h2>Advanced Topics<a class="headerlink" href="#advanced-topics" title="Permalink to this heading">#</a></h2>
<p>This section discusses some underlying details of how cuDF benchmarks work.
They are not usually necessary for typical developers or benchmark writers.
This information is primarily for developers looking to extend the types of objects that can be easily benchmarked.</p>
<section id="understanding-benchmark-with-object">
<h3>Understanding <code class="docutils literal notranslate"><span class="pre">benchmark_with_object</span></code><a class="headerlink" href="#understanding-benchmark-with-object" title="Permalink to this heading">#</a></h3>
<p>Under the hood, <code class="docutils literal notranslate"><span class="pre">benchmark_with_object</span></code> is made up of two critical pieces, fixture unions and some decorator magic.</p>
<section id="fixture-unions">
<h4>Fixture unions<a class="headerlink" href="#fixture-unions" title="Permalink to this heading">#</a></h4>
<p>Fixture unions are a feature of <code class="docutils literal notranslate"><span class="pre">pytest_cases</span></code>.
A fixture union is a fixture that, when used as a test function parameter,
will trigger the test to run once for each fixture contained in the union.
Since most cuDF benchmarks can be run with the same relatively small set of objects,
our benchmarks generate the Cartesian product of possible fixtures and then create all possible unions.</p>
<p>This feature is critical to the design of our benchmarks.
For each of the relevant parameter combinations (size, nullability, etc) we programmatically generate a new fixture.
The resulting fixtures are unambiguously named according to the following scheme:
<code class="docutils literal notranslate"><span class="pre">{classname}_dtype_{dtype}[_nulls_{true|false}][[_cols_{num_cols}]_rows_{num_rows}]</span></code>.
If a fixture name does not contain a particular component, it represents a union of all values of that component.
As an example, consider the fixture <code class="docutils literal notranslate"><span class="pre">dataframe_dtype_int_rows_100</span></code>.
This fixture is a union of both nullable and non-nullable <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code>s with different numbers of columns.</p>
</section>
<section id="the-benchmark-with-object-decorator">
<h4>The <code class="docutils literal notranslate"><span class="pre">benchmark_with_object</span></code> decorator<a class="headerlink" href="#the-benchmark-with-object-decorator" title="Permalink to this heading">#</a></h4>
<p>The long names of the above unions are cumbersome when writing tests.
Moreover, having this information embedded in the name means that in order to change the parameters used,
the entire benchmark needs to have the fixture name replaced.
The <code class="docutils literal notranslate"><span class="pre">benchmark_with_object</span></code> decorator is the solution to this problem.
When used on a test function, it essentially replaces the function parameter name with the true fixture.
In our original example from above</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@benchmark_with_object</span><span class="p">(</span><span class="bp">cls</span><span class="o">=</span><span class="s2">"dataframe"</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">"int"</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">bench_foo</span><span class="p">(</span><span class="n">benchmark</span><span class="p">,</span> <span class="n">dataframe</span><span class="p">):</span>
    <span class="n">benchmark</span><span class="p">(</span><span class="n">dataframe</span><span class="o">.</span><span class="n">foo</span><span class="p">)</span>
</pre></div>
</div>
<p>is functionally equivalent to</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">bench_foo</span><span class="p">(</span><span class="n">benchmark</span><span class="p">,</span> <span class="n">dataframe_dtype_int_cols_6</span><span class="p">):</span>
    <span class="n">benchmark</span><span class="p">(</span><span class="n">dataframe_dtype_int_cols_6</span><span class="o">.</span><span class="n">foo</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
</section>
</section>


            </article>
            
            
            
            <footer class="bd-footer-article">
                <!-- Previous / next buttons -->
<div class="prev-next-area">
  <a class="left-prev" href="testing.html" id="prev-link" title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
          <p class="prev-next-subtitle">previous</p>
          <p class="prev-next-title">Testing cuDF</p>
      </div>
  </a>
  <a class="right-next" href="options.html" id="next-link" title="next page">
  <div class="prev-next-info">
      <p class="prev-next-subtitle">next</p>
      <p class="prev-next-title">Options</p>
  </div>
  <i class="fa-solid fa-angle-right"></i>
  </a>
</div>
            </footer>
            
          </div>
          
          
          
            <div class="bd-sidebar-secondary bd-toc">
              
<div class="toc-item">
  
<div class="tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
</div>
<nav class="page-toc" id="bd-toc-nav">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#benchmark-organization">
   Benchmark organization
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#running-benchmarks">
   Running benchmarks
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#benchmark-contents">
   Benchmark contents
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#benchmark-configuration">
     Benchmark configuration
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#writing-benchmarks">
     Writing benchmarks
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#parametrizing-tests">
     Parametrizing tests
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#comparing-to-pandas">
   Comparing to pandas
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#testing-benchmarks">
   Testing benchmarks
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#profiling">
   Profiling
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#advanced-topics">
   Advanced Topics
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#understanding-benchmark-with-object">
     Understanding
     <code class="docutils literal notranslate">
      <span class="pre">
       benchmark_with_object
      </span>
     </code>
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#fixture-unions">
       Fixture unions
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#the-benchmark-with-object-decorator">
       The
       <code class="docutils literal notranslate">
        <span class="pre">
         benchmark_with_object
        </span>
       </code>
       decorator
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
</ul>

</nav>
</div>

<div class="toc-item">
  
<div id="searchbox"></div>
</div>

<div class="toc-item">
  
</div>

<div class="toc-item">
  
<div class="tocsection sourcelink">
    <a href="../_sources/developer_guide/benchmarking.md.txt">
        <i class="fa-solid fa-file-lines"></i> Show Source
    </a>
</div>

</div>

            </div>
          
          
        </div>
        <footer class="bd-footer-content">
          <div class="bd-footer-content__inner">
            
          </div>
        </footer>
        
      </main>
    </div>
  </div>

  
    
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=796348d33e8b1d947c94"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=796348d33e8b1d947c94"></script>

  <footer class="bd-footer"><div class="bd-footer__inner container">
  
  <div class="footer-item">
    
<p class="copyright">

    &copy; Copyright 2018-2021, NVIDIA.<br>

</p>

  </div>
  
  <div class="footer-item">
    <p class="theme-version">
    Built with the
    <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">
        PyData Sphinx Theme
    </a>
    0.12.0.
</p>
  </div>
  
  <div class="footer-item">
    
<p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 5.3.0.<br>
</p>

  </div>
  
</div>
  </footer>
  
<script defer id="rapids-selector-js" src="/assets/js/custom.js"></script><script id="rapids-selector-pixel-invocation" type="text/javascript">_satellite.pageBottom();</script></body></html>