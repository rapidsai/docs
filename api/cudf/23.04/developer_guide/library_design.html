<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport"><meta content="Docutils 0.18.1: http://docutils.sourceforge.net/" name="generator">

    <title>Library Design &mdash; cudf 23.04.00 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=12da95d707ffb74b382d" rel="stylesheet">
<link href="../_static/styles/bootstrap.css?digest=12da95d707ffb74b382d" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=12da95d707ffb74b382d" rel="stylesheet">

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=12da95d707ffb74b382d" rel="stylesheet">
  <link as="font" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" rel="preload" type="font/woff2">
<link as="font" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" rel="preload" type="font/woff2">
<link as="font" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" rel="preload" type="font/woff2">

    <link href="../_static/pygments.css" rel="stylesheet" type="text/css">
    <link href="../_static/copybutton.css" rel="stylesheet" type="text/css">
    <link href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" rel="stylesheet" type="text/css">
    <link href="https://docs.rapids.ai/assets/css/custom.css" rel="stylesheet" type="text/css">
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link as="script" href="../_static/scripts/bootstrap.js?digest=12da95d707ffb74b382d" rel="preload">
<link as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=12da95d707ffb74b382d" rel="preload">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script defer="defer" src="https://docs.rapids.ai/assets/js/custom.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'developer_guide/library_design';</script>
    <link href="../genindex.html" rel="index" title="Index">
    <link href="../search.html" rel="search" title="Search">
    <link href="contributing_guide.html" rel="next" title="Contributing Guide">
    <link href="index.html" rel="prev" title="Developer Guide">
  <meta content="width=device-width, initial-scale=1" name="viewport">
  <meta content="en" name="docsearch:language">
  <script id="rapids-selector-pixel-src" src="https://assets.adobedtm.com/5d4962a43b79/814eb6e9b4e1/launch-4bc07f1e0b0b.min.js"></script><link href="/assets/css/custom.css" id="rapids-selector-css" rel="stylesheet"></head>
  
  
  <body data-bs-root-margin="0px 0px -60%" data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-default-mode data-offset="180">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input class="sidebar-toggle" id="__primary" name="__primary" type="checkbox">
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input class="sidebar-toggle" id="__secondary" name="__secondary" type="checkbox">
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form action="../search.html" class="bd-search d-flex align-items-center" method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input aria-label="Search the docs ..." autocapitalize="off" autocomplete="off" autocorrect="off" class="form-control" id="search-input" name="q" placeholder="Search the docs ..." spellcheck="false" type="search">
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
<div class="bd-header__inner bd-page-width">
  <label class="sidebar-toggle primary-toggle" for="__primary">
    <span class="fa-solid fa-bars"></span>
  </label>
  
  <div class="navbar-header-items__start">
    
      <div class="navbar-item">
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
    
    
      
    
    
    <img alt="Logo image" class="logo__image only-light" src="../_static/RAPIDS-logo-purple.png">
    <script>document.write(`<img src="../_static/RAPIDS-logo-purple.png" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
    
  </div>
  
  
  <div class="navbar-header-items">
    
    <div class="ms-auto navbar-header-items__center">
      
        <div class="navbar-item"><nav class="navbar-nav">
  <p aria-label="Site Navigation" aria-level="1" class="sidebar-header-items__title" role="heading">
    Site Navigation
  </p>
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../user_guide/index.html">
                        User Guide
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../api_docs/index.html">
                        API reference
                      </a>
                    </li>
                

                    <li class="nav-item current active">
                      <a class="nav-link nav-internal" href="index.html">
                        Developer Guide
                      </a>
                    </li>
                
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          
<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
        </div>
      
      
        <div class="navbar-item">
<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script></div>
      
        <div class="navbar-item"><ul aria-label="Icon Links" class="navbar-icon-links navbar-nav">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a class="nav-link" data-bs-placement="bottom" data-bs-toggle="tooltip" href="https://github.com/rapidsai/cudf" rel="noopener" target="_blank" title="GitHub"><span><i class="fa-brands fa-square-github"></i></span>
            <label class="sr-only">GitHub</label></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a class="nav-link" data-bs-placement="bottom" data-bs-toggle="tooltip" href="https://twitter.com/rapidsai" rel="noopener" target="_blank" title="Twitter"><span><i class="fa-brands fa-square-twitter"></i></span>
            <label class="sr-only">Twitter</label></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">
<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
    </div>
  

  
    <label class="sidebar-toggle secondary-toggle" for="__secondary">
      <span class="fa-solid fa-outdent"></span>
    </label>
  
</div>

    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar"><div id="rapids-pydata-container"><div class="rapids-home-container"><a class="rapids-home-container__home-btn" href="/api">Home</a></div><div class="rapids-selector__container rapids-selector--hidden"><div class="rapids-selector__selected">cudf</div><div class="rapids-selector__menu"><a class="rapids-selector__menu-item" href="/api/clx/stable/api.html">clx</a><a class="rapids-selector__menu-item" href="/api/cucim/stable/api.html">cucim</a><a class="rapids-selector__menu-item rapids-selector__menu-item--selected" href="/api/cudf/stable/index.html">cudf</a><a class="rapids-selector__menu-item" href="/api/cudf-java/stable">cudf-java</a><a class="rapids-selector__menu-item" href="/api/cugraph/stable">cugraph</a><a class="rapids-selector__menu-item" href="/api/cuml/stable/api.html">cuml</a><a class="rapids-selector__menu-item" href="/api/cusignal/stable/api.html">cusignal</a><a class="rapids-selector__menu-item" href="/api/cuspatial/stable">cuspatial</a><a class="rapids-selector__menu-item" href="/api/cuxfilter/stable">cuxfilter</a><a class="rapids-selector__menu-item" href="/api/dask-cuda/stable/api.html">dask-cuda</a><a class="rapids-selector__menu-item" href="/api/kvikio/stable/api.html">kvikio</a><a class="rapids-selector__menu-item" href="/api/libcudf/stable/namespacecudf.html">libcudf</a><a class="rapids-selector__menu-item" href="/api/libcugraph/stable">libcugraph</a><a class="rapids-selector__menu-item" href="/api/libcuml/stable">libcuml</a><a class="rapids-selector__menu-item" href="/api/libcuspatial/stable">libcuspatial</a><a class="rapids-selector__menu-item" href="/api/libkvikio/stable">libkvikio</a><a class="rapids-selector__menu-item" href="/api/librmm/stable/annotated.html">librmm</a><a class="rapids-selector__menu-item" href="/api/raft/stable">raft</a><a class="rapids-selector__menu-item" href="/api/rapids-cmake/stable/api.html">rapids-cmake</a><a class="rapids-selector__menu-item" href="/api/rmm/stable/api.html">rmm</a></div></div><div class="rapids-selector__container rapids-selector--hidden"><div class="rapids-selector__selected">nightly (23.04)</div><div class="rapids-selector__menu"><a class="rapids-selector__menu-item rapids-selector__menu-item--selected" href="/api/cudf/nightly/index.html">nightly (23.04)</a><a class="rapids-selector__menu-item" href="/api/cudf/stable/index.html">stable (23.02)</a><a class="rapids-selector__menu-item" href="/api/cudf/legacy/index.html">legacy (22.12)</a></div></div></div>
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          <div class="navbar-item"><nav class="navbar-nav">
  <p aria-label="Site Navigation" aria-level="1" class="sidebar-header-items__title" role="heading">
    Site Navigation
  </p>
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../user_guide/index.html">
                        User Guide
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../api_docs/index.html">
                        API reference
                      </a>
                    </li>
                

                    <li class="nav-item current active">
                      <a class="nav-link nav-internal" href="index.html">
                        Developer Guide
                      </a>
                    </li>
                
  </ul>
</nav></div>
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">
<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script></div>
        
          <div class="navbar-item"><ul aria-label="Icon Links" class="navbar-icon-links navbar-nav">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a class="nav-link" data-bs-placement="bottom" data-bs-toggle="tooltip" href="https://github.com/rapidsai/cudf" rel="noopener" target="_blank" title="GitHub"><span><i class="fa-brands fa-square-github"></i></span>
            <label class="sr-only">GitHub</label></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a class="nav-link" data-bs-placement="bottom" data-bs-toggle="tooltip" href="https://twitter.com/rapidsai" rel="noopener" target="_blank" title="Twitter"><span><i class="fa-brands fa-square-twitter"></i></span>
            <label class="sr-only">Twitter</label></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item"><nav aria-label="Section Navigation" class="bd-docs-nav bd-links">
  <p aria-level="1" class="bd-links__title" role="heading">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><ul class="current nav bd-sidenav">
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Library Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributing_guide.html">Contributing Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="documentation.html">Writing documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="testing.html">Testing cuDF</a></li>
<li class="toctree-l1"><a class="reference internal" href="benchmarking.html">Benchmarking cuDF</a></li>
<li class="toctree-l1"><a class="reference internal" href="options.html">Options</a></li>
</ul>
</div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main class="bd-main" id="main-content">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumbs">
  <ul aria-label="Breadcrumb" class="bd-breadcrumbs" role="navigation">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a aria-label="Home" class="nav-link" href="../index.html">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a class="nav-link" href="index.html">Developer Guide</a></li>
    
    <li aria-current="page" class="breadcrumb-item active">Library Design</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section id="library-design">
<h1>Library Design<a class="headerlink" href="#library-design" title="Permalink to this heading">#</a></h1>
<p>At a high level, cuDF is structured in three layers, each of which serves a distinct purpose:</p>
<ol class="arabic simple">
<li><p>The Frame layer: The user-facing implementation of pandas-like data structures like <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code> and <code class="docutils literal notranslate"><span class="pre">Series</span></code>.</p></li>
<li><p>The Column layer: The core internal data structures used to bridge the gap to our lower-level implementations.</p></li>
<li><p>The Cython layer: The wrappers around the fast C++ <code class="docutils literal notranslate"><span class="pre">libcudf</span></code> library.</p></li>
</ol>
<p>In this document we will review each of these layers, their roles, and the requisite tradeoffs.
Finally we tie these pieces together to provide a more holistic view of the project.</p>
<section id="the-frame-layer">
<h2>The Frame layer<a class="headerlink" href="#the-frame-layer" title="Permalink to this heading">#</a></h2>
<img alt="../_images/frame_class_diagram.png" src="../_images/frame_class_diagram.png">
<p>This class diagram shows the relationship between the principal components of the Frame layer:
All classes in the Frame layer inherit from one or both of the two base classes in this layer: <code class="docutils literal notranslate"><span class="pre">Frame</span></code> and <code class="docutils literal notranslate"><span class="pre">BaseIndex</span></code>.
The eponymous <code class="docutils literal notranslate"><span class="pre">Frame</span></code> class is, at its core, a simple tabular data structure composed of columnar data.
Some types of <code class="docutils literal notranslate"><span class="pre">Frame</span></code> contain indexes; in particular, any <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code> or <code class="docutils literal notranslate"><span class="pre">Series</span></code> has an index.
However, as a general container of columnar data, <code class="docutils literal notranslate"><span class="pre">Frame</span></code> is also the parent class for most types of index.</p>
<p><code class="docutils literal notranslate"><span class="pre">BaseIndex</span></code>, meanwhile, is essentially an abstract base class encoding the <code class="docutils literal notranslate"><span class="pre">pandas.Index</span></code> API.
Various subclasses of <code class="docutils literal notranslate"><span class="pre">BaseIndex</span></code> implement this API in specific ways depending on their underlying data.
For example, <code class="docutils literal notranslate"><span class="pre">RangeIndex</span></code> avoids actually materializing a column, while a <code class="docutils literal notranslate"><span class="pre">MultiIndex</span></code> contains <em>multiple</em> columns.
Most other index classes consist of a single column of a given type, e.g. strings or datetimes.
As a result, using a single abstract parent provides the flexibility we need to support these different types.</p>
<p>With those preliminaries out of the way, let&rsquo;s dive in a little bit deeper.</p>
<section id="frames">
<h3>Frames<a class="headerlink" href="#frames" title="Permalink to this heading">#</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">Frame</span></code> exposes numerous methods common to all pandas data structures.
Any methods that have the same API across <code class="docutils literal notranslate"><span class="pre">Series</span></code>, <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code>, and <code class="docutils literal notranslate"><span class="pre">Index</span></code> should be defined here.
Additionally any (internal) methods that could be used to share code between those classes may also be defined here.</p>
<p>The primary internal subclass of <code class="docutils literal notranslate"><span class="pre">Frame</span></code> is <code class="docutils literal notranslate"><span class="pre">IndexedFrame</span></code>, a <code class="docutils literal notranslate"><span class="pre">Frame</span></code> with an index.
An <code class="docutils literal notranslate"><span class="pre">IndexedFrame</span></code> represents the first type of object mentioned above: indexed tables.
In particular, <code class="docutils literal notranslate"><span class="pre">IndexedFrame</span></code> is a parent class for <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code> and <code class="docutils literal notranslate"><span class="pre">Series</span></code>.
Any pandas methods that are defined for those two classes should be defined here.</p>
<p>The second internal subclass of <code class="docutils literal notranslate"><span class="pre">Frame</span></code> is <code class="docutils literal notranslate"><span class="pre">SingleColumnFrame</span></code>.
As you may surmise, it is a <code class="docutils literal notranslate"><span class="pre">Frame</span></code> with a single column of data.
This class is a parent for most types of indexes as well as <code class="docutils literal notranslate"><span class="pre">Series</span></code> (note the diamond inheritance pattern here).
While <code class="docutils literal notranslate"><span class="pre">IndexedFrame</span></code> provides a large amount of functionality, this class is much simpler.
It adds some simple APIs provided by all 1D pandas objects, and it flattens outputs where needed.</p>
</section>
<section id="indexes">
<h3>Indexes<a class="headerlink" href="#indexes" title="Permalink to this heading">#</a></h3>
<p>While we&rsquo;ve highlighted some exceptional cases of Indexes before, let&rsquo;s start with the base cases here first.
<code class="docutils literal notranslate"><span class="pre">BaseIndex</span></code> is intended to be a pure abstract class, i.e. all of its methods should simply raise <code class="docutils literal notranslate"><span class="pre">NotImplementedError</span></code>.
In practice, <code class="docutils literal notranslate"><span class="pre">BaseIndex</span></code> does have concrete implementations of a small set of methods.
However, currently many of these implementations are not applicable to all subclasses and will be eventually be removed.</p>
<p>Almost all indexes are subclasses of <code class="docutils literal notranslate"><span class="pre">GenericIndex</span></code>, a single-columned index with the class hierarchy:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">GenericIndex</span><span class="p">(</span><span class="n">SingleColumnFrame</span><span class="p">,</span> <span class="n">BaseIndex</span><span class="p">)</span>
</pre></div>
</div>
<p>Integer, float, or string indexes are all composed of a single column of data.
Most <code class="docutils literal notranslate"><span class="pre">GenericIndex</span></code> methods are inherited from <code class="docutils literal notranslate"><span class="pre">Frame</span></code>, saving us the trouble of rewriting them.</p>
<p>We now consider the three main exceptions to this model:</p>
<ul class="simple">
<li><p>A <code class="docutils literal notranslate"><span class="pre">RangeIndex</span></code> is not backed by a column of data, so it inherits directly from <code class="docutils literal notranslate"><span class="pre">BaseIndex</span></code> alone.
Wherever possible, its methods have special implementations designed to avoid materializing columns.
Where such an implementation is infeasible, we fall back to converting it to an <code class="docutils literal notranslate"><span class="pre">Int64Index</span></code> first instead.</p></li>
<li><p>A <code class="docutils literal notranslate"><span class="pre">MultiIndex</span></code> is backed by <em>multiple</em> columns of data.
Therefore, its inheritance hierarchy looks like <code class="docutils literal notranslate"><span class="pre">class</span> <span class="pre">MultiIndex(Frame,</span> <span class="pre">BaseIndex)</span></code>.
Some of its more <code class="docutils literal notranslate"><span class="pre">Frame</span></code>-like methods may be inherited,
but many others must be reimplemented since in many cases a <code class="docutils literal notranslate"><span class="pre">MultiIndex</span></code> is not expected to behave like a <code class="docutils literal notranslate"><span class="pre">Frame</span></code>.</p></li>
<li><p>Just like in pandas, <code class="docutils literal notranslate"><span class="pre">Index</span></code> itself can never be instantiated.
<code class="docutils literal notranslate"><span class="pre">pandas.Index</span></code> is the parent class for indexes,
but its constructor returns an appropriate subclass depending on the input data type and shape.
Unfortunately, mimicking this behavior requires overriding <code class="docutils literal notranslate"><span class="pre">__new__</span></code>,
which in turn makes shared initialization across inheritance trees much more cumbersome to manage.
To enable sharing constructor logic across different index classes,
we instead define <code class="docutils literal notranslate"><span class="pre">BaseIndex</span></code> as the parent class of all indexes.
<code class="docutils literal notranslate"><span class="pre">Index</span></code> inherits from <code class="docutils literal notranslate"><span class="pre">BaseIndex</span></code>, but it masquerades as a <code class="docutils literal notranslate"><span class="pre">BaseIndex</span></code> to match pandas.
This class should contain no implementations since it is simply a factory for other indexes.</p></li>
</ul>
</section>
</section>
<section id="the-column-layer">
<h2>The Column layer<a class="headerlink" href="#the-column-layer" title="Permalink to this heading">#</a></h2>
<p>The next layer in the cuDF stack is the Column layer.
This layer forms the glue between pandas-like APIs and our underlying data layouts.
The principal objects in the Column layer are the <code class="docutils literal notranslate"><span class="pre">ColumnAccessor</span></code> and the various <code class="docutils literal notranslate"><span class="pre">Column</span></code> classes.
The <code class="docutils literal notranslate"><span class="pre">Column</span></code> is cuDF&rsquo;s core data structure that represents a single column of data of a specific data type.
A <code class="docutils literal notranslate"><span class="pre">ColumnAccessor</span></code> is a dictionary-like interface to a sequence of <code class="docutils literal notranslate"><span class="pre">Column</span></code>s.
A <code class="docutils literal notranslate"><span class="pre">Frame</span></code> owns a <code class="docutils literal notranslate"><span class="pre">ColumnAccessor</span></code>.</p>
<section id="columnaccessor">
<h3>ColumnAccessor<a class="headerlink" href="#columnaccessor" title="Permalink to this heading">#</a></h3>
<p>The primary purpose of the <code class="docutils literal notranslate"><span class="pre">ColumnAccessor</span></code> is to encapsulate pandas column selection semantics.
Columns may be selected or inserted by index or by label, and label-based selections are as flexible as pandas is.
For instance, Columns may be selected hierarchically (using tuples) or via wildcards.
<code class="docutils literal notranslate"><span class="pre">ColumnAccessor</span></code>s also support the <code class="docutils literal notranslate"><span class="pre">MultiIndex</span></code> columns that can result from operations like groupbys.</p>
</section>
<section id="columns">
<h3>Columns<a class="headerlink" href="#columns" title="Permalink to this heading">#</a></h3>
<p>Under the hood, cuDF is built around the <a class="reference external" href="https://arrow.apache.org">Apache Arrow Format</a>.
This data format is both conducive to high-performance algorithms and suitable for data interchange between libraries.
The <code class="docutils literal notranslate"><span class="pre">Column</span></code> class encapsulates our implementation of this data format.
A <code class="docutils literal notranslate"><span class="pre">Column</span></code> is composed of the following:</p>
<ul class="simple">
<li><p>A <strong>data type</strong>, specifying the type of each element.</p></li>
<li><p>A <strong>data buffer</strong> that may store the data for the column elements.
Some column types do not have a data buffer, instead storing data in the children columns.</p></li>
<li><p>A <strong>mask buffer</strong> whose bits represent the validity (null or not null) of each element.
Nullability is a core concept in the Arrow data model.
Columns whose elements are all valid may not have a mask buffer.
Mask buffers are padded to 64 bytes.</p></li>
<li><p>Its <strong>children</strong>, a tuple of columns used to represent complex types such as structs or lists.</p></li>
<li><p>A <strong>size</strong> indicating the number of elements in the column.</p></li>
<li><p>An integer <strong>offset</strong> use to represent the first element of column that is the &ldquo;slice&rdquo; of another column.
The size of the column then gives the extent of the slice rather than the size of the underlying buffer.
A column that is not a slice has an offset of 0.</p></li>
</ul>
<p>More information about these fields can be found in the documentation of the
<a class="reference external" href="https://arrow.apache.org/docs/format/Columnar.html">Apache Arrow Columnar Format</a>,
which is what the cuDF <code class="docutils literal notranslate"><span class="pre">Column</span></code> is based on.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">Column</span></code> class is implemented in Cython to facilitate interoperability with <code class="docutils literal notranslate"><span class="pre">libcudf</span></code>&rsquo;s C++ data structures.
Most higher-level functionality is implemented in the <code class="docutils literal notranslate"><span class="pre">ColumnBase</span></code> subclass.
These functions rely <code class="docutils literal notranslate"><span class="pre">Column</span></code> APIs to call <code class="docutils literal notranslate"><span class="pre">libcudf</span></code> APIs and translate their results to Python.
This separation allows <code class="docutils literal notranslate"><span class="pre">ColumnBase</span></code> to be implemented in pure Python, which simplifies development and debugging.</p>
<p><code class="docutils literal notranslate"><span class="pre">ColumnBase</span></code> provides some standard methods, while other methods only make sense for data of a specific type.
As a result, we have various subclasses of <code class="docutils literal notranslate"><span class="pre">ColumnBase</span></code> like <code class="docutils literal notranslate"><span class="pre">NumericalColumn</span></code>, <code class="docutils literal notranslate"><span class="pre">StringColumn</span></code>, and <code class="docutils literal notranslate"><span class="pre">DatetimeColumn</span></code>.
Most dtype-specific decisions should be handled at the level of a specific <code class="docutils literal notranslate"><span class="pre">Column</span></code> subclass.
Each type of <code class="docutils literal notranslate"><span class="pre">Column</span></code> only implements methods supported by that data type.</p>
<p>Different types of <code class="docutils literal notranslate"><span class="pre">ColumnBase</span></code> are also stored differently in memory according to the Arrow format.
As one example, a <code class="docutils literal notranslate"><span class="pre">NumericalColumn</span></code> with 1000 <code class="docutils literal notranslate"><span class="pre">int32</span></code> elements and containing nulls is composed of:</p>
<ol class="arabic simple">
<li><p>A data buffer of size 4000 bytes (sizeof(int32) * 1000)</p></li>
<li><p>A mask buffer of size 128 bytes (1000/8 padded to a multiple of 64
bytes)</p></li>
<li><p>No children columns</p></li>
</ol>
<p>As another example, a <code class="docutils literal notranslate"><span class="pre">StringColumn</span></code> backing the Series <code class="docutils literal notranslate"><span class="pre">['do',</span> <span class="pre">'you',</span> <span class="pre">'have',</span> <span class="pre">'any',</span> <span class="pre">'cheese?']</span></code> is composed of:</p>
<ol class="arabic simple">
<li><p>No data buffer</p></li>
<li><p>No mask buffer as there are no nulls in the Series</p></li>
<li><p>Two children columns:</p>
<ul class="simple">
<li><p>A column of UTF-8 characters
<code class="docutils literal notranslate"><span class="pre">['d',</span> <span class="pre">'o',</span> <span class="pre">'y',</span> <span class="pre">'o',</span> <span class="pre">'u',</span> <span class="pre">'h',</span> <span class="pre">...,</span> <span class="pre">'?']</span></code></p></li>
<li><p>A column of &ldquo;offsets&rdquo; to the characters column (in this case,
<code class="docutils literal notranslate"><span class="pre">[0,</span> <span class="pre">2,</span> <span class="pre">5,</span> <span class="pre">9,</span> <span class="pre">12,</span> <span class="pre">19]</span></code>)</p></li>
</ul>
</li>
</ol>
</section>
<section id="data-types">
<h3>Data types<a class="headerlink" href="#data-types" title="Permalink to this heading">#</a></h3>
<p>cuDF uses <a class="reference external" href="https://numpy.org/doc/stable/reference/arrays.dtypes.html">dtypes</a> to represent different types of data.
Since efficient GPU algorithms require preexisting knowledge of data layouts,
cuDF does not support the arbitrary <code class="docutils literal notranslate"><span class="pre">object</span></code> dtype, but instead defines a few custom types for common use-cases:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ListDtype</span></code>: Lists where each element in every list in a Column is of the same type</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">StructDtype</span></code>: Dicts where a given key always maps to values of the same type</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">CategoricalDtype</span></code>: Analogous to the pandas categorical dtype except that the categories are stored in device memory</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">DecimalDtype</span></code>: Fixed-point numbers</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">IntervalDtype</span></code>: Intervals</p></li>
</ul>
<p>Note that there is a many-to-one mapping between data types and <code class="docutils literal notranslate"><span class="pre">Column</span></code> classes.
For instance, all numerical types (floats and ints of different widths) are all managed using <code class="docutils literal notranslate"><span class="pre">NumericalColumn</span></code>.</p>
</section>
<section id="buffer">
<h3>Buffer<a class="headerlink" href="#buffer" title="Permalink to this heading">#</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">Column</span></code>s are in turn composed of one or more <code class="docutils literal notranslate"><span class="pre">Buffer</span></code>s.
A <code class="docutils literal notranslate"><span class="pre">Buffer</span></code> represents a single, contiguous, device memory allocation owned by another object.
A <code class="docutils literal notranslate"><span class="pre">Buffer</span></code> constructed from a preexisting device memory allocation (such as a CuPy array) will view that memory.
Conversely, when constructed from a host object,
<code class="docutils literal notranslate"><span class="pre">Buffer</span></code> uses <a class="reference external" href="https://github.com/rapidsai/rmm#devicebuffers"><code class="docutils literal notranslate"><span class="pre">rmm.DeviceBuffer</span></code></a> to allocate new memory.
The data is then copied from the host object into the newly allocated device memory.
You can read more about <a class="reference external" href="https://github.com/rapidsai/rmm">device memory allocation with RMM here</a>.</p>
</section>
<section id="spilling-to-host-memory">
<h3>Spilling to host memory<a class="headerlink" href="#spilling-to-host-memory" title="Permalink to this heading">#</a></h3>
<p>Setting the environment variable <code class="docutils literal notranslate"><span class="pre">CUDF_SPILL=on</span></code> enables automatic spilling (and &ldquo;unspilling&rdquo;) of buffers from
device to host to enable out-of-memory computation, i.e., computing on objects that occupy more memory than is
available on the GPU.</p>
<p>Spilling can be enabled in two ways (it is disabled by default):</p>
<ul class="simple">
<li><p>setting the environment variable <code class="docutils literal notranslate"><span class="pre">CUDF_SPILL=on</span></code>, or</p></li>
<li><p>setting the <code class="docutils literal notranslate"><span class="pre">spill</span></code> option in <code class="docutils literal notranslate"><span class="pre">cudf</span></code> by doing <code class="docutils literal notranslate"><span class="pre">cudf.set_option("spill",</span> <span class="pre">True)</span></code>.</p></li>
</ul>
<p>Additionally, parameters are:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">CUDF_SPILL_ON_DEMAND=ON</span></code> / <code class="docutils literal notranslate"><span class="pre">cudf.set_option("spill_on_demand",</span> <span class="pre">True)</span></code>, which registers an RMM out-of-memory
error handler that spills buffers in order to free up memory. If spilling is enabled, spill on demand is <strong>enabled by default</strong>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">CUDF_SPILL_DEVICE_LIMIT=&lt;X&gt;</span></code> / <code class="docutils literal notranslate"><span class="pre">cudf.set_option("spill_device_limit",</span> <span class="pre">&lt;X&gt;)</span></code>, which sets a device memory limit
of <code class="docutils literal notranslate"><span class="pre">&lt;X&gt;</span></code> in bytes. This introduces a modest overhead and is <strong>disabled by default</strong>. Furthermore, this is a
<em>soft</em> limit. The memory usage might exceed the limit if too many buffers are unspillable.</p></li>
</ul>
<section id="design">
<span id="buffer-design"></span><h4>Design<a class="headerlink" href="#design" title="Permalink to this heading">#</a></h4>
<p>Spilling consists of two components:</p>
<ul class="simple">
<li><p>A new buffer sub-class, <code class="docutils literal notranslate"><span class="pre">SpillableBuffer</span></code>, that implements moving of its data from host to device memory in-place.</p></li>
<li><p>A spill manager that tracks all instances of <code class="docutils literal notranslate"><span class="pre">SpillableBuffer</span></code> and spills them on demand.
A global spill manager is used throughout cudf when spilling is enabled, which makes <code class="docutils literal notranslate"><span class="pre">as_buffer()</span></code> return <code class="docutils literal notranslate"><span class="pre">SpillableBuffer</span></code> instead of the default <code class="docutils literal notranslate"><span class="pre">Buffer</span></code> instances.</p></li>
</ul>
<p>Accessing <code class="docutils literal notranslate"><span class="pre">Buffer.get_ptr(...)</span></code>, we get the device memory pointer of the buffer. This is unproblematic in the case of <code class="docutils literal notranslate"><span class="pre">Buffer</span></code> but what happens when accessing <code class="docutils literal notranslate"><span class="pre">SpillableBuffer.get_ptr(...)</span></code>, which might have spilled its device memory. In this case, <code class="docutils literal notranslate"><span class="pre">SpillableBuffer</span></code> needs to unspill the memory before returning its device memory pointer. Furthermore, while this device memory pointer is being used (or could be used), <code class="docutils literal notranslate"><span class="pre">SpillableBuffer</span></code> cannot spill its memory back to host memory because doing so would invalidate the device pointer.</p>
<p>To address this, we mark the <code class="docutils literal notranslate"><span class="pre">SpillableBuffer</span></code> as unspillable, we say that the buffer has been <em>exposed</em>. This can either be permanent if the device pointer is exposed to external projects or temporary while <code class="docutils literal notranslate"><span class="pre">libcudf</span></code> accesses the device memory.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">SpillableBuffer.get_ptr(...)</span></code> returns the device pointer of the buffer memory but if called within an <code class="docutils literal notranslate"><span class="pre">acquire_spill_lock</span></code> decorator/context, the buffer is only marked unspillable while running within the decorator/context.</p>
</section>
<section id="statistics">
<h4>Statistics<a class="headerlink" href="#statistics" title="Permalink to this heading">#</a></h4>
<p>cuDF supports spilling statistics, which can be very useful for performance profiling and to identify code that renders buffers unspillable.</p>
<p>Three levels of information gathering exist:</p>
<ol class="arabic simple" start="0">
<li><p>disabled (no overhead).</p></li>
<li><p>gather statistics of duration and number of bytes spilled (very low overhead).</p></li>
<li><p>gather statistics of each time a spillable buffer is exposed permanently (potential high overhead).</p></li>
</ol>
<p>Statistics can be enabled in two ways (it is disabled by default):</p>
<ul class="simple">
<li><p>setting the environment variable <code class="docutils literal notranslate"><span class="pre">CUDF_SPILL_STATS=&lt;statistics-level&gt;</span></code>, or</p></li>
<li><p>setting the <code class="docutils literal notranslate"><span class="pre">spill_stats</span></code> option in <code class="docutils literal notranslate"><span class="pre">cudf</span></code> by doing <code class="docutils literal notranslate"><span class="pre">cudf.set_option("spill_stats",</span> <span class="pre">&lt;statistics-level&gt;)</span></code>.</p></li>
</ul>
<p>It is possible to access the statistics through the spill manager like:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">cudf</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">cudf.core.buffer.spill_manager</span> <span class="kn">import</span> <span class="n">get_global_manager</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">stats</span> <span class="o">=</span> <span class="n">get_global_manager</span><span class="p">()</span><span class="o">.</span><span class="n">statistics</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">stats</span><span class="p">)</span>
<span class="go">    Spill Statistics (level=1):</span>
<span class="go">     Spilling (level &gt;= 1):</span>
<span class="go">      gpu =&gt; cpu: 24B in 0.0033</span>
</pre></div>
</div>
<p>To have each worker in dask print spill statistics, do something like:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="nf">spill_info</span><span class="p">():</span>
        <span class="kn">from</span> <span class="nn">cudf.core.buffer.spill_manager</span> <span class="kn">import</span> <span class="n">get_global_manager</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">get_global_manager</span><span class="p">()</span><span class="o">.</span><span class="n">statistics</span><span class="p">)</span>
    <span class="n">client</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">spill_info</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
</section>
<section id="the-cython-layer">
<h2>The Cython layer<a class="headerlink" href="#the-cython-layer" title="Permalink to this heading">#</a></h2>
<p>The lowest level of cuDF is its interaction with <code class="docutils literal notranslate"><span class="pre">libcudf</span></code> via Cython.
The Cython layer is composed of two components: C++ bindings and Cython wrappers.
The first component consists of <a class="reference external" href="https://cython.readthedocs.io/en/latest/src/tutorial/pxd_files.html"><code class="docutils literal notranslate"><span class="pre">.pxd</span></code> files</a>,
Cython declaration files that expose the contents of C++ header files to other Cython files.
The second component consists of Cython wrappers for this functionality.
These wrappers are necessary to expose this functionality to pure Python code.
They also handle translating cuDF objects into their <code class="docutils literal notranslate"><span class="pre">libcudf</span></code> equivalents and invoking <code class="docutils literal notranslate"><span class="pre">libcudf</span></code> functions.</p>
<p>Working with this layer of cuDF requires some familiarity with <code class="docutils literal notranslate"><span class="pre">libcudf</span></code>&rsquo;s APIs.
<code class="docutils literal notranslate"><span class="pre">libcudf</span></code> is built around two principal objects whose names are largely self-explanatory: <code class="docutils literal notranslate"><span class="pre">column</span></code> and <code class="docutils literal notranslate"><span class="pre">table</span></code>.
<code class="docutils literal notranslate"><span class="pre">libcudf</span></code> also defines corresponding non-owning &ldquo;view&rdquo; types <code class="docutils literal notranslate"><span class="pre">column_view</span></code> and <code class="docutils literal notranslate"><span class="pre">table_view</span></code>.
<code class="docutils literal notranslate"><span class="pre">libcudf</span></code> APIs typically accept views and return owning types.</p>
<p>Most cuDF Cython wrappers involve converting <code class="docutils literal notranslate"><span class="pre">cudf.Column</span></code> objects into <code class="docutils literal notranslate"><span class="pre">column_view</span></code> or <code class="docutils literal notranslate"><span class="pre">table_view</span></code> objects,
calling a <code class="docutils literal notranslate"><span class="pre">libcudf</span></code> API with these arguments, then constructing new <code class="docutils literal notranslate"><span class="pre">cudf.Column</span></code>s from the result.
By the time code reaches this layer, all questions of pandas compatibility should already have been addressed.
These functions should be as close to trivial wrappers around <code class="docutils literal notranslate"><span class="pre">libcudf</span></code> APIs as possible.</p>
</section>
<section id="putting-it-all-together">
<h2>Putting It All Together<a class="headerlink" href="#putting-it-all-together" title="Permalink to this heading">#</a></h2>
<p>To this point, our discussion has assumed that all cuDF functions follow a strictly linear descent through these layers.
However, it should be clear that in many cases this approach is not appropriate.
Many common <code class="docutils literal notranslate"><span class="pre">Frame</span></code> operations do not operate on individual columns but on the <code class="docutils literal notranslate"><span class="pre">Frame</span></code> as a whole.
Therefore, we in fact have two distinct common patterns for implementations in cuDF.</p>
<ol class="arabic simple">
<li><p>The first pattern is for operations that act on columns of a <code class="docutils literal notranslate"><span class="pre">Frame</span></code> individually.
This group includes tasks like reductions and scans (<code class="docutils literal notranslate"><span class="pre">sum</span></code>/<code class="docutils literal notranslate"><span class="pre">cumsum</span></code>).
These operations are typically implemented by looping over the columns stored in a <code class="docutils literal notranslate"><span class="pre">Frame</span></code>&rsquo;s <code class="docutils literal notranslate"><span class="pre">ColumnAccessor</span></code>.</p></li>
<li><p>The second pattern is for operations that involve acting on multiple columns at once.
This group includes many core operations like grouping or merging.
These operations bypass the Column layer altogether, instead going straight from Frame to Cython.</p></li>
</ol>
<p>The pandas API also includes a number of helper objects, such as <code class="docutils literal notranslate"><span class="pre">GroupBy</span></code>, <code class="docutils literal notranslate"><span class="pre">Rolling</span></code>, and <code class="docutils literal notranslate"><span class="pre">Resampler</span></code>.
cuDF implements corresponding objects with the same APIs.
Internally, these objects typically interact with cuDF objects at the Frame layer via composition.
However, for performance reasons they frequently access internal attributes and methods of <code class="docutils literal notranslate"><span class="pre">Frame</span></code> and its subclasses.</p>
</section>
<section id="copy-on-write">
<span id="copy-on-write-dev-doc"></span><h2>Copy-on-write<a class="headerlink" href="#copy-on-write" title="Permalink to this heading">#</a></h2>
<p>This section describes the internal implementation details of the copy-on-write feature.
It is recommended that developers familiarize themselves with <a class="reference internal" href="../user_guide/copy-on-write.html#copy-on-write-user-doc"><span class="std std-ref">the user-facing documentation</span></a> of this functionality before reading through the internals
below.</p>
<p>The core copy-on-write implementation relies on the <code class="docutils literal notranslate"><span class="pre">CopyOnWriteBuffer</span></code> class.
When the cudf option <code class="docutils literal notranslate"><span class="pre">"copy_on_write"</span></code> is <code class="docutils literal notranslate"><span class="pre">True</span></code>, <code class="docutils literal notranslate"><span class="pre">as_buffer</span></code> will always return a <code class="docutils literal notranslate"><span class="pre">CopyOnWriteBuffer</span></code>.
This subclass of <code class="docutils literal notranslate"><span class="pre">cudf.Buffer</span></code> contains all the mechanisms to enable copy-on-write behavior.
The class stores <a class="reference external" href="https://docs.python.org/3/library/weakref.html">weak references</a> to every existing <code class="docutils literal notranslate"><span class="pre">CopyOnWriteBuffer</span></code> in <code class="docutils literal notranslate"><span class="pre">CopyOnWriteBuffer._instances</span></code>, a mapping from <code class="docutils literal notranslate"><span class="pre">ptr</span></code> keys to <code class="docutils literal notranslate"><span class="pre">WeakSet</span></code>s containing references to <code class="docutils literal notranslate"><span class="pre">CopyOnWriteBuffer</span></code> objects.
This means that all <code class="docutils literal notranslate"><span class="pre">CopyOnWriteBuffer</span></code>s that point to the same device memory are contained in the same <code class="docutils literal notranslate"><span class="pre">WeakSet</span></code> (corresponding to the same <code class="docutils literal notranslate"><span class="pre">ptr</span></code> key) in <code class="docutils literal notranslate"><span class="pre">CopyOnWriteBuffer._instances</span></code>.
This data structure is then used to determine whether or not to make a copy when a write operation is performed on a <code class="docutils literal notranslate"><span class="pre">Column</span></code> (see below).
If multiple buffers point to the same underlying memory, then a copy must be made whenever a modification is attempted.</p>
<section id="eager-copies-when-exposing-to-third-party-libraries">
<h3>Eager copies when exposing to third-party libraries<a class="headerlink" href="#eager-copies-when-exposing-to-third-party-libraries" title="Permalink to this heading">#</a></h3>
<p>If a <code class="docutils literal notranslate"><span class="pre">Column</span></code>/<code class="docutils literal notranslate"><span class="pre">CopyOnWriteBuffer</span></code> is exposed to a third-party library via <code class="docutils literal notranslate"><span class="pre">__cuda_array_interface__</span></code>, we are no longer able to track whether or not modification of the buffer has occurred. Hence whenever
someone accesses data through the <code class="docutils literal notranslate"><span class="pre">__cuda_array_interface__</span></code>, we eagerly trigger the copy by calling
<code class="docutils literal notranslate"><span class="pre">_unlink_shared_buffers</span></code> which ensures a true copy of underlying device data is made and
unlinks the buffer from any shared &ldquo;weak&rdquo; references. Any future copy requests must also trigger a true physical copy (since we cannot track the lifetime of the third-party object). To handle this we also mark the <code class="docutils literal notranslate"><span class="pre">Column</span></code>/<code class="docutils literal notranslate"><span class="pre">CopyOnWriteBuffer</span></code> as
<code class="docutils literal notranslate"><span class="pre">obj._zero_copied=True</span></code> thus indicating that any future shallow-copy requests will trigger a true physical copy
rather than a copy-on-write shallow copy with weak references.</p>
</section>
<section id="obtaining-a-read-only-object">
<h3>Obtaining a read-only object<a class="headerlink" href="#obtaining-a-read-only-object" title="Permalink to this heading">#</a></h3>
<p>A read-only object can be quite useful for operations that will not
mutate the data. This can be achieved by calling <code class="docutils literal notranslate"><span class="pre">._get_cuda_array_interface(readonly=True)</span></code>, and creating a <code class="docutils literal notranslate"><span class="pre">SimpleNameSpace</span></code> object around it.
This will not trigger a deep copy even if the <code class="docutils literal notranslate"><span class="pre">CopyOnWriteBuffer</span></code>
has weak references. This API should only be used when the lifetime of the proxy object is restricted to cudf&rsquo;s internal code execution. Handing this out to external libraries or user-facing APIs will lead to untracked references and undefined copy-on-write behavior. We currently use this API for device to host
copies like in <code class="docutils literal notranslate"><span class="pre">ColumnBase.data_array_view(mode="read")</span></code> which is used for <code class="docutils literal notranslate"><span class="pre">Column.values_host</span></code>.</p>
</section>
<section id="internal-access-to-raw-data-pointers">
<h3>Internal access to raw data pointers<a class="headerlink" href="#internal-access-to-raw-data-pointers" title="Permalink to this heading">#</a></h3>
<p>Since it is unsafe to access the raw pointer associated with a buffer when
copy-on-write is enabled, in addition to the readonly proxy object described above,
access to the pointer is gated through <code class="docutils literal notranslate"><span class="pre">Buffer.get_ptr</span></code>. This method accepts a mode
argument through which the caller indicates how they will access the data associated
with the buffer. If only read-only access is required (<code class="docutils literal notranslate"><span class="pre">mode="read"</span></code>), this indicates
that the caller has no intention of modifying the buffer through this pointer.
In this case, any shallow copies are not unlinked. In contrast, if modification is
required one may pass <code class="docutils literal notranslate"><span class="pre">mode="write"</span></code>, provoking unlinking of any shallow copies.</p>
</section>
<section id="variable-width-data-types">
<h3>Variable width data types<a class="headerlink" href="#variable-width-data-types" title="Permalink to this heading">#</a></h3>
<p>Weak references are implemented only for fixed-width data types as these are only column
types that can be mutated in place.
Requests for deep copies of variable width data types always return shallow copies of the Columns, because these
types don&rsquo;t support real in-place mutation of the data.
Internally, we mimic in-place mutations using <code class="docutils literal notranslate"><span class="pre">_mimic_inplace</span></code>, but the resulting data is always a deep copy of the underlying data.</p>
</section>
<section id="examples">
<h3>Examples<a class="headerlink" href="#examples" title="Permalink to this heading">#</a></h3>
<p>When copy-on-write is enabled, taking a shallow copy of a <code class="docutils literal notranslate"><span class="pre">Series</span></code> or a <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code> does not
eagerly create a copy of the data. Instead, it produces a view that will be lazily
copied when a write operation is performed on any of its copies.</p>
<p>Let&rsquo;s create a series:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">cudf</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cudf</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s2">"copy_on_write"</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s1</span> <span class="o">=</span> <span class="n">cudf</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
</pre></div>
</div>
<p>Make a copy of <code class="docutils literal notranslate"><span class="pre">s1</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">s2</span> <span class="o">=</span> <span class="n">s1</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<p>Make another copy, but of <code class="docutils literal notranslate"><span class="pre">s2</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">s3</span> <span class="o">=</span> <span class="n">s2</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<p>Viewing the data and memory addresses show that they all point to the same device memory:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">s1</span>
<span class="go">0    1</span>
<span class="go">1    2</span>
<span class="go">2    3</span>
<span class="go">3    4</span>
<span class="go">dtype: int64</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s2</span>
<span class="go">0    1</span>
<span class="go">1    2</span>
<span class="go">2    3</span>
<span class="go">3    4</span>
<span class="go">dtype: int64</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s3</span>
<span class="go">0    1</span>
<span class="go">1    2</span>
<span class="go">2    3</span>
<span class="go">3    4</span>
<span class="go">dtype: int64</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">s1</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">_ptr</span>
<span class="go">139796315897856</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s2</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">_ptr</span>
<span class="go">139796315897856</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s3</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">_ptr</span>
<span class="go">139796315897856</span>
</pre></div>
</div>
<p>Now, when we perform a write operation on one of them, say on <code class="docutils literal notranslate"><span class="pre">s2</span></code>, a new copy is created
for <code class="docutils literal notranslate"><span class="pre">s2</span></code> on device and then modified:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">s2</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s2</span>
<span class="go">0    10</span>
<span class="go">1    10</span>
<span class="go">2     3</span>
<span class="go">3     4</span>
<span class="go">dtype: int64</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s1</span>
<span class="go">0    1</span>
<span class="go">1    2</span>
<span class="go">2    3</span>
<span class="go">3    4</span>
<span class="go">dtype: int64</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s3</span>
<span class="go">0    1</span>
<span class="go">1    2</span>
<span class="go">2    3</span>
<span class="go">3    4</span>
<span class="go">dtype: int64</span>
</pre></div>
</div>
<p>If we inspect the memory address of the data, <code class="docutils literal notranslate"><span class="pre">s1</span></code> and <code class="docutils literal notranslate"><span class="pre">s3</span></code> still share the same address but <code class="docutils literal notranslate"><span class="pre">s2</span></code> has a new one:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">s1</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">_ptr</span>
<span class="go">139796315897856</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s3</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">_ptr</span>
<span class="go">139796315897856</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s2</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">_ptr</span>
<span class="go">139796315899392</span>
</pre></div>
</div>
<p>Now, performing write operation on <code class="docutils literal notranslate"><span class="pre">s1</span></code> will trigger a new copy on device memory as there
is a weak reference being shared in <code class="docutils literal notranslate"><span class="pre">s3</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">s1</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">11</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s1</span>
<span class="go">0    11</span>
<span class="go">1    11</span>
<span class="go">2     3</span>
<span class="go">3     4</span>
<span class="go">dtype: int64</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s2</span>
<span class="go">0    10</span>
<span class="go">1    10</span>
<span class="go">2     3</span>
<span class="go">3     4</span>
<span class="go">dtype: int64</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s3</span>
<span class="go">0    1</span>
<span class="go">1    2</span>
<span class="go">2    3</span>
<span class="go">3    4</span>
<span class="go">dtype: int64</span>
</pre></div>
</div>
<p>If we inspect the memory address of the data, the addresses of <code class="docutils literal notranslate"><span class="pre">s2</span></code> and <code class="docutils literal notranslate"><span class="pre">s3</span></code> remain unchanged, but <code class="docutils literal notranslate"><span class="pre">s1</span></code>&rsquo;s memory address has changed because of a copy operation performed during the writing:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">s2</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">_ptr</span>
<span class="go">139796315899392</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s3</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">_ptr</span>
<span class="go">139796315897856</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s1</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">_ptr</span>
<span class="go">139796315879723</span>
</pre></div>
</div>
<p>cuDF&rsquo;s copy-on-write implementation is motivated by the pandas proposals documented here:</p>
<ol class="arabic simple">
<li><p><a class="reference external" href="https://docs.google.com/document/d/1ZCQ9mx3LBMy-nhwRl33_jgcvWo9IWdEfxDNQ2thyTb0/edit#heading=h.iexejdstiz8u">Google doc</a></p></li>
<li><p><a class="reference external" href="https://github.com/pandas-dev/pandas/issues/36195">Github issue</a></p></li>
</ol>
</section>
</section>
</section>


                </article>
              
              
              
                <footer class="bd-footer-article">
                  <!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev" href="index.html" title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Developer Guide</p>
      </div>
    </a>
    <a class="right-next" href="contributing_guide.html" title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Contributing Guide</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-frame-layer">The Frame layer</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#frames">Frames</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#indexes">Indexes</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-column-layer">The Column layer</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#columnaccessor">ColumnAccessor</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#columns">Columns</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#data-types">Data types</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#buffer">Buffer</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#spilling-to-host-memory">Spilling to host memory</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#design">Design</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#statistics">Statistics</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-cython-layer">The Cython layer</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#putting-it-all-together">Putting It All Together</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#copy-on-write">Copy-on-write</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#eager-copies-when-exposing-to-third-party-libraries">Eager copies when exposing to third-party libraries</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#obtaining-a-read-only-object">Obtaining a read-only object</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#internal-access-to-raw-data-pointers">Internal access to raw data pointers</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#variable-width-data-types">Variable width data types</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#examples">Examples</a></li>
</ul>
</li>
</ul>
  </nav></div>

  <div class="sidebar-secondary-item">
  <div class="tocsection sourcelink">
    <a href="../_sources/developer_guide/library_design.md.txt">
      <i class="fa-solid fa-file-lines"></i> Show Source
    </a>
  </div>
</div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            <div class="bd-footer-content__inner"></div>
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=12da95d707ffb74b382d"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=12da95d707ffb74b382d"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">
  <p class="copyright">
    
      &copy; Copyright 2018-2023, NVIDIA Corporation.
      <br>
    
  </p>
</div>
      
        <div class="footer-item">
  <p class="sphinx-version">
    Created using <a href="https://sphinx-doc.org/">Sphinx</a> 5.3.0.
    <br>
  </p>
</div>
      
    </div>
  
  
    <div class="footer-items__end">
      
        <div class="footer-item"><p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.13.0.
</p></div>
      
    </div>
  
</div>

  </footer>
  
<script defer id="rapids-selector-js" src="/assets/js/custom.js"></script><script id="rapids-selector-pixel-invocation" type="text/javascript">_satellite.pageBottom();</script></body></html>