
<!DOCTYPE html>

<html class="writer-html5" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Overview of User Defined Functions with cuDF — cudf 0.15.0 documentation</title>
<link href="_static/css/theme.css" rel="stylesheet" type="text/css"/>
<link href="_static/pygments.css" rel="stylesheet" type="text/css"/>
<link href="_static/copybutton.css" rel="stylesheet" type="text/css"/>
<link href="_static/params.css" rel="stylesheet" type="text/css"/>
<link href="https://docs.rapids.ai/assets/css/custom.css" rel="stylesheet" type="text/css"/>
<!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
<script data-url_root="./" id="documentation_options" src="_static/documentation_options.js" type="text/javascript"></script>
<script src="_static/jquery.js"></script>
<script src="_static/underscore.js"></script>
<script src="_static/doctools.js"></script>
<script src="_static/language_data.js"></script>
<script src="_static/clipboard.min.js"></script>
<script src="_static/copybutton.js"></script>
<script src="_static/copybutton_pydocs.js"></script>
<script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
<script src="_static/js/theme.js" type="text/javascript"></script>
<link href="genindex.html" rel="index" title="Index"/>
<link href="search.html" rel="search" title="Search"/>
<link href="internals.html" rel="next" title="cuDF internals"/>
<link href="10min-cudf-cupy.html" rel="prev" title="10 Minutes to cuDF and CuPy"/>
<link href="/assets/css/custom.css" id="rapids-selector-css" rel="stylesheet"/></head>
<body class="wy-body-for-nav">
<div class="wy-grid-for-nav">
<nav class="wy-nav-side" data-toggle="wy-nav-shift">
<div class="wy-side-scroll">
<div class="wy-side-nav-search"><div id="rapids-sphinx-container"><div class="rapids-home-container"><a class="rapids-home-container__home-btn" href="/api">Home</a></div><div class="rapids-selector__container rapids-selector--hidden"><div class="rapids-selector__selected">cudf</div><div class="rapids-selector__menu"><a class="rapids-selector__menu-item" href="/api/clx/stable/api.html">clx</a><a class="rapids-selector__menu-item" href="/api/cudf-java/legacy">cudf-java</a><a class="rapids-selector__menu-item rapids-selector__menu-item--selected" href="/api/cudf/stable/api.html">cudf</a><a class="rapids-selector__menu-item" href="/api/cugraph/stable/api.html">cugraph</a><a class="rapids-selector__menu-item" href="/api/cuml/stable/api.html">cuml</a><a class="rapids-selector__menu-item" href="/api/cusignal/stable/api.html">cusignal</a><a class="rapids-selector__menu-item" href="/api/cuspatial/stable/api.html">cuspatial</a><a class="rapids-selector__menu-item" href="/api/cuxfilter/stable">cuxfilter</a><a class="rapids-selector__menu-item" href="/api/libcudf/stable/namespacecudf.html">libcudf</a><a class="rapids-selector__menu-item" href="/api/libcugraph/stable">libcugraph</a><a class="rapids-selector__menu-item" href="/api/libcuml/stable">libcuml</a><a class="rapids-selector__menu-item" href="/api/rmm/stable/annotated.html">rmm</a></div></div><div class="rapids-selector__container rapids-selector--hidden"><div class="rapids-selector__selected">nightly (0.17)</div><div class="rapids-selector__menu"><a class="rapids-selector__menu-item rapids-selector__menu-item--selected" href="/api/cudf/nightly/api.html">nightly (0.17)</a><a class="rapids-selector__menu-item" href="/api/cudf/stable/api.html">stable (0.16)</a><a class="rapids-selector__menu-item" href="/api/cudf/legacy/api.html">legacy (0.15)</a></div></div></div>
<div role="search">
<form action="search.html" class="wy-form" id="rtd-search-form" method="get">
<input name="q" placeholder="Search docs" type="text"/>
<input name="check_keywords" type="hidden" value="yes"/>
<input name="area" type="hidden" value="default"/>
</form>
</div>
</div>
<div aria-label="main navigation" class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation">
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="api.html">cuDF API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="10min.html">10 Minutes to cuDF and Dask-cuDF</a></li>
<li class="toctree-l1"><a class="reference internal" href="basics.html">Basics</a></li>
<li class="toctree-l1"><a class="reference internal" href="dask-cudf.html">Multi-GPU with Dask-cuDF</a></li>
<li class="toctree-l1"><a class="reference internal" href="10min-cudf-cupy.html">10 Minutes to cuDF and CuPy</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Overview of User Defined Functions with cuDF</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#Overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Series-UDFs">Series UDFs</a></li>
<li class="toctree-l2"><a class="reference internal" href="#DataFrame-UDFs">DataFrame UDFs</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Rolling-Window-UDFs">Rolling Window UDFs</a></li>
<li class="toctree-l2"><a class="reference internal" href="#GroupBy-DataFrame-UDFs">GroupBy DataFrame UDFs</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Numba-Kernels-on-CuPy-Arrays">Numba Kernels on CuPy Arrays</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Null-Handling-in-UDFs">Null Handling in UDFs</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Operating-on-Null-Values">Operating on Null Values</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Standard-Numba-Kernels">Standard Numba Kernels</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#Summary">Summary</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="internals.html">cuDF internals</a></li>
</ul>
</div>
</div>
</nav>
<section class="wy-nav-content-wrap" data-toggle="wy-nav-shift">
<nav aria-label="top navigation" class="wy-nav-top">
<i class="fa fa-bars" data-toggle="wy-nav-top"></i>
<a href="index.html">cudf</a>
</nav>
<div class="wy-nav-content">
<div class="rst-content">
<div aria-label="breadcrumbs navigation" role="navigation">
<ul class="wy-breadcrumbs">
<li><a class="icon icon-home" href="index.html"></a> »</li>
<li>Overview of User Defined Functions with cuDF</li>
<li class="wy-breadcrumbs-aside">
<a href="_sources/guide-to-udfs.ipynb.txt" rel="nofollow"> View page source</a>
</li>
</ul>
<hr/>
</div>
<div class="document" itemscope="itemscope" itemtype="http://schema.org/Article" role="main">
<div itemprop="articleBody">
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container,
div.nbinput.container div.prompt,
div.nbinput.container div.input_area,
div.nbinput.container div[class*=highlight],
div.nbinput.container div[class*=highlight] pre,
div.nboutput.container,
div.nboutput.container div.prompt,
div.nboutput.container div.output_area,
div.nboutput.container div[class*=highlight],
div.nboutput.container div[class*=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    background: #f5f5f5;
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt a.copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="Overview-of-User-Defined-Functions-with-cuDF">
<h1>Overview of User Defined Functions with cuDF<a class="headerlink" href="#Overview-of-User-Defined-Functions-with-cuDF" title="Permalink to this headline">¶</a></h1>
<p>Like many tabular data processing APIs, cuDF provides a range of composable, DataFrame style operators. While out of the box functions are flexible and useful, it is sometimes necessary to write custom code, or user-defined functions (UDFs), that can be applied to rows, columns, and other groupings of the cells making up the DataFrame.</p>
<p>In conjunction with the broader GPU PyData ecosystem, cuDF provides interfaces to run UDFs on a variety of data structures. Currently, we can only execute UDFs on numeric and Boolean typed data (support for strings is being planned). This guide covers writing and executing UDFs on the following data structures:</p>
<ul class="simple">
<li><p>Series</p></li>
<li><p>DataFrame</p></li>
<li><p>Rolling Windows Series</p></li>
<li><p>Groupby DataFrames</p></li>
<li><p>CuPy NDArrays</p></li>
<li><p>Numba DeviceNDArrays</p></li>
</ul>
<p>It also demonstrates cuDF’s default null handling behavior, and how to write UDFs that can interact with null values in a limited fashion.</p>
<div class="section" id="Overview">
<h2>Overview<a class="headerlink" href="#Overview" title="Permalink to this headline">¶</a></h2>
<p>When cuDF executes a UDF, it gets just-in-time (JIT) compiled into a CUDA kernel (either explicitly or implicitly) and is run on the GPU. Exploring CUDA and GPU architecture in-depth is out of scope for this guide. At a high level:</p>
<ul class="simple">
<li><p>Compute is spread across multiple “blocks”, which have access to both global memory and their own block local memory</p></li>
<li><p>Within each block, many “threads” operate independently and simultaneously access their block-specific shared memory with low latency</p></li>
</ul>
<p>This guide covers APIs that automatically handle dividing columns into chunks and assigning them into different GPU blocks for parallel computation (see <a class="reference external" href="https://docs.rapids.ai/api/cudf/stable/api.html#cudf.core.dataframe.DataFrame.apply_chunks">apply_chunks</a> or the <a class="reference external" href="https://numba.pydata.org/numba-doc/dev/cuda/index.html">numba CUDA JIT API</a> if you need to control this yourself).</p>
</div>
<div class="section" id="Series-UDFs">
<h2>Series UDFs<a class="headerlink" href="#Series-UDFs" title="Permalink to this headline">¶</a></h2>
<p>You can execute UDFs on Series in two ways:</p>
<ul class="simple">
<li><p>Writing a standard Python function and using <code class="docutils literal notranslate"><span class="pre">applymap</span></code></p></li>
<li><p>Writing a Numba kernel and using Numba’s <code class="docutils literal notranslate"><span class="pre">forall</span></code> syntax</p></li>
</ul>
<p>Using <code class="docutils literal notranslate"><span class="pre">applymap</span></code> is simpler, but writing a Numba kernel offers the flexibility to build more complex functions (we’ll be writing only simple kernels in this guide).</p>
<p>Let’s start by importing a few libraries and creating a DataFrame of several Series.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">cudf</span>
<span class="kn">from</span> <span class="nn">cudf.datasets</span> <span class="kn">import</span> <span class="n">randomdata</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">randomdata</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">dtypes</span><span class="o">=</span><span class="p">{</span><span class="s1">'a'</span><span class="p">:</span><span class="nb">float</span><span class="p">,</span> <span class="s1">'b'</span><span class="p">:</span><span class="nb">bool</span><span class="p">,</span> <span class="s1">'c'</span><span class="p">:</span><span class="nb">str</span><span class="p">},</span> <span class="n">seed</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th></th>
<th>a</th>
<th>b</th>
<th>c</th>
</tr>
</thead>
<tbody>
<tr>
<th>0</th>
<td>-0.691674</td>
<td>True</td>
<td>Dan</td>
</tr>
<tr>
<th>1</th>
<td>0.480099</td>
<td>False</td>
<td>Bob</td>
</tr>
<tr>
<th>2</th>
<td>-0.473370</td>
<td>True</td>
<td>Xavier</td>
</tr>
<tr>
<th>3</th>
<td>0.067479</td>
<td>True</td>
<td>Alice</td>
</tr>
<tr>
<th>4</th>
<td>-0.970850</td>
<td>False</td>
<td>Sarah</td>
</tr>
</tbody>
</table>
</div></div>
</div>
<p>Next, we’ll define a basic Python function and call it as a UDF with <code class="docutils literal notranslate"><span class="pre">applymap</span></code>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">udf</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">5</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">x</span> <span class="o">-</span> <span class="mi">5</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">df</span><span class="p">[</span><span class="s1">'a'</span><span class="p">]</span><span class="o">.</span><span class="n">applymap</span><span class="p">(</span><span class="n">udf</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
0   -5.691674
1    5.480099
2   -5.473370
3    5.067479
4   -5.970850
5    5.837494
6    5.801430
7   -5.933157
8    5.913899
9   -5.725581
Name: a, dtype: float64
</pre></div></div>
</div>
<p>That’s all there is to it. For more complex UDFs, though, we’d want to write an actual Numba kernel.</p>
<p>For more complex logic (for instance, accessing values from multiple input columns or rows, you’ll need to use a more complex API. There are several types. First we’ll cover writing and running a Numba JITed CUDA kernel.</p>
<p>The easiest way to write a Numba kernel is to use <code class="docutils literal notranslate"><span class="pre">cuda.grid(1)</span></code> to manage our thread indices, and then leverage Numba’s <code class="docutils literal notranslate"><span class="pre">forall</span></code> method to configure the kernel for us. Below, define a basic multiplication kernel as an example and use <code class="docutils literal notranslate"><span class="pre">@cuda.jit</span></code> to compile it.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">numba</span> <span class="kn">import</span> <span class="n">cuda</span>

<span class="nd">@cuda</span><span class="o">.</span><span class="n">jit</span>
<span class="k">def</span> <span class="nf">multiply</span><span class="p">(</span><span class="n">in_col</span><span class="p">,</span> <span class="n">out_col</span><span class="p">,</span> <span class="n">multiplier</span><span class="p">):</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">in_col</span><span class="o">.</span><span class="n">size</span><span class="p">:</span> <span class="c1"># boundary guard</span>
        <span class="n">out_col</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">in_col</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">multiplier</span>
</pre></div>
</div>
</div>
<p>This kernel will take an input array, multiply it by a configurable value (supplied at runtime), and store the result in an output array. Notice that we wrapped our logic in an <code class="docutils literal notranslate"><span class="pre">if</span></code> statement. Because we can launch more threads than the size of our array, we need to make sure that we don’t use threads with an index that would be out of bounds. Leaving this out can result in undefined behavior.</p>
<p>To execute our kernel, we just need to pre-allocate an output array and leverage the <code class="docutils literal notranslate"><span class="pre">forall</span></code> method mentioned above. First, we create a Series of all <code class="docutils literal notranslate"><span class="pre">0.0</span></code> in our DataFrame, since we want <code class="docutils literal notranslate"><span class="pre">float64</span></code> output. Next, we run the kernel with <code class="docutils literal notranslate"><span class="pre">forall</span></code>. <code class="docutils literal notranslate"><span class="pre">forall</span></code> requires us to specify our desired number of tasks, so we’ll supply in the length of our Series (which we store in <code class="docutils literal notranslate"><span class="pre">size</span></code>). The <a class="reference external" href="https://numba.pydata.org/numba-doc/dev/cuda/cuda_array_interface.html">**cuda_array_interface**</a> is
what allows us to directly call our Numba kernel on our Series.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">'a'</span><span class="p">])</span>
<span class="n">df</span><span class="p">[</span><span class="s1">'e'</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">multiply</span><span class="o">.</span><span class="n">forall</span><span class="p">(</span><span class="n">size</span><span class="p">)(</span><span class="n">df</span><span class="p">[</span><span class="s1">'a'</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">'e'</span><span class="p">],</span> <span class="mf">10.0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>After calling our kernel, our DataFrame is now populated with the result.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th></th>
<th>a</th>
<th>b</th>
<th>c</th>
<th>e</th>
</tr>
</thead>
<tbody>
<tr>
<th>0</th>
<td>-0.691674</td>
<td>True</td>
<td>Dan</td>
<td>-6.916743</td>
</tr>
<tr>
<th>1</th>
<td>0.480099</td>
<td>False</td>
<td>Bob</td>
<td>4.800994</td>
</tr>
<tr>
<th>2</th>
<td>-0.473370</td>
<td>True</td>
<td>Xavier</td>
<td>-4.733700</td>
</tr>
<tr>
<th>3</th>
<td>0.067479</td>
<td>True</td>
<td>Alice</td>
<td>0.674788</td>
</tr>
<tr>
<th>4</th>
<td>-0.970850</td>
<td>False</td>
<td>Sarah</td>
<td>-9.708501</td>
</tr>
</tbody>
</table>
</div></div>
</div>
<p>Note that, while we’re operating on the Series <code class="docutils literal notranslate"><span class="pre">df['e']</span></code>, the kernel executes on the <a class="reference external" href="https://numba.pydata.org/numba-doc/dev/cuda/memory.html#device-arrays">DeviceNDArray</a> “underneath” the Series. If you ever need to access the underlying DeviceNDArray of a Series, you can do so with <code class="docutils literal notranslate"><span class="pre">Series.data.mem</span></code>. We’ll use this during an example in the Null Handling section of this guide.</p>
</div>
<div class="section" id="DataFrame-UDFs">
<h2>DataFrame UDFs<a class="headerlink" href="#DataFrame-UDFs" title="Permalink to this headline">¶</a></h2>
<p>We could apply a UDF on a DataFrame like we did above with <code class="docutils literal notranslate"><span class="pre">forall</span></code>. We’d need to write a kernel that expects multiple inputs, and pass multiple Series as arguments when we execute our kernel. Because this is fairly common and can be difficult to manage, cuDF provides two APIs to streamline this: <code class="docutils literal notranslate"><span class="pre">apply_rows</span></code> and <code class="docutils literal notranslate"><span class="pre">apply_chunks</span></code>. Below, we walk through an example of using <code class="docutils literal notranslate"><span class="pre">apply_rows</span></code>. <code class="docutils literal notranslate"><span class="pre">apply_chunks</span></code> works in a similar way, but also offers more control over low-level kernel behavior.</p>
<p>Now that we have two numeric columns in our DataFrame, let’s write a kernel that uses both of them.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">conditional_add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">out</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">a</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="n">e</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span>
</pre></div>
</div>
</div>
<p>Notice that we need to <code class="docutils literal notranslate"><span class="pre">enumerate</span></code> through our <code class="docutils literal notranslate"><span class="pre">zipped</span></code> function arguments (which either match or are mapped to our input column names). We can pass this kernel to <code class="docutils literal notranslate"><span class="pre">apply_rows</span></code>. We’ll need to specify a few arguments: - incols - A list of names of input columns that match the function arguments. Or, a dictionary mapping input column names to their corresponding function arguments such as <code class="docutils literal notranslate"><span class="pre">{'col1':</span> <span class="pre">'arg1'}</span></code>. - outcols - A dictionary defining our output column names and their data types.
These names must match our function arguments. - kwargs (optional) - We can optionally pass keyword arguments as a dictionary. Since we don’t need any, we pass an empty one.</p>
<p>While it looks like our function is looping sequentially through our columns, it actually executes in parallel in multiple threads on the GPU. This parallelism is the heart of GPU-accelerated computing. With that background, we’re ready to use our UDF.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply_rows</span><span class="p">(</span><span class="n">conditional_add</span><span class="p">,</span>
                   <span class="n">incols</span><span class="o">=</span><span class="p">{</span><span class="s1">'a'</span><span class="p">:</span><span class="s1">'x'</span><span class="p">,</span> <span class="s1">'e'</span><span class="p">:</span><span class="s1">'y'</span><span class="p">},</span>
                   <span class="n">outcols</span><span class="o">=</span><span class="p">{</span><span class="s1">'out'</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">},</span>
                   <span class="n">kwargs</span><span class="o">=</span><span class="p">{}</span>
                  <span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th></th>
<th>a</th>
<th>b</th>
<th>c</th>
<th>e</th>
<th>out</th>
</tr>
</thead>
<tbody>
<tr>
<th>0</th>
<td>-0.691674</td>
<td>True</td>
<td>Dan</td>
<td>-6.916743</td>
<td>-0.691674</td>
</tr>
<tr>
<th>1</th>
<td>0.480099</td>
<td>False</td>
<td>Bob</td>
<td>4.800994</td>
<td>5.281093</td>
</tr>
<tr>
<th>2</th>
<td>-0.473370</td>
<td>True</td>
<td>Xavier</td>
<td>-4.733700</td>
<td>-0.473370</td>
</tr>
<tr>
<th>3</th>
<td>0.067479</td>
<td>True</td>
<td>Alice</td>
<td>0.674788</td>
<td>0.742267</td>
</tr>
<tr>
<th>4</th>
<td>-0.970850</td>
<td>False</td>
<td>Sarah</td>
<td>-9.708501</td>
<td>-0.970850</td>
</tr>
</tbody>
</table>
</div></div>
</div>
<p>As expected, we see our conditional addition worked. At this point, we’ve successfully executed UDFs on the core data structures of cuDF.</p>
</div>
<div class="section" id="Rolling-Window-UDFs">
<h2>Rolling Window UDFs<a class="headerlink" href="#Rolling-Window-UDFs" title="Permalink to this headline">¶</a></h2>
<p>For time-series data, we may need to operate on a small “window” of our column at a time, processing each portion independently. We could slide (“roll”) this window over the entire column to answer questions like “What is the 3-day moving average of a stock price over the past year?”</p>
<p>We can apply more complex functions to rolling windows to <code class="docutils literal notranslate"><span class="pre">rolling</span></code> Series and DataFrames using <code class="docutils literal notranslate"><span class="pre">apply</span></code>. This example is adapted from cuDF’s <a class="reference external" href="https://docs.rapids.ai/api/cudf/stable/api.html#cudf.core.dataframe.DataFrame.rolling">API documentation</a>. First, we’ll create an example Series and then create a <code class="docutils literal notranslate"><span class="pre">rolling</span></code> object from the Series.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">ser</span> <span class="o">=</span> <span class="n">cudf</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="mi">16</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">81</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">'float64'</span><span class="p">)</span>
<span class="n">ser</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
0    16.0
1    25.0
2    36.0
3    49.0
4    64.0
5    81.0
dtype: float64
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">rolling</span> <span class="o">=</span> <span class="n">ser</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">rolling</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Rolling [window=3,min_periods=3,center=False]
</pre></div></div>
</div>
<p>Next, we’ll define a function to use on our rolling windows. We created this one to highlight how you can include things like loops, mathematical functions, and conditionals. Rolling window UDFs do not yet support null values.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">math</span>

<span class="k">def</span> <span class="nf">example_func</span><span class="p">(</span><span class="n">window</span><span class="p">):</span>
    <span class="n">b</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">window</span><span class="p">:</span>
        <span class="n">b</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">b</span> <span class="o">==</span> <span class="mi">8</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">100</span>
    <span class="k">return</span> <span class="n">b</span>
</pre></div>
</div>
</div>
<p>We can execute the function by passing it to <code class="docutils literal notranslate"><span class="pre">apply</span></code>. With <code class="docutils literal notranslate"><span class="pre">window=3</span></code>, <code class="docutils literal notranslate"><span class="pre">min_periods=3</span></code>, and <code class="docutils literal notranslate"><span class="pre">center=False</span></code>, our first two values are <code class="docutils literal notranslate"><span class="pre">null</span></code>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">rolling</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">example_func</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
0     null
1     null
2      6.0
3      7.0
4    100.0
5      9.0
dtype: float64
</pre></div></div>
</div>
<p>We can apply this function to every column in a DataFrame, too.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">df2</span> <span class="o">=</span> <span class="n">cudf</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
<span class="n">df2</span><span class="p">[</span><span class="s1">'a'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">55</span><span class="p">,</span> <span class="mi">65</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">'float64'</span><span class="p">)</span>
<span class="n">df2</span><span class="p">[</span><span class="s1">'b'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">55</span><span class="p">,</span> <span class="mi">65</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">'float64'</span><span class="p">)</span>
<span class="n">df2</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th></th>
<th>a</th>
<th>b</th>
</tr>
</thead>
<tbody>
<tr>
<th>0</th>
<td>55.0</td>
<td>55.0</td>
</tr>
<tr>
<th>1</th>
<td>56.0</td>
<td>56.0</td>
</tr>
<tr>
<th>2</th>
<td>57.0</td>
<td>57.0</td>
</tr>
<tr>
<th>3</th>
<td>58.0</td>
<td>58.0</td>
</tr>
<tr>
<th>4</th>
<td>59.0</td>
<td>59.0</td>
</tr>
</tbody>
</table>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">rolling</span> <span class="o">=</span> <span class="n">df2</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">rolling</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">example_func</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th></th>
<th>a</th>
<th>b</th>
</tr>
</thead>
<tbody>
<tr>
<th>0</th>
<td>null</td>
<td>null</td>
</tr>
<tr>
<th>1</th>
<td>null</td>
<td>null</td>
</tr>
<tr>
<th>2</th>
<td>7.549834435</td>
<td>7.549834435</td>
</tr>
<tr>
<th>3</th>
<td>7.615773106</td>
<td>7.615773106</td>
</tr>
<tr>
<th>4</th>
<td>7.681145748</td>
<td>7.681145748</td>
</tr>
<tr>
<th>5</th>
<td>7.745966692</td>
<td>7.745966692</td>
</tr>
<tr>
<th>6</th>
<td>7.810249676</td>
<td>7.810249676</td>
</tr>
<tr>
<th>7</th>
<td>7.874007874</td>
<td>7.874007874</td>
</tr>
<tr>
<th>8</th>
<td>7.937253933</td>
<td>7.937253933</td>
</tr>
<tr>
<th>9</th>
<td>100.0</td>
<td>100.0</td>
</tr>
</tbody>
</table>
</div></div>
</div>
</div>
<div class="section" id="GroupBy-DataFrame-UDFs">
<h2>GroupBy DataFrame UDFs<a class="headerlink" href="#GroupBy-DataFrame-UDFs" title="Permalink to this headline">¶</a></h2>
<p>We can also apply UDFs to grouped DataFrames using <code class="docutils literal notranslate"><span class="pre">apply_grouped</span></code>. This example is also drawn and adapted from the RAPIDS <a class="reference external" href="https://docs.rapids.ai/api/cudf/stable/api.html#cudf.core.groupby.groupby.GroupBy.apply_grouped">API documentation</a>.</p>
<p>First, we’ll group our DataFrame based on column <code class="docutils literal notranslate"><span class="pre">b</span></code>, which is either True or False. Note that we currently need to pass <code class="docutils literal notranslate"><span class="pre">method="cudf"</span></code> to use UDFs with GroupBy objects.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th></th>
<th>a</th>
<th>b</th>
<th>c</th>
<th>e</th>
<th>out</th>
</tr>
</thead>
<tbody>
<tr>
<th>0</th>
<td>-0.691674</td>
<td>True</td>
<td>Dan</td>
<td>-6.916743</td>
<td>-0.691674</td>
</tr>
<tr>
<th>1</th>
<td>0.480099</td>
<td>False</td>
<td>Bob</td>
<td>4.800994</td>
<td>5.281093</td>
</tr>
<tr>
<th>2</th>
<td>-0.473370</td>
<td>True</td>
<td>Xavier</td>
<td>-4.733700</td>
<td>-0.473370</td>
</tr>
<tr>
<th>3</th>
<td>0.067479</td>
<td>True</td>
<td>Alice</td>
<td>0.674788</td>
<td>0.742267</td>
</tr>
<tr>
<th>4</th>
<td>-0.970850</td>
<td>False</td>
<td>Sarah</td>
<td>-9.708501</td>
<td>-0.970850</td>
</tr>
</tbody>
</table>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">grouped</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">'b'</span><span class="p">],</span> <span class="n">method</span><span class="o">=</span><span class="s2">"cudf"</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/opt/conda/envs/rapids/lib/python3.7/site-packages/cudf/core/dataframe.py:2559: UserWarning: as_index==True not supported due to the lack of multi-index with legacy groupby function. Use hash method for multi-index
  "as_index==True not supported due to the lack of "
</pre></div></div>
</div>
<p>Next we’ll define a function to apply to each group independently. In this case, we’ll take the rolling average of column <code class="docutils literal notranslate"><span class="pre">e</span></code>, and call that new column <code class="docutils literal notranslate"><span class="pre">rolling_avg_e</span></code>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">rolling_avg</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">rolling_avg_e</span><span class="p">):</span>
    <span class="n">win_size</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cuda</span><span class="o">.</span><span class="n">threadIdx</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">cuda</span><span class="o">.</span><span class="n">blockDim</span><span class="o">.</span><span class="n">x</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">win_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># If there is not enough data to fill the window,</span>
            <span class="c1"># take the average to be NaN</span>
            <span class="n">rolling_avg_e</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="n">win_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">total</span> <span class="o">+=</span> <span class="n">e</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="n">rolling_avg_e</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">total</span> <span class="o">/</span> <span class="n">win_size</span>
</pre></div>
</div>
</div>
<p>We can execute this with a very similar API to <code class="docutils literal notranslate"><span class="pre">apply_rows</span></code>. This time, though, it’s going to execute independently for each group.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">results</span> <span class="o">=</span> <span class="n">grouped</span><span class="o">.</span><span class="n">apply_grouped</span><span class="p">(</span><span class="n">rolling_avg</span><span class="p">,</span>
                               <span class="n">incols</span><span class="o">=</span><span class="p">[</span><span class="s1">'e'</span><span class="p">],</span>
                               <span class="n">outcols</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">rolling_avg_e</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">))</span>
<span class="n">results</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th></th>
<th>a</th>
<th>b</th>
<th>c</th>
<th>e</th>
<th>out</th>
<th>rolling_avg_e</th>
</tr>
</thead>
<tbody>
<tr>
<th>0</th>
<td>0.480099</td>
<td>False</td>
<td>Bob</td>
<td>4.800994</td>
<td>5.281093</td>
<td>NaN</td>
</tr>
<tr>
<th>1</th>
<td>-0.970850</td>
<td>False</td>
<td>Sarah</td>
<td>-9.708501</td>
<td>-0.970850</td>
<td>NaN</td>
</tr>
<tr>
<th>2</th>
<td>0.801430</td>
<td>False</td>
<td>Sarah</td>
<td>8.014297</td>
<td>8.815727</td>
<td>1.035597</td>
</tr>
<tr>
<th>3</th>
<td>-0.933157</td>
<td>False</td>
<td>Quinn</td>
<td>-9.331571</td>
<td>-0.933157</td>
<td>-3.675258</td>
</tr>
<tr>
<th>4</th>
<td>-0.691674</td>
<td>True</td>
<td>Dan</td>
<td>-6.916743</td>
<td>-0.691674</td>
<td>NaN</td>
</tr>
<tr>
<th>5</th>
<td>-0.473370</td>
<td>True</td>
<td>Xavier</td>
<td>-4.733700</td>
<td>-0.473370</td>
<td>NaN</td>
</tr>
<tr>
<th>6</th>
<td>0.067479</td>
<td>True</td>
<td>Alice</td>
<td>0.674788</td>
<td>0.742267</td>
<td>-3.658552</td>
</tr>
<tr>
<th>7</th>
<td>0.837494</td>
<td>True</td>
<td>Wendy</td>
<td>8.374940</td>
<td>9.212434</td>
<td>1.438676</td>
</tr>
<tr>
<th>8</th>
<td>0.913899</td>
<td>True</td>
<td>Ursula</td>
<td>9.138987</td>
<td>10.052885</td>
<td>6.062905</td>
</tr>
<tr>
<th>9</th>
<td>-0.725581</td>
<td>True</td>
<td>George</td>
<td>-7.255814</td>
<td>-0.725581</td>
<td>3.419371</td>
</tr>
</tbody>
</table>
</div></div>
</div>
<p>Notice how, with a window size of three in the kernel, the first two values in each group for our output column are null.</p>
</div>
<div class="section" id="Numba-Kernels-on-CuPy-Arrays">
<h2>Numba Kernels on CuPy Arrays<a class="headerlink" href="#Numba-Kernels-on-CuPy-Arrays" title="Permalink to this headline">¶</a></h2>
<p>We can also execute Numba kernels on CuPy NDArrays, again thanks to the <code class="docutils literal notranslate"><span class="pre">__cuda_array_interface__</span></code>. We can even run the same UDF on the Series and the CuPy array. First, we define a Series and then create a CuPy array from that Series.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">cupy</span> <span class="k">as</span> <span class="nn">cp</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">cudf</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">10</span><span class="p">])</span>
<span class="n">arr</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<span class="n">arr</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
array([ 1.,  2.,  3.,  4., 10.])
</pre></div></div>
</div>
<p>Next, we define a UDF and execute it on our Series. We need to allocate a Series of the same size for our output, which we’ll call <code class="docutils literal notranslate"><span class="pre">out</span></code>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">cudf.utils</span> <span class="kn">import</span> <span class="n">cudautils</span>

<span class="nd">@cuda</span><span class="o">.</span><span class="n">jit</span>
<span class="k">def</span> <span class="nf">multiply_by_5</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">out</span><span class="p">):</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
        <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mi">5</span>

<span class="n">out</span> <span class="o">=</span> <span class="n">cudf</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">cudautils</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">'int32'</span><span class="p">))</span>
<span class="n">multiply_by_5</span><span class="o">.</span><span class="n">forall</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])(</span><span class="n">s</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>
<span class="n">out</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
0     5
1    10
2    15
3    20
4    50
dtype: int32
</pre></div></div>
</div>
<p>Finally, we execute the same function on our array. We allocate an empty array <code class="docutils literal notranslate"><span class="pre">out</span></code> to store our results.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">out</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
<span class="n">multiply_by_5</span><span class="o">.</span><span class="n">forall</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">size</span><span class="p">)(</span><span class="n">arr</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>
<span class="n">out</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
array([ 5., 10., 15., 20., 50.])
</pre></div></div>
</div>
</div>
<div class="section" id="Null-Handling-in-UDFs">
<h2>Null Handling in UDFs<a class="headerlink" href="#Null-Handling-in-UDFs" title="Permalink to this headline">¶</a></h2>
<p>Above, we covered most basic usage of UDFs with cuDF.</p>
<p>The remainder of the guide focuses on considerations for executing UDFs on DataFrames containing null values. If your UDFs will read or write any column containing nulls, <strong>you should read this section carefully</strong>.</p>
<p>Writing UDFs that can handle null values is complicated by the fact that a separate bitmask is used to identify when a value is valid and when it’s null. By default, DataFrame methods for applying UDFs like <code class="docutils literal notranslate"><span class="pre">apply_rows</span></code> will handle nulls pessimistically (all rows with a null value will be removed from the output if they are used in the kernel). Exploring how not handling not pessimistically can lead to undefined behavior is outside the scope of this guide. Suffice it to say, pessimistic null
handling is the safe and consistent approach. You can see an example below.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">gpu_add</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">out</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)):</span>
        <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">randomdata</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">dtypes</span><span class="o">=</span><span class="p">{</span><span class="s1">'a'</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span> <span class="s1">'b'</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span> <span class="s1">'c'</span><span class="p">:</span><span class="nb">int</span><span class="p">},</span> <span class="n">seed</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="s1">'a'</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="s1">'b'</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="s1">'c'</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th></th>
<th>a</th>
<th>b</th>
<th>c</th>
</tr>
</thead>
<tbody>
<tr>
<th>0</th>
<td>963</td>
<td>1005</td>
<td>997</td>
</tr>
<tr>
<th>1</th>
<td>977</td>
<td>1026</td>
<td>null</td>
</tr>
<tr>
<th>2</th>
<td>null</td>
<td>1026</td>
<td>1019</td>
</tr>
<tr>
<th>3</th>
<td>1078</td>
<td>null</td>
<td>985</td>
</tr>
<tr>
<th>4</th>
<td>979</td>
<td>982</td>
<td>1011</td>
</tr>
</tbody>
</table>
</div></div>
</div>
<p>In the dataframe above, there are three null values. Each column has a null in a different row. When we use our UDF with <code class="docutils literal notranslate"><span class="pre">apply_rows</span></code>, our output should have two nulls due to pessimistic null handling (because we’re not using column <code class="docutils literal notranslate"><span class="pre">c</span></code>, the null value there does not matter to us).</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply_rows</span><span class="p">(</span><span class="n">gpu_add</span><span class="p">,</span>
              <span class="n">incols</span><span class="o">=</span><span class="p">[</span><span class="s1">'a'</span><span class="p">,</span> <span class="s1">'b'</span><span class="p">],</span>
              <span class="n">outcols</span><span class="o">=</span><span class="p">{</span><span class="s1">'out'</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">},</span>
              <span class="n">kwargs</span><span class="o">=</span><span class="p">{})</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th></th>
<th>a</th>
<th>b</th>
<th>c</th>
<th>out</th>
</tr>
</thead>
<tbody>
<tr>
<th>0</th>
<td>963</td>
<td>1005</td>
<td>997</td>
<td>1968.0</td>
</tr>
<tr>
<th>1</th>
<td>977</td>
<td>1026</td>
<td>null</td>
<td>2003.0</td>
</tr>
<tr>
<th>2</th>
<td>null</td>
<td>1026</td>
<td>1019</td>
<td>null</td>
</tr>
<tr>
<th>3</th>
<td>1078</td>
<td>null</td>
<td>985</td>
<td>null</td>
</tr>
<tr>
<th>4</th>
<td>979</td>
<td>982</td>
<td>1011</td>
<td>1961.0</td>
</tr>
</tbody>
</table>
</div></div>
</div>
<p>As expected, we end up with two nulls in our output. The null values from the columns we used propogated to our output, but the null from the column we ignored did not.</p>
</div>
<div class="section" id="Operating-on-Null-Values">
<h2>Operating on Null Values<a class="headerlink" href="#Operating-on-Null-Values" title="Permalink to this headline">¶</a></h2>
<p>If you don’t need to conditionally handle null values in your UDFs, feel free to skip these final two sections.</p>
<p>As a developer or data scientist, you may sometimes need to write UDFs that operate on null values. This means you need to think about the null bitmask array when writing your UDF. As a note, cuDF allows you to turn off pessimistic null handling in <code class="docutils literal notranslate"><span class="pre">apply_rows</span></code>. Instead of doing this, if you need to operate on null values we recommend writing standard <code class="docutils literal notranslate"><span class="pre">Numba.cuda</span></code> kernels. To help you interact with null bitmasks from Python, cuDF provides the <code class="docutils literal notranslate"><span class="pre">mask_get</span></code> utility function. The following
example illustrates how you can use <code class="docutils literal notranslate"><span class="pre">mask_get</span></code> in Numba kernels like we used earlier in this guide.</p>
<div class="section" id="Standard-Numba-Kernels">
<h3>Standard Numba Kernels<a class="headerlink" href="#Standard-Numba-Kernels" title="Permalink to this headline">¶</a></h3>
<p>First, we import <code class="docutils literal notranslate"><span class="pre">mask_get</span></code> and create a DataFrame with some null values.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">cudf.utils.cudautils</span> <span class="kn">import</span> <span class="n">mask_get</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">randomdata</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">dtypes</span><span class="o">=</span><span class="p">{</span><span class="s1">'a'</span><span class="p">:</span><span class="nb">float</span><span class="p">,</span> <span class="s1">'b'</span><span class="p">:</span><span class="nb">bool</span><span class="p">},</span> <span class="n">seed</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">],</span> <span class="s1">'a'</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th></th>
<th>a</th>
<th>b</th>
</tr>
</thead>
<tbody>
<tr>
<th>0</th>
<td>-0.691674315</td>
<td>True</td>
</tr>
<tr>
<th>1</th>
<td>0.480099393</td>
<td>False</td>
</tr>
<tr>
<th>2</th>
<td>null</td>
<td>True</td>
</tr>
<tr>
<th>3</th>
<td>0.067478787</td>
<td>True</td>
</tr>
<tr>
<th>4</th>
<td>null</td>
<td>False</td>
</tr>
</tbody>
</table>
</div></div>
</div>
<p>Next, we’ll define a simple kernel like before, with a couple of differences. This kernel needs access to the null bitmask, so we include a <code class="docutils literal notranslate"><span class="pre">validity_mask</span></code> argument. We also wrap our logic in a conditional based on the results of <code class="docutils literal notranslate"><span class="pre">mask_get</span></code>: - If the result of <code class="docutils literal notranslate"><span class="pre">mask_get</span></code> for that index <strong>is</strong> valid (there is a value), do the multiplication - If the result of <code class="docutils literal notranslate"><span class="pre">mask_get</span></code> for that index <strong>is not</strong> valid (it’s null), set the output -999999</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nd">@cuda</span><span class="o">.</span><span class="n">jit</span>
<span class="k">def</span> <span class="nf">gpu_kernel_masked</span><span class="p">(</span><span class="n">in_col</span><span class="p">,</span> <span class="n">validity_mask</span><span class="p">,</span> <span class="n">out_col</span><span class="p">,</span> <span class="n">multiplier</span><span class="p">):</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">in_col</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
        <span class="n">valid</span> <span class="o">=</span> <span class="n">mask_get</span><span class="p">(</span><span class="n">validity_mask</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">valid</span><span class="p">:</span>
            <span class="n">out_col</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">in_col</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">multiplier</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out_col</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">999999</span>
</pre></div>
</div>
</div>
<p>We now grab the underlying DeviceArrays and execute our kernel like we did previously, except that this time we also pass in the DeviceArray of our column’s null mask. Because Numba doesn’t yet handle masked GPU arrays, we can’t directly pass our <code class="docutils literal notranslate"><span class="pre">Series</span></code> here.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">rmm</span> <span class="c1"># RAPIDS Memory Manager</span>

<span class="n">a_dary</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">_column</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">mem</span>
<span class="n">a_mask</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">nullmask</span><span class="o">.</span><span class="n">mem</span>
<span class="n">output_dary</span> <span class="o">=</span> <span class="n">rmm</span><span class="o">.</span><span class="n">device_array_like</span><span class="p">(</span><span class="n">a_dary</span><span class="p">)</span>

<span class="n">gpu_kernel_masked</span><span class="o">.</span><span class="n">forall</span><span class="p">(</span><span class="n">output_dary</span><span class="o">.</span><span class="n">size</span><span class="p">)(</span><span class="n">a_dary</span><span class="p">,</span> <span class="n">a_mask</span><span class="p">,</span> <span class="n">output_dary</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">'result'</span><span class="p">]</span> <span class="o">=</span> <span class="n">output_dary</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th></th>
<th>a</th>
<th>b</th>
<th>result</th>
</tr>
</thead>
<tbody>
<tr>
<th>0</th>
<td>-0.691674315</td>
<td>True</td>
<td>-6.916743</td>
</tr>
<tr>
<th>1</th>
<td>0.480099393</td>
<td>False</td>
<td>4.800994</td>
</tr>
<tr>
<th>2</th>
<td>null</td>
<td>True</td>
<td>-999999.000000</td>
</tr>
<tr>
<th>3</th>
<td>0.067478787</td>
<td>True</td>
<td>0.674788</td>
</tr>
<tr>
<th>4</th>
<td>null</td>
<td>False</td>
<td>-999999.000000</td>
</tr>
</tbody>
</table>
</div></div>
</div>
</div>
</div>
<div class="section" id="Summary">
<h2>Summary<a class="headerlink" href="#Summary" title="Permalink to this headline">¶</a></h2>
<p>This guide has covered a lot of content. At this point, you should hopefully feel comfortable writing UDFs (with or without null values) that operate on</p>
<ul class="simple">
<li><p>Series</p></li>
<li><p>DataFrame</p></li>
<li><p>Rolling Windows</p></li>
<li><p>GroupBy DataFrames</p></li>
<li><p>CuPy NDArrays</p></li>
<li><p>Numba DeviceNDArrays</p></li>
</ul>
<p>For more information please see the <a class="reference external" href="https://docs.rapids.ai/api/cudf/nightly/">cuDF</a>, <a class="reference external" href="https://numba.pydata.org/numba-doc/dev/cuda/index.html">Numba.cuda</a>, and <a class="reference external" href="https://docs-cupy.chainer.org/en/stable/">CuPy</a> documentation.</p>
</div>
</div>
</div>
</div>
<footer>
<div aria-label="footer navigation" class="rst-footer-buttons" role="navigation">
<a accesskey="n" class="btn btn-neutral float-right" href="internals.html" rel="next" title="cuDF internals">Next <span class="fa fa-arrow-circle-right"></span></a>
<a accesskey="p" class="btn btn-neutral float-left" href="10min-cudf-cupy.html" rel="prev" title="10 Minutes to cuDF and CuPy"><span class="fa fa-arrow-circle-left"></span> Previous</a>
</div>
<hr/>
<div role="contentinfo">
<p>
        
        © Copyright 2020, NVIDIA

    </p>
</div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
</div>
</div>
</section>
</div>
<script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
<script defer id="rapids-selector-js" src="/assets/js/custom.js"></script></body>
</html>