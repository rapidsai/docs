<!DOCTYPE html>
<html class="writer-html5" lang="en"><head>
  <meta charset="utf-8"><meta content="Docutils 0.18.1: http://docutils.sourceforge.net/" name="generator">

  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>Hardware Resources and Testing &mdash; rapids-cmake 23.04.00 documentation</title>
      <link href="_static/pygments.css" rel="stylesheet" type="text/css">
      <link href="_static/css/theme.css" rel="stylesheet" type="text/css">
      <link href="_static/copybutton.css" rel="stylesheet" type="text/css">
      <link href="https://docs.rapids.ai/assets/css/custom.css" rel="stylesheet" type="text/css">
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/sphinx_highlight.js"></script>
        <script src="_static/clipboard.min.js"></script>
        <script src="_static/copybutton.js"></script>
        <script src="_static/copybutton_pydocs.js"></script>
        <script defer="defer" src="https://docs.rapids.ai/assets/js/custom.js"></script>
    <script src="_static/js/theme.js"></script>
    <link href="genindex.html" rel="index" title="Index">
    <link href="search.html" rel="search" title="Search">
    <link href="dependency_tracking.html" rel="prev" title="Dependency Tracking"> 
<script id="rapids-selector-pixel-src" src="https://assets.adobedtm.com/5d4962a43b79/814eb6e9b4e1/launch-4bc07f1e0b0b.min.js"></script><link href="/assets/css/custom.css" id="rapids-selector-css" rel="stylesheet"></head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav class="wy-nav-side" data-toggle="wy-nav-shift">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"><div id="rapids-jtd-container"><div class="rapids-home-container"><a class="rapids-home-container__home-btn" href="/api">Home</a></div><div class="rapids-selector__container rapids-selector--hidden"><div class="rapids-selector__selected">rapids-cmake</div><div class="rapids-selector__menu"><a class="rapids-selector__menu-item" href="/api/clx/stable/api.html">clx</a><a class="rapids-selector__menu-item" href="/api/cucim/stable/api.html">cucim</a><a class="rapids-selector__menu-item" href="/api/cudf/stable/index.html">cudf</a><a class="rapids-selector__menu-item" href="/api/cudf-java/stable">cudf-java</a><a class="rapids-selector__menu-item" href="/api/cugraph/stable">cugraph</a><a class="rapids-selector__menu-item" href="/api/cuml/stable/api.html">cuml</a><a class="rapids-selector__menu-item" href="/api/cusignal/stable/api.html">cusignal</a><a class="rapids-selector__menu-item" href="/api/cuspatial/stable">cuspatial</a><a class="rapids-selector__menu-item" href="/api/cuxfilter/stable">cuxfilter</a><a class="rapids-selector__menu-item" href="/api/dask-cuda/stable/api.html">dask-cuda</a><a class="rapids-selector__menu-item" href="/api/kvikio/stable/api.html">kvikio</a><a class="rapids-selector__menu-item" href="/api/libcudf/stable/namespacecudf.html">libcudf</a><a class="rapids-selector__menu-item" href="/api/libcugraph/stable">libcugraph</a><a class="rapids-selector__menu-item" href="/api/libcuml/stable">libcuml</a><a class="rapids-selector__menu-item" href="/api/libcuspatial/stable">libcuspatial</a><a class="rapids-selector__menu-item" href="/api/libkvikio/stable">libkvikio</a><a class="rapids-selector__menu-item" href="/api/librmm/stable/annotated.html">librmm</a><a class="rapids-selector__menu-item" href="/api/raft/stable">raft</a><a class="rapids-selector__menu-item rapids-selector__menu-item--selected" href="/api/rapids-cmake/stable/api.html">rapids-cmake</a><a class="rapids-selector__menu-item" href="/api/rmm/stable/api.html">rmm</a></div></div><div class="rapids-selector__container rapids-selector--hidden"><div class="rapids-selector__selected">nightly (23.04)</div><div class="rapids-selector__menu"><a class="rapids-selector__menu-item rapids-selector__menu-item--selected" href="/api/rapids-cmake/nightly/api.html">nightly (23.04)</a><a class="rapids-selector__menu-item" href="/api/rapids-cmake/stable/api.html">stable (23.02)</a><a class="rapids-selector__menu-item" href="/api/rapids-cmake/legacy/api.html">legacy (22.12)</a></div></div></div>

          
          
          
              
<div role="search">
  <form action="search.html" class="wy-form" id="rtd-search-form" method="get">
    <input aria-label="Search docs" name="q" placeholder="Search docs" type="text">
    <input name="check_keywords" type="hidden" value="yes">
    <input name="area" type="hidden" value="default">
  </form>
</div>
        </div><div aria-label="Navigation menu" class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="api.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="basics.html">RAPIDS-CMake Basics</a></li>
<li class="toctree-l1"><a class="reference internal" href="dependency_tracking.html">Dependency Tracking</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Hardware Resources and Testing</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#resource-allocation">Resource Allocation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#rapids-test">rapids_test</a></li>
<li class="toctree-l2"><a class="reference internal" href="#machine-gpu-detection">Machine GPU Detection</a></li>
<li class="toctree-l2"><a class="reference internal" href="#specifying-tests-gpu-requirements">Specifying Tests GPU Requirements</a></li>
<li class="toctree-l2"><a class="reference internal" href="#multi-gpu-tests">Multi GPU Tests</a></li>
<li class="toctree-l2"><a class="reference internal" href="#when-rapids-cmake-test-wrapper-is-insufficient">When rapids-cmake test wrapper is insufficient</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section class="wy-nav-content-wrap" data-toggle="wy-nav-shift"><nav aria-label="Mobile navigation menu" class="wy-nav-top">
          <i class="fa fa-bars" data-toggle="wy-nav-top"></i>
          <a href="index.html">rapids-cmake</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div aria-label="Page navigation" role="navigation">
  <ul class="wy-breadcrumbs">
      <li><a aria-label="Home" class="icon icon-home" href="index.html"></a></li>
      <li class="breadcrumb-item active">Hardware Resources and Testing</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/hardware_resources_and_testing.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr>
</div>
          <div class="document" itemscope="itemscope" itemtype="http://schema.org/Article" role="main">
           <div itemprop="articleBody">
             
  <section id="hardware-resources-and-testing">
<span id="rapids-resource-allocation"></span><h1>Hardware Resources and Testing<a class="headerlink" href="#hardware-resources-and-testing" title="Permalink to this heading">&para;</a></h1>
<section id="resource-allocation">
<h2>Resource Allocation<a class="headerlink" href="#resource-allocation" title="Permalink to this heading">&para;</a></h2>
<p>CTest resource allocation frameworks allow tests to specify which hardware resources that they need, and for projects to specify the specific local/machine resources available.
Combined together this ensures that tests are told which specific resources they should use, and ensures over-subscription won&rsquo;t occur no matter the requested testing parallel level.</p>
<p>To get CTest resource allocation used by tests the following components are needed.</p>
<blockquote>
<div><ul class="simple">
<li><p>A JSON per-machine resource specification file</p></li>
<li><p>The <span class="target" id="index-0-variable:CTEST_RESOURCE_SPEC_FILE"></span><code class="xref cmake cmake-variable docutils literal notranslate"><span class="pre">CTEST_RESOURCE_SPEC_FILE</span></code> points to the JSON file</p></li>
<li><p>Each <span class="target" id="index-0-command:add_test"></span><code class="xref cmake cmake-command docutils literal notranslate"><span class="pre">add_test()</span></code> records what resources it requires via test properties</p></li>
<li><p>Each test reads the relevant environment variables to determine
what specific resources it should use</p></li>
</ul>
</div></blockquote>
<p>These are steep requirements that require large amounts of infrastructure setup for each project.
In addition the CTest resource allocation specification is very relaxed, allowing it to represent arbitrary requirements such as CPUs, GPUs, and ASICs.</p>
</section>
<section id="rapids-test">
<h2>rapids_test<a class="headerlink" href="#rapids-test" title="Permalink to this heading">&para;</a></h2>
<p>To help RAPIDS projects utilize all GPUs on a machine when running tests, the <code class="docutils literal notranslate"><span class="pre">rapids-cmake</span></code> project offers a suite of commands to simplify the process.
These commands simplify GPU detection, setting up resource specification files, specifying test requirements, and setting the active CUDA GPU.</p>
</section>
<section id="machine-gpu-detection">
<h2>Machine GPU Detection<a class="headerlink" href="#machine-gpu-detection" title="Permalink to this heading">&para;</a></h2>
<p>The key component of CTest resource allocation is having an accurate representation of the hardware that exists on the developer&rsquo;s machine.
The <span class="target" id="index-0-command:rapids_test_init"></span><a class="reference internal" href="command/rapids_test_init.html#command:rapids_test_init" title="rapids_test_init"><code class="xref cmake cmake-command docutils literal notranslate"><span class="pre">rapids_test_init()</span></code></a> function will do system introspection to determine the number of GPUs on the current machine and generate a resource allocation JSON file representing these GPUs.</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nf">include(</span><span class="o">${</span><span class="nt">CMAKE_BINARY_DIR</span><span class="o">}</span><span class="na">/RAPIDS.cmake</span><span class="nf">)</span>

<span class="nf">include(</span><span class="nb">rapids-test</span><span class="nf">)</span>

<span class="nf">enable_testing()</span>
<span class="nf">rapids_test_init()</span>
</pre></div>
</div>
<p>The CTest resource allocation specification isn&rsquo;t limited to representing GPUs as a single unit.
Instead it allows the JSON file to specify the capacity (slots) that each GPU has.
In the case of rapids-cmake we always represent each GPU as having 100 slots allowing projects to think in total percentages when calculating requirements.</p>
</section>
<section id="specifying-tests-gpu-requirements">
<h2>Specifying Tests GPU Requirements<a class="headerlink" href="#specifying-tests-gpu-requirements" title="Permalink to this heading">&para;</a></h2>
<p>As discussed above, each CMake test needs to specify the GPU resources they require to allow CTest to properly partition GPUs given the CTest parallel level.
The easiest path for for developers is to use the <span class="target" id="index-0-command:rapids_test_add"></span><a class="reference internal" href="command/rapids_test_add.html#command:rapids_test_add" title="rapids_test_add"><code class="xref cmake cmake-command docutils literal notranslate"><span class="pre">rapids_test_add()</span></code></a> which wraps each execution in a wrapper script that sets the CUDA visible devices, making tests only see the allocated device(s).</p>
<p>For example below we have three tests, two which can run concurrently on the same GPU and one that requires a full GPU.
This specification will allow all three tests to run concurrently when a machine has 2+ GPUs with no modification of the tests!</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nf">include(</span><span class="nb">rapids-test</span><span class="nf">)</span>

<span class="nf">enable_testing()</span>
<span class="nf">rapids_test_init()</span>

<span class="nf">add_executable(</span><span class="w"> </span><span class="nb">cuda_test</span><span class="w"> </span><span class="nb">test.cu</span><span class="w"> </span><span class="nf">)</span>
<span class="nf">rapids_test_add(</span><span class="no">NAME</span><span class="w"> </span><span class="nb">test_small_alloc</span><span class="w"> </span><span class="no">COMMAND</span><span class="w"> </span><span class="nb">cuda_test</span><span class="w"> </span><span class="m">50</span><span class="w"> </span><span class="no">GPUS</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="no">PERCENT</span><span class="w"> </span><span class="m">10</span><span class="nf">)</span>
<span class="nf">rapids_test_add(</span><span class="no">NAME</span><span class="w"> </span><span class="nb">test_medium_alloc</span><span class="w"> </span><span class="no">COMMAND</span><span class="w"> </span><span class="nb">cuda_test</span><span class="w"> </span><span class="m">100</span><span class="w"> </span><span class="no">GPUS</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="no">PERCENT</span><span class="w"> </span><span class="m">20</span><span class="nf">)</span>
<span class="nf">rapids_test_add(</span><span class="no">NAME</span><span class="w"> </span><span class="nb">test_very_large_alloc</span><span class="w"> </span><span class="no">COMMAND</span><span class="w"> </span><span class="nb">cuda_test</span><span class="w"> </span><span class="m">10000</span><span class="w"> </span><span class="no">GPUS</span><span class="w"> </span><span class="m">1</span><span class="nf">)</span>
</pre></div>
</div>
</section>
<section id="multi-gpu-tests">
<h2>Multi GPU Tests<a class="headerlink" href="#multi-gpu-tests" title="Permalink to this heading">&para;</a></h2>
<p>The <span class="target" id="index-1-command:rapids_test_add"></span><a class="reference internal" href="command/rapids_test_add.html#command:rapids_test_add" title="rapids_test_add"><code class="xref cmake cmake-command docutils literal notranslate"><span class="pre">rapids_test_add()</span></code></a> command also supports tests that require multiple GPU bindings.
In that case you will need to request two (or more) GPUs with a full allocation like this:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nf">include(</span><span class="nb">rapids-test</span><span class="nf">)</span>

<span class="nf">enable_testing()</span>
<span class="nf">rapids_test_init()</span>

<span class="nf">add_executable(</span><span class="w"> </span><span class="nb">cuda_test</span><span class="w"> </span><span class="nb">test.cu</span><span class="w"> </span><span class="nf">)</span>
<span class="nf">rapids_test_add(</span><span class="no">NAME</span><span class="w"> </span><span class="nb">multi_gpu</span><span class="w"> </span><span class="no">COMMAND</span><span class="w"> </span><span class="nb">cuda_test</span><span class="w"> </span><span class="no">GPUS</span><span class="w"> </span><span class="m">3</span><span class="nf">)</span>
</pre></div>
</div>
<p>Due to how CTest does allocations if you need distinct GPUs you need to request a percentage of 51% or higher.
Otherwise you have a chance for multiple allocations to be placed on the same GPU.</p>
</section>
<section id="when-rapids-cmake-test-wrapper-is-insufficient">
<h2>When rapids-cmake test wrapper is insufficient<a class="headerlink" href="#when-rapids-cmake-test-wrapper-is-insufficient" title="Permalink to this heading">&para;</a></h2>
<p>At times the approach of using wrapper scripts is insufficient, usually due to using existing test wrappers.</p>
<p>As discussed above, each CMake test still needs to specify the GPU resources they require to allow CTest to properly partition GPUs given the CTest parallel level.
But in those cases the tests themselves will need to parse the CTest environment variables to extract what GPUs they should run on.</p>
<p>For the CMake side you can use <span class="target" id="index-0-command:rapids_test_gpu_requirements"></span><a class="reference internal" href="command/rapids_test_gpu_requirements.html#command:rapids_test_gpu_requirements" title="rapids_test_gpu_requirements"><code class="xref cmake cmake-command docutils literal notranslate"><span class="pre">rapids_test_gpu_requirements()</span></code></a> to specify the requirements:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nf">include(</span><span class="nb">rapids-test</span><span class="nf">)</span>

<span class="nf">enable_testing()</span>
<span class="nf">rapids_test_init()</span>

<span class="nf">add_executable(</span><span class="w"> </span><span class="nb">cuda_test</span><span class="w"> </span><span class="nb">test.cu</span><span class="w"> </span><span class="nf">)</span>
<span class="nf">target_link_libraries(</span><span class="w"> </span><span class="nb">cuda_test</span><span class="w"> </span><span class="no">PRIVATE</span><span class="w"> </span><span class="no">RAPIDS</span><span class="o">::</span><span class="nb">test</span><span class="w"> </span><span class="nf">)</span>

<span class="nf">add_test(</span><span class="no">NAME</span><span class="w"> </span><span class="nb">test_small_alloc</span><span class="w"> </span><span class="no">COMMAND</span><span class="w"> </span><span class="nb">cuda_test</span><span class="w"> </span><span class="m">50</span><span class="nf">)</span>
<span class="nf">rapids_test_gpu_requirements(</span><span class="nb">test_small_alloc</span><span class="w"> </span><span class="no">GPUS</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="no">PERCENT</span><span class="w"> </span><span class="m">10</span><span class="nf">)</span>
</pre></div>
</div>
<p>Now in the C++ you need to parse the relevant <cite>CTEST_RESOURCE_GROUP</cite> environment variables.
To simplify the process, here is some helper C++ code that will do the heavy lifting for you:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2022-2023, NVIDIA CORPORATION.</span>
<span class="cm"> *</span>
<span class="cm"> * Licensed under the Apache License, Version 2.0 (the "License");</span>
<span class="cm"> * you may not use this file except in compliance with the License.</span>
<span class="cm"> * You may obtain a copy of the License at</span>
<span class="cm"> *</span>
<span class="cm"> *     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="cm"> *</span>
<span class="cm"> * Unless required by applicable law or agreed to in writing, software</span>
<span class="cm"> * distributed under the License is distributed on an "AS IS" BASIS,</span>
<span class="cm"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="cm"> * See the License for the specific language governing permissions and</span>
<span class="cm"> * limitations under the License.</span>
<span class="cm"> */</span>

<span class="cp">#pragma once</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cuda_runtime_api.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;vector&gt;</span>

<span class="k">namespace</span><span class="w"> </span><span class="nn">rapids_cmake</span><span class="w"> </span><span class="p">{</span>

<span class="cm">/*</span>
<span class="cm"> * Represents a GPU Allocation provided by a CTest resource specification.</span>
<span class="cm"> *</span>
<span class="cm"> * The `device_id` maps to the CUDA gpu id required by `cudaSetDevice`.</span>
<span class="cm"> * The slots represent the percentage of the GPU that this test will use.</span>
<span class="cm"> * Primarily used by CTest to ensure proper load balancing of tests.</span>
<span class="cm"> */</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">GPUAllocation</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">device_id</span><span class="p">;</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">slots</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Returns true when a CTest resource specification has been specified.</span>
<span class="cm"> *</span>
<span class="cm"> * Since the vast majority of tests should execute without a CTest resource</span>
<span class="cm"> * spec (e.g. when executed manually by a developer), callers of `rapids_cmake`</span>
<span class="cm"> * should first ensure that a CTestresource spec file has been provided before</span>
<span class="cm"> * trying to query/bind to the allocation.</span>
<span class="cm"> *</span>
<span class="cm"> * ```cxx</span>
<span class="cm"> *   if (rapids_cmake::using_resouces()) {</span>
<span class="cm"> *     rapids_cmake::bind_to_first_gpu();</span>
<span class="cm"> *   }</span>
<span class="cm"> * ```</span>
<span class="cm"> */</span>
<span class="kt">bool</span><span class="w"> </span><span class="nf">using_resources</span><span class="p">();</span>

<span class="cm">/*</span>
<span class="cm"> * Returns all GPUAllocations allocated for a test</span>
<span class="cm"> *</span>
<span class="cm"> * To support multi-GPU tests the CTest resource specification allows a</span>
<span class="cm"> * test to request multiple GPUs. As CUDA only allows binding to a</span>
<span class="cm"> * single GPU at any time, this API allows tests to know what CUDA</span>
<span class="cm"> * devices they should bind to.</span>
<span class="cm"> *</span>
<span class="cm"> * Note: The `device_id` of each allocation might not be unique.</span>
<span class="cm"> * If a test says it needs 50% of two GPUs, it could be allocated</span>
<span class="cm"> * the same physical GPU. If a test needs distinct / unique devices</span>
<span class="cm"> * it must request 51%+ of a device.</span>
<span class="cm"> *</span>
<span class="cm"> * Note: rapids_cmake does no caching, so this query should be cached</span>
<span class="cm"> * instead of called multiple times.</span>
<span class="cm"> */</span>
<span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">GPUAllocation</span><span class="o">&gt;</span><span class="w"> </span><span class="n">full_allocation</span><span class="p">();</span>

<span class="cm">/*</span>
<span class="cm"> * Have CUDA bind to a given GPUAllocation</span>
<span class="cm"> *</span>
<span class="cm"> * Have CUDA bind to the `device_id` specified in the CTest</span>
<span class="cm"> * GPU allocation</span>
<span class="cm"> *</span>
<span class="cm"> * Note: Return value is the cudaError_t of `cudaSetDevice`</span>
<span class="cm"> */</span>
<span class="n">cudaError_t</span><span class="w"> </span><span class="nf">bind_to_gpu</span><span class="p">(</span><span class="n">GPUAllocation</span><span class="w"> </span><span class="k">const</span><span class="o">&amp;</span><span class="w"> </span><span class="n">alloc</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Convenience method to bind to the first GPU that CTest has allocated</span>
<span class="cm"> * Provided as most RAPIDS tests only require a single GPU</span>
<span class="cm"> *</span>
<span class="cm"> * Will return `false` if no GPUs have been allocated, or if setting</span>
<span class="cm"> * the CUDA device failed for any reason.</span>
<span class="cm"> */</span>
<span class="kt">bool</span><span class="w"> </span><span class="nf">bind_to_first_gpu</span><span class="p">();</span>

<span class="p">}</span><span class="w">  </span><span class="c1">// namespace rapids_cmake</span>
</pre></div>
</div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2022-2023, NVIDIA CORPORATION.</span>
<span class="cm"> *</span>
<span class="cm"> * Licensed under the Apache License, Version 2.0 (the "License");</span>
<span class="cm"> * you may not use this file except in compliance with the License.</span>
<span class="cm"> * You may obtain a copy of the License at</span>
<span class="cm"> *</span>
<span class="cm"> *     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="cm"> *</span>
<span class="cm"> * Unless required by applicable law or agreed to in writing, software</span>
<span class="cm"> * distributed under the License is distributed on an "AS IS" BASIS,</span>
<span class="cm"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="cm"> * See the License for the specific language governing permissions and</span>
<span class="cm"> * limitations under the License.</span>
<span class="cm"> */</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;rapids_cmake_ctest_allocation.hpp&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cuda_runtime_api.h&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;algorithm&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cstdlib&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;numeric&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string_view&gt;</span>

<span class="k">namespace</span><span class="w"> </span><span class="nn">rapids_cmake</span><span class="w"> </span><span class="p">{</span>

<span class="k">namespace</span><span class="w"> </span><span class="p">{</span>
<span class="n">GPUAllocation</span><span class="w"> </span><span class="nf">noGPUAllocation</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">GPUAllocation</span><span class="p">{</span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="mi">-1</span><span class="p">};</span><span class="w"> </span><span class="p">}</span>

<span class="n">GPUAllocation</span><span class="w"> </span><span class="nf">parseCTestAllocation</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string_view</span><span class="w"> </span><span class="n">env_variable</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">gpu_resources</span><span class="p">{</span><span class="n">std</span><span class="o">::</span><span class="n">getenv</span><span class="p">(</span><span class="n">env_variable</span><span class="p">.</span><span class="n">begin</span><span class="p">())};</span>
<span class="w">  </span><span class="c1">// need to handle parseCTestAllocation variable being empty</span>

<span class="w">  </span><span class="c1">// need to handle parseCTestAllocation variable not having some</span>
<span class="w">  </span><span class="c1">// of the requested components</span>

<span class="w">  </span><span class="c1">// The string looks like "id:&lt;number&gt;,slots:&lt;number&gt;"</span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">id_start</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">gpu_resources</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">"id:"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">id_end</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="n">gpu_resources</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">","</span><span class="p">);</span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">slot_start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gpu_resources</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">"slots:"</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">6</span><span class="p">;</span>

<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">id</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">gpu_resources</span><span class="p">.</span><span class="n">substr</span><span class="p">(</span><span class="n">id_start</span><span class="p">,</span><span class="w"> </span><span class="n">id_end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">id_start</span><span class="p">);</span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">slots</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gpu_resources</span><span class="p">.</span><span class="n">substr</span><span class="p">(</span><span class="n">slot_start</span><span class="p">);</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">GPUAllocation</span><span class="p">{</span><span class="n">std</span><span class="o">::</span><span class="n">stoi</span><span class="p">(</span><span class="n">id</span><span class="p">),</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">stoi</span><span class="p">(</span><span class="n">slots</span><span class="p">)};</span>
<span class="p">}</span>

<span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">GPUAllocation</span><span class="o">&gt;</span><span class="w"> </span><span class="n">determineGPUAllocations</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">GPUAllocation</span><span class="o">&gt;</span><span class="w"> </span><span class="n">allocations</span><span class="p">;</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="o">*</span><span class="w"> </span><span class="n">resource_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">getenv</span><span class="p">(</span><span class="s">"CTEST_RESOURCE_GROUP_COUNT"</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">resource_count</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">allocations</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">();</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">allocations</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="n">resource_max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">stoi</span><span class="p">(</span><span class="n">resource_count</span><span class="p">);</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">resource_max</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">index</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">group_env</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"CTEST_RESOURCE_GROUP_"</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="p">);</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">resource_group</span><span class="p">{</span><span class="n">std</span><span class="o">::</span><span class="n">getenv</span><span class="p">(</span><span class="n">group_env</span><span class="p">.</span><span class="n">c_str</span><span class="p">())};</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">transform</span><span class="p">(</span><span class="n">resource_group</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">resource_group</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span><span class="w"> </span><span class="n">resource_group</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="o">::</span><span class="n">toupper</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">resource_group</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">"GPUS"</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">resource_env</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">group_env</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">"_"</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">resource_group</span><span class="p">;</span>
<span class="w">      </span><span class="k">auto</span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">allocation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parseCTestAllocation</span><span class="p">(</span><span class="n">resource_env</span><span class="p">);</span>
<span class="w">      </span><span class="n">allocations</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="n">allocation</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">allocations</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">}</span><span class="w">  </span><span class="c1">// namespace</span>

<span class="kt">bool</span><span class="w"> </span><span class="n">using_resources</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="o">*</span><span class="w"> </span><span class="n">resource_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">getenv</span><span class="p">(</span><span class="s">"CTEST_RESOURCE_GROUP_COUNT"</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">resource_count</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">GPUAllocation</span><span class="o">&gt;</span><span class="w"> </span><span class="n">full_allocation</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">determineGPUAllocations</span><span class="p">();</span><span class="w"> </span><span class="p">}</span>

<span class="n">cudaError_t</span><span class="w"> </span><span class="n">bind_to_gpu</span><span class="p">(</span><span class="n">GPUAllocation</span><span class="w"> </span><span class="k">const</span><span class="o">&amp;</span><span class="w"> </span><span class="n">alloc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">cudaSetDevice</span><span class="p">(</span><span class="n">alloc</span><span class="p">.</span><span class="n">device_id</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>

<span class="kt">bool</span><span class="w"> </span><span class="n">bind_to_first_gpu</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">using_resources</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">GPUAllocation</span><span class="o">&gt;</span><span class="w"> </span><span class="n">allocs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">determineGPUAllocations</span><span class="p">();</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">bind_to_gpu</span><span class="p">(</span><span class="n">allocs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">cudaSuccess</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">}</span><span class="w">  </span><span class="c1">// namespace rapids_cmake</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div aria-label="Footer" class="rst-footer-buttons" role="navigation">
        <a accesskey="p" class="btn btn-neutral float-left" href="dependency_tracking.html" rel="prev" title="Dependency Tracking"><span aria-hidden="true" class="fa fa-arrow-circle-left"></span> Previous</a>
    </div>

  <hr>

  <div role="contentinfo">
    <p>&copy; Copyright 2021-2023, NVIDIA.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 


<script defer id="rapids-selector-js" src="/assets/js/custom.js"></script><script id="rapids-selector-pixel-invocation" type="text/javascript">_satellite.pageBottom();</script></body></html>