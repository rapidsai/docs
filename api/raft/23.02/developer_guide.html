<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport"><meta content="Docutils 0.17.1: http://docutils.sourceforge.net/" name="generator">

    <title>Developer Guide &mdash; raft 23.02.00 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=796348d33e8b1d947c94" rel="stylesheet">
<link href="_static/styles/bootstrap.css?digest=796348d33e8b1d947c94" rel="stylesheet">
<link href="_static/styles/pydata-sphinx-theme.css?digest=796348d33e8b1d947c94" rel="stylesheet">

  
  <link href="_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=796348d33e8b1d947c94" rel="stylesheet">
  <link as="font" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" rel="preload" type="font/woff2">
<link as="font" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" rel="preload" type="font/woff2">
<link as="font" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" rel="preload" type="font/woff2">

    <link href="_static/pygments.css" rel="stylesheet" type="text/css">
    <link href="_static/copybutton.css" rel="stylesheet" type="text/css">
    <link href="_static/references.css" rel="stylesheet" type="text/css">
    <link href="https://docs.rapids.ai/assets/css/custom.css" rel="stylesheet" type="text/css">
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link as="script" href="_static/scripts/bootstrap.js?digest=796348d33e8b1d947c94" rel="preload">
<link as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=796348d33e8b1d947c94" rel="preload">

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/sphinx_highlight.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script defer="defer" src="https://docs.rapids.ai/assets/js/custom.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'developer_guide';</script>
    <link href="genindex.html" rel="index" title="Index">
    <link href="search.html" rel="search" title="Search">
    <link href="cpp_api.html" rel="next" title="C++ API">
    <link href="build.html" rel="prev" title="Installation">
  <meta content="width=device-width, initial-scale=1" name="viewport">
  <meta content="en" name="docsearch:language">
  <script id="rapids-selector-pixel-src" src="https://assets.adobedtm.com/5d4962a43b79/814eb6e9b4e1/launch-4bc07f1e0b0b.min.js"></script><link href="/assets/css/custom.css" id="rapids-selector-css" rel="stylesheet"></head>
  
  
  <body data-default-mode data-offset="180" data-spy="scroll" data-target="#bd-toc-nav">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>

  
  <input class="sidebar-toggle" id="__primary" name="__primary" type="checkbox">
  <label class="overlay overlay-primary" for="__primary"></label>

  
  <input class="sidebar-toggle" id="__secondary" name="__secondary" type="checkbox">
  <label class="overlay overlay-secondary" for="__secondary"></label>

  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
      
<form action="search.html" class="bd-search d-flex align-items-center" method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input aria-label="Search the docs ..." autocapitalize="off" autocomplete="off" autocorrect="off" class="form-control" id="search-input" name="q" placeholder="Search the docs ..." spellcheck="false" type="search">
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
    </div>
  </div>

  
  <nav class="bd-header navbar navbar-expand-lg bd-navbar" id="navbar-main"><div class="bd-header__inner bd-page-width">
  <label class="sidebar-toggle primary-toggle" for="__primary">
      <span class="fa-solid fa-bars"></span>
  </label>
  <div id="navbar-start">
    
    
  


<a class="navbar-brand logo" href="index.html">

  
  
  
  
  
  
  

  
  
    <p class="title logo__title">raft 23.02.00 documentation</p>
  
</a>
    
  </div>

  
  <div class="navbar-header-items">
    <div class="ml-auto" id="navbar-center">
      
      <div class="navbar-center-item">
        <nav class="navbar-nav">
    <p aria-label="Site Navigation" aria-level="1" class="sidebar-header-items__title" role="heading">
        Site Navigation
    </p>
    <ul class="navbar-nav" id="navbar-main-elements">
        
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="quick_start.html">
                        Quick Start
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="build.html">
                        Installation
                      </a>
                    </li>
                

                    <li class="nav-item current active">
                      <a class="nav-link nav-internal" href="#">
                        Developer Guide
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="cpp_api.html">
                        C++ API
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="pylibraft_api.html">
                        Python API
                      </a>
                    </li>
                
            <div class="nav-item dropdown">
                <button aria-expanded="false" aria-haspopup="true" class="btn dropdown-toggle nav-item" data-toggle="dropdown" type="button">
                    More
                </button>
                <div class="dropdown-menu">
                    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="raft_dask_api.html">
                        RAFT Dask API
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="using_comms.html">
                        Using RAFT Comms
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="contributing.html">
                        Contributing
                      </a>
                    </li>
                
                </div>
            </div>
            
    </ul>
</nav>
      </div>
      
    </div>

    <div id="navbar-end">
      
        <div class="navbar-end-item navbar-persistent--container">
          
<button aria-label="Search" class="btn btn-sm navbar-btn search-button search-button__button" data-toggle="tooltip" title="Search">
  <i class="fa-solid fa-magnifying-glass"></i>
</button>
        </div>
      
      
      <div class="navbar-end-item">
        <button aria-label="light/dark" class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" data-toggle="tooltip" title="light/dark">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
</button>
      </div>
      
      <div class="navbar-end-item">
        <ul aria-label="Icon Links" class="navbar-nav" id="navbar-icon-links">
        <li class="nav-item">
          
          
          
          
          
          
          
          <a class="nav-link" data-toggle="tooltip" href="https://github.com/rapidsai/raft" rel="noopener" target="_blank" title="GitHub"><span><i class="fa-brands fa-square-github"></i></span>
            <label class="sr-only">GitHub</label></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          <a class="nav-link" data-toggle="tooltip" href="https://twitter.com/rapidsai" rel="noopener" target="_blank" title="Twitter"><span><i class="fa-brands fa-square-twitter"></i></span>
            <label class="sr-only">Twitter</label></a>
        </li>
      </ul>
      </div>
      
    </div>
  </div>


  
  
    <div class="navbar-persistent--mobile">
<button aria-label="Search" class="btn btn-sm navbar-btn search-button search-button__button" data-toggle="tooltip" title="Search">
  <i class="fa-solid fa-magnifying-glass"></i>
</button>
    </div>
  

  
  <label class="sidebar-toggle secondary-toggle" for="__secondary">
      <span class="fa-solid fa-outdent"></span>
  </label>
  

</div>
  </nav>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar hide-on-wide"><div id="rapids-pydata-container"><div class="rapids-home-container"><a class="rapids-home-container__home-btn" href="/api">Home</a></div><div class="rapids-selector__container rapids-selector--hidden"><div class="rapids-selector__selected">raft</div><div class="rapids-selector__menu"><a class="rapids-selector__menu-item" href="/api/clx/stable/api.html">clx</a><a class="rapids-selector__menu-item" href="/api/cucim/stable/api.html">cucim</a><a class="rapids-selector__menu-item" href="/api/cudf/stable/index.html">cudf</a><a class="rapids-selector__menu-item" href="/api/cudf-java/stable">cudf-java</a><a class="rapids-selector__menu-item" href="/api/cugraph/stable">cugraph</a><a class="rapids-selector__menu-item" href="/api/cuml/stable/api.html">cuml</a><a class="rapids-selector__menu-item" href="/api/cusignal/stable/api.html">cusignal</a><a class="rapids-selector__menu-item" href="/api/cuspatial/stable">cuspatial</a><a class="rapids-selector__menu-item" href="/api/cuxfilter/stable">cuxfilter</a><a class="rapids-selector__menu-item" href="/api/dask-cuda/stable/api.html">dask-cuda</a><a class="rapids-selector__menu-item" href="/api/kvikio/stable/api.html">kvikio</a><a class="rapids-selector__menu-item" href="/api/libcudf/stable/namespacecudf.html">libcudf</a><a class="rapids-selector__menu-item" href="/api/libcugraph/stable">libcugraph</a><a class="rapids-selector__menu-item" href="/api/libcuml/stable">libcuml</a><a class="rapids-selector__menu-item" href="/api/libcuspatial/stable">libcuspatial</a><a class="rapids-selector__menu-item" href="/api/libkvikio/stable">libkvikio</a><a class="rapids-selector__menu-item" href="/api/librmm/stable/annotated.html">librmm</a><a class="rapids-selector__menu-item rapids-selector__menu-item--selected" href="/api/raft/stable">raft</a><a class="rapids-selector__menu-item" href="/api/rapids-cmake/stable/api.html">rapids-cmake</a><a class="rapids-selector__menu-item" href="/api/rmm/stable/api.html">rmm</a></div></div><div class="rapids-selector__container rapids-selector--hidden"><div class="rapids-selector__selected">stable (23.02)</div><div class="rapids-selector__menu"><a class="rapids-selector__menu-item" href="/api/raft/nightly">nightly (23.04)</a><a class="rapids-selector__menu-item rapids-selector__menu-item--selected" href="/api/raft/stable">stable (23.02)</a><a class="rapids-selector__menu-item" href="/api/raft/legacy">legacy (22.12)</a></div></div></div>
        
  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
      
      <div class="navbar-center-item">
        <nav class="navbar-nav">
    <p aria-label="Site Navigation" aria-level="1" class="sidebar-header-items__title" role="heading">
        Site Navigation
    </p>
    <ul class="navbar-nav" id="navbar-main-elements">
        
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="quick_start.html">
                        Quick Start
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="build.html">
                        Installation
                      </a>
                    </li>
                

                    <li class="nav-item current active">
                      <a class="nav-link nav-internal" href="#">
                        Developer Guide
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="cpp_api.html">
                        C++ API
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="pylibraft_api.html">
                        Python API
                      </a>
                    </li>
                
            <div class="nav-item dropdown">
                <button aria-expanded="false" aria-haspopup="true" class="btn dropdown-toggle nav-item" data-toggle="dropdown" type="button">
                    More
                </button>
                <div class="dropdown-menu">
                    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="raft_dask_api.html">
                        RAFT Dask API
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="using_comms.html">
                        Using RAFT Comms
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="contributing.html">
                        Contributing
                      </a>
                    </li>
                
                </div>
            </div>
            
    </ul>
</nav>
      </div>
      
      </div>
    

    
    
    <div class="sidebar-header-items__end">
      
      <div class="navbar-end-item">
        <button aria-label="light/dark" class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" data-toggle="tooltip" title="light/dark">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
</button>
      </div>
      
      <div class="navbar-end-item">
        <ul aria-label="Icon Links" class="navbar-nav" id="navbar-icon-links">
        <li class="nav-item">
          
          
          
          
          
          
          
          <a class="nav-link" data-toggle="tooltip" href="https://github.com/rapidsai/raft" rel="noopener" target="_blank" title="GitHub"><span><i class="fa-brands fa-square-github"></i></span>
            <label class="sr-only">GitHub</label></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          <a class="nav-link" data-toggle="tooltip" href="https://twitter.com/rapidsai" rel="noopener" target="_blank" title="Twitter"><span><i class="fa-brands fa-square-twitter"></i></span>
            <label class="sr-only">Twitter</label></a>
        </li>
      </ul>
      </div>
      
    </div>
    
  </div>

  

  
  <div class="sidebar-end-items sidebar-primary__section">
    <div class="sidebar-end-items__item">
    </div>
  </div>

  
  <div id="rtd-footer-container"></div>

      </div>
      <main class="bd-main" id="main-content">
        
        
        <div class="bd-content">
          <div class="bd-article-container">
            
            <div class="bd-header-article">
                
            </div>
            
            
            <article class="bd-article" role="main">
              
  <section id="developer-guide">
<h1>Developer Guide<a class="headerlink" href="#developer-guide" title="Permalink to this heading">#</a></h1>
<section id="general">
<h2>General<a class="headerlink" href="#general" title="Permalink to this heading">#</a></h2>
<p>Please start by reading the <a class="reference internal" href="contributing.html"><span class="doc">Contributor Guide</span></a>.</p>
</section>
<section id="performance">
<h2>Performance<a class="headerlink" href="#performance" title="Permalink to this heading">#</a></h2>
<ol class="simple">
<li><p>In performance critical sections of the code, favor <code class="docutils literal notranslate"><span class="pre">cudaDeviceGetAttribute</span></code> over <code class="docutils literal notranslate"><span class="pre">cudaDeviceGetProperties</span></code>. See corresponding CUDA devblog <a class="reference external" href="https://devblogs.nvidia.com/cuda-pro-tip-the-fast-way-to-query-device-properties/">here</a> to know more.</p></li>
<li><p>If an algo requires you to launch GPU work in multiple cuda streams, do not create multiple <code class="docutils literal notranslate"><span class="pre">raft::resources</span></code> objects, one for each such work stream. Instead, use the stream pool configured on the given <code class="docutils literal notranslate"><span class="pre">raft::resources</span></code> instance&rsquo;s <code class="docutils literal notranslate"><span class="pre">raft::resources::get_stream_from_stream_pool()</span></code> to pick up the right cuda stream. Refer to the section on <a class="reference external" href="#resource-management">CUDA Resources</a> and the section on <a class="reference external" href="#threading-model">Threading</a> for more details. TIP: use <code class="docutils literal notranslate"><span class="pre">raft::resources::get_stream_pool_size()</span></code> to know how many such streams are available at your disposal.</p></li>
</ol>
</section>
<section id="local-development">
<h2>Local Development<a class="headerlink" href="#local-development" title="Permalink to this heading">#</a></h2>
<p>Developing features and fixing bugs for the RAFT library itself is straightforward and only requires building and installing the relevant RAFT artifacts.</p>
<p>The process for working on a CUDA/C++ feature which might span RAFT and one or more consuming libraries can vary slightly depending on whether the consuming project relies on a source build (as outlined in the <a class="reference external" href="BUILD.md#install_header_only_cpp">BUILD</a> docs). In such a case, the option <code class="docutils literal notranslate"><span class="pre">CPM_raft_SOURCE=/path/to/raft/source</span></code> can be passed to the cmake of the consuming project in order to build the local RAFT from source. The PR with relevant changes to the consuming project can also pin the RAFT version temporarily by explicitly changing the <code class="docutils literal notranslate"><span class="pre">FORK</span></code> and <code class="docutils literal notranslate"><span class="pre">PINNED_TAG</span></code> arguments to the RAFT branch containing their changes when invoking <code class="docutils literal notranslate"><span class="pre">find_and_configure_raft</span></code>.  The pin should be reverted after the changed is merged to the RAFT project and before it is merged to the dependent project(s) downstream.</p>
<p>If building a feature which spans projects and not using the source build in cmake, the RAFT changes (both C++ and Python) will need to be installed into the environment of the consuming project before they can be used. The ideal integration of RAFT into consuming projects will enable both the source build in the consuming project only for this case but also rely on a more stable packaging (such as conda packaging) otherwise.</p>
</section>
<section id="threading-model">
<h2>Threading Model<a class="headerlink" href="#threading-model" title="Permalink to this heading">#</a></h2>
<p>With the exception of the <code class="docutils literal notranslate"><span class="pre">raft::resources</span></code>, RAFT algorithms should maintain thread-safety and are, in general,
assumed to be single threaded. This means they should be able to be called from multiple host threads so
long as different instances of <code class="docutils literal notranslate"><span class="pre">raft::resources</span></code> are used.</p>
<p>Exceptions are made for algorithms that can take advantage of multiple CUDA streams within multiple host threads
in order to oversubscribe or increase occupancy on a single GPU. In these cases, the use of multiple host
threads within RAFT algorithms should be used only to maintain concurrency of the underlying CUDA streams.
Multiple host threads should be used sparingly, be bounded, and should steer clear of performing CPU-intensive
computations.</p>
<p>A good example of an acceptable use of host threads within a RAFT algorithm might look like the following</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;raft/core/resources.hpp&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;raft/core/resource/cuda_stream.hpp&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;raft/core/resource/cuda_stream_pool.hpp&gt;</span>
<span class="n">raft</span><span class="o">::</span><span class="n">resources</span><span class="w"> </span><span class="n">res</span><span class="p">;</span>

<span class="p">...</span>

<span class="n">sync_stream</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>

<span class="p">...</span>

<span class="kt">int</span><span class="w"> </span><span class="n">n_streams</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_stream_pool_size</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>

<span class="cp">#pragma omp parallel for num_threads(n_threads)</span>
<span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">thread_num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">omp_get_thread_num</span><span class="p">()</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">n_threads</span><span class="p">;</span>
<span class="w">    </span><span class="n">cudaStream_t</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_stream_from_stream_pool</span><span class="p">(</span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="n">thread_num</span><span class="p">);</span>
<span class="w">    </span><span class="p">...</span><span class="w"> </span><span class="n">possible</span><span class="w"> </span><span class="n">light</span><span class="w"> </span><span class="n">cpu</span><span class="w"> </span><span class="n">pre</span><span class="o">-</span><span class="n">processing</span><span class="w"> </span><span class="p">...</span>
<span class="w">    </span><span class="n">my_kernel1</span><span class="o">&lt;&lt;&lt;</span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">tpb</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="o">&gt;&gt;&gt;</span><span class="p">(...);</span>
<span class="w">    </span><span class="p">...</span>
<span class="w">    </span><span class="p">...</span><span class="w"> </span><span class="n">some</span><span class="w"> </span><span class="n">possible</span><span class="w"> </span><span class="n">async</span><span class="w"> </span><span class="n">d2h</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">h2d</span><span class="w"> </span><span class="n">copies</span><span class="w"> </span><span class="p">...</span>
<span class="w">    </span><span class="n">my_kernel2</span><span class="o">&lt;&lt;&lt;</span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">tpb</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="o">&gt;&gt;&gt;</span><span class="p">(...);</span>
<span class="w">    </span><span class="p">...</span>
<span class="w">    </span><span class="n">sync_stream</span><span class="p">(</span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">);</span>
<span class="w">    </span><span class="p">...</span><span class="w"> </span><span class="n">possible</span><span class="w"> </span><span class="n">light</span><span class="w"> </span><span class="n">cpu</span><span class="w"> </span><span class="n">post</span><span class="o">-</span><span class="n">processing</span><span class="w"> </span><span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In the example above, if there is no CPU pre-processing at the beginning of the for-loop, an event can be registered in
each of the streams within the for-loop to make them wait on the stream from the handle. If there is no CPU post-processing
at the end of each for-loop iteration, <code class="docutils literal notranslate"><span class="pre">sync_stream(res,</span> <span class="pre">s)</span></code> can be replaced with a single <code class="docutils literal notranslate"><span class="pre">sync_stream_pool(res)</span></code>
after the for-loop.</p>
<p>To avoid compatibility issues between different threading models, the only threading programming allowed in RAFT is OpenMP.
Though RAFT&rsquo;s build enables OpenMP by default, RAFT algorithms should still function properly even when OpenMP has been
disabled. If the CPU pre- and post-processing were not needed in the example above, OpenMP would not be needed.</p>
<p>The use of threads in third-party libraries is allowed, though they should still avoid depending on a specific OpenMP runtime.</p>
</section>
<section id="public-interface">
<h2>Public Interface<a class="headerlink" href="#public-interface" title="Permalink to this heading">#</a></h2>
<section id="general-guidelines">
<h3>General guidelines<a class="headerlink" href="#general-guidelines" title="Permalink to this heading">#</a></h3>
<p>Functions exposed via the C++ API must be stateless. Things that are OK to be exposed on the interface:</p>
<ol class="simple">
<li><p>Any <a class="reference external" href="https://en.wikipedia.org/wiki/Passive_data_structure">POD</a> - see <a class="reference external" href="https://en.cppreference.com/w/cpp/types/is_pod">std::is_pod</a> as a reference for C++11  POD types.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">raft::resources</span></code> - since it stores resource-related state which has nothing to do with model/algo state.</p></li>
<li><p>Avoid using pointers to POD types (explicitly putting it out, even though it can be considered as a POD) and pass the structures by reference instead.
Internal to the C++ API, these stateless functions are free to use their own temporary classes, as long as they are not exposed on the interface.</p></li>
<li><p>Accept single- (<code class="docutils literal notranslate"><span class="pre">raft::span</span></code>) and multi-dimensional views (<code class="docutils literal notranslate"><span class="pre">raft::mdspan</span></code>) and validate their metadata wherever possible.</p></li>
<li><p>Prefer <code class="docutils literal notranslate"><span class="pre">std::optional</span></code> for any optional arguments (e.g. do not accept <code class="docutils literal notranslate"><span class="pre">nullptr</span></code>)</p></li>
<li><p>All public APIs should be lightweight wrappers around calls to private APIs inside the <code class="docutils literal notranslate"><span class="pre">detail</span></code> namespace.</p></li>
</ol>
</section>
<section id="api-stability">
<h3>API stability<a class="headerlink" href="#api-stability" title="Permalink to this heading">#</a></h3>
<p>Since RAFT is a core library with multiple consumers, it&rsquo;s important that the public APIs maintain stability across versions and any changes to them are done with caution, adding new functions and deprecating the old functions over a couple releases as necessary.</p>
</section>
<section id="stateless-c-apis">
<h3>Stateless C++ APIs<a class="headerlink" href="#stateless-c-apis" title="Permalink to this heading">#</a></h3>
<p>Using the IVF-PQ algorithm as an example, the following way of exposing its API would be wrong according to the guidelines in this section, since it exposes a non-POD C++ class object in the C++ API:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">value_t</span><span class="p">,</span><span class="w"> </span><span class="k">typename</span><span class="w"> </span><span class="nc">idx_t</span><span class="o">&gt;</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ivf_pq</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">ivf_pq_params</span><span class="w"> </span><span class="n">params_</span><span class="p">;</span>
<span class="w">  </span><span class="n">raft</span><span class="o">::</span><span class="n">resources</span><span class="w"> </span><span class="k">const</span><span class="o">&amp;</span><span class="w"> </span><span class="n">res_</span><span class="p">;</span>
<span class="w">  </span>
<span class="k">public</span><span class="o">:</span>
<span class="w">  </span><span class="n">ivf_pq</span><span class="p">(</span><span class="n">raft</span><span class="o">::</span><span class="n">resources</span><span class="w"> </span><span class="k">const</span><span class="o">&amp;</span><span class="w"> </span><span class="n">res</span><span class="p">);</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">train</span><span class="p">(</span><span class="n">raft</span><span class="o">::</span><span class="n">device_matrix</span><span class="o">&lt;</span><span class="n">value_t</span><span class="p">,</span><span class="w"> </span><span class="n">idx_t</span><span class="p">,</span><span class="w"> </span><span class="n">raft</span><span class="o">::</span><span class="n">row_major</span><span class="o">&gt;</span><span class="w"> </span><span class="n">dataset</span><span class="p">);</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">search</span><span class="p">(</span><span class="n">raft</span><span class="o">::</span><span class="n">device_matrix</span><span class="o">&lt;</span><span class="n">value_t</span><span class="p">,</span><span class="w"> </span><span class="n">idx_t</span><span class="p">,</span><span class="w"> </span><span class="n">raft</span><span class="o">::</span><span class="n">row_major</span><span class="o">&gt;</span><span class="w"> </span><span class="n">queries</span><span class="p">,</span><span class="w"> </span>
<span class="w">              </span><span class="n">raft</span><span class="o">::</span><span class="n">device_matrix</span><span class="o">&lt;</span><span class="n">value_t</span><span class="p">,</span><span class="w"> </span><span class="n">idx_t</span><span class="p">,</span><span class="w"> </span><span class="n">raft</span><span class="o">::</span><span class="n">row_major</span><span class="o">&gt;</span><span class="w"> </span><span class="n">out_inds</span><span class="p">,</span><span class="w"> </span>
<span class="w">              </span><span class="n">raft</span><span class="o">::</span><span class="n">device_matrix</span><span class="o">&lt;</span><span class="n">value_t</span><span class="p">,</span><span class="w"> </span><span class="n">idx_t</span><span class="p">,</span><span class="w"> </span><span class="n">raft</span><span class="o">::</span><span class="n">row_major</span><span class="o">&gt;</span><span class="w"> </span><span class="n">out_dists</span><span class="p">);</span>
<span class="p">};</span>
</pre></div>
</div>
<p>An alternative correct way to expose this could be:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">namespace</span><span class="w"> </span><span class="nn">raft</span><span class="o">::</span><span class="nn">ivf_pq</span><span class="w"> </span><span class="p">{</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">value_t</span><span class="p">,</span><span class="w"> </span><span class="k">typename</span><span class="w"> </span><span class="nc">value_idx</span><span class="o">&gt;</span>
<span class="kt">void</span><span class="w"> </span><span class="n">ivf_pq_train</span><span class="p">(</span><span class="n">raft</span><span class="o">::</span><span class="n">resources</span><span class="w"> </span><span class="k">const</span><span class="o">&amp;</span><span class="w"> </span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">raft</span><span class="o">::</span><span class="n">ivf_pq_params</span><span class="w"> </span><span class="o">&amp;</span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="n">raft</span><span class="o">::</span><span class="n">ivf_pq_index</span><span class="w"> </span><span class="o">&amp;</span><span class="n">index</span><span class="p">,</span>
<span class="n">raft</span><span class="o">::</span><span class="n">device_matrix</span><span class="o">&lt;</span><span class="n">value_t</span><span class="p">,</span><span class="w"> </span><span class="n">idx_t</span><span class="p">,</span><span class="w"> </span><span class="n">raft</span><span class="o">::</span><span class="n">row_major</span><span class="o">&gt;</span><span class="w"> </span><span class="n">dataset</span><span class="p">);</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">value_t</span><span class="p">,</span><span class="w"> </span><span class="k">typename</span><span class="w"> </span><span class="nc">value_idx</span><span class="o">&gt;</span>
<span class="kt">void</span><span class="w"> </span><span class="n">ivf_pq_search</span><span class="p">(</span><span class="n">raft</span><span class="o">::</span><span class="n">resources</span><span class="w"> </span><span class="k">const</span><span class="o">&amp;</span><span class="w"> </span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="n">raft</span><span class="o">::</span><span class="n">ivf_pq_params</span><span class="w"> </span><span class="k">const</span><span class="o">&amp;</span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="n">raft</span><span class="o">::</span><span class="n">ivf_pq_index</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">index</span><span class="p">,</span>
<span class="n">raft</span><span class="o">::</span><span class="n">device_matrix</span><span class="o">&lt;</span><span class="n">value_t</span><span class="p">,</span><span class="w"> </span><span class="n">idx_t</span><span class="p">,</span><span class="w"> </span><span class="n">raft</span><span class="o">::</span><span class="n">row_major</span><span class="o">&gt;</span><span class="w"> </span><span class="n">queries</span><span class="p">,</span>
<span class="n">raft</span><span class="o">::</span><span class="n">device_matrix</span><span class="o">&lt;</span><span class="n">value_t</span><span class="p">,</span><span class="w"> </span><span class="n">idx_t</span><span class="p">,</span><span class="w"> </span><span class="n">raft</span><span class="o">::</span><span class="n">row_major</span><span class="o">&gt;</span><span class="w"> </span><span class="n">out_inds</span><span class="p">,</span>
<span class="n">raft</span><span class="o">::</span><span class="n">device_matrix</span><span class="o">&lt;</span><span class="n">value_t</span><span class="p">,</span><span class="w"> </span><span class="n">idx_t</span><span class="p">,</span><span class="w"> </span><span class="n">raft</span><span class="o">::</span><span class="n">row_major</span><span class="o">&gt;</span><span class="w"> </span><span class="n">out_dists</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="other-functions-on-state">
<h3>Other functions on state<a class="headerlink" href="#other-functions-on-state" title="Permalink to this heading">#</a></h3>
<p>These guidelines also mean that it is the responsibility of C++ API to expose methods to load and store (aka marshalling) such a data structure. Further continuing the IVF-PQ example,  the following methods could achieve this:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">namespace</span><span class="w"> </span><span class="nn">raft</span><span class="o">::</span><span class="nn">ivf_pq</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="kt">void</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="n">raft</span><span class="o">::</span><span class="n">ivf_pq_index</span><span class="w"> </span><span class="k">const</span><span class="o">&amp;</span><span class="w"> </span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="w"> </span><span class="o">&amp;</span><span class="n">os</span><span class="p">);</span>
<span class="w">   </span><span class="kt">void</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span><span class="n">raft</span><span class="o">::</span><span class="n">ivf_pq_index</span><span class="o">&amp;</span><span class="w"> </span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">istream</span><span class="w"> </span><span class="o">&amp;</span><span class="n">is</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="coding-style">
<h2>Coding style<a class="headerlink" href="#coding-style" title="Permalink to this heading">#</a></h2>
<section id="code-format">
<h3>Code format<a class="headerlink" href="#code-format" title="Permalink to this heading">#</a></h3>
<section id="introduction">
<h4>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading">#</a></h4>
<p>RAFT relies on <code class="docutils literal notranslate"><span class="pre">clang-format</span></code> to enforce code style across all C++ and CUDA source code. The coding style is based on the <a class="reference external" href="https://google.github.io/styleguide/cppguide.html#Formatting">Google style guide</a>. The only digressions from this style are the following.</p>
<ol class="simple">
<li><p>Do not split empty functions/records/namespaces.</p></li>
<li><p>Two-space indentation everywhere, including the line continuations.</p></li>
<li><p>Disable reflowing of comments.
The reasons behind these deviations from the Google style guide are given in comments <a class="reference external" href="../../cpp/.clang-format">here</a>.</p></li>
</ol>
</section>
<section id="how-is-the-check-done">
<h4>How is the check done?<a class="headerlink" href="#how-is-the-check-done" title="Permalink to this heading">#</a></h4>
<p>All formatting checks are done by this python script: <a class="reference external" href="../../cpp/scripts/run-clang-format.py">run-clang-format.py</a> which is effectively a wrapper over <code class="docutils literal notranslate"><span class="pre">clang-format</span></code>. An error is raised if the code diverges from the format suggested by clang-format. It is expected that the developers run this script to detect and fix formatting violations before creating PR.</p>
<section id="as-part-of-ci">
<h5>As part of CI<a class="headerlink" href="#as-part-of-ci" title="Permalink to this heading">#</a></h5>
<p><a class="reference external" href="../../cpp/scripts/run-clang-format.py">run-clang-format.py</a> is executed as part of our <code class="docutils literal notranslate"><span class="pre">ci/checks/style.sh</span></code> CI test. If there are any formatting violations, PR author is expected to fix those to get CI passing. Steps needed to fix the formatting violations are described in the subsequent sub-section.</p>
</section>
<section id="manually">
<h5>Manually<a class="headerlink" href="#manually" title="Permalink to this heading">#</a></h5>
<p>Developers can also manually (or setup this command as part of git pre-commit hook) run this check by executing:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python<span class="w"> </span>./cpp/scripts/run-clang-format.py
</pre></div>
</div>
<p>From the root of the RAFT repository.</p>
</section>
</section>
<section id="how-to-know-the-formatting-violations">
<h4>How to know the formatting violations?<a class="headerlink" href="#how-to-know-the-formatting-violations" title="Permalink to this heading">#</a></h4>
<p>When there are formatting errors, <a class="reference external" href="../../cpp/scripts/run-clang-format.py">run-clang-format.py</a> prints a <code class="docutils literal notranslate"><span class="pre">diff</span></code> command, showing where there are formatting differences. Unfortunately, unlike <code class="docutils literal notranslate"><span class="pre">flake8</span></code>, <code class="docutils literal notranslate"><span class="pre">clang-format</span></code> does NOT print descriptions of the violations, but instead directly formats the code. So, the only way currently to know about formatting differences is to run the diff command as suggested by this script against each violating source file.</p>
</section>
<section id="how-to-fix-the-formatting-violations">
<h4>How to fix the formatting violations?<a class="headerlink" href="#how-to-fix-the-formatting-violations" title="Permalink to this heading">#</a></h4>
<p>When there are formatting violations, <a class="reference external" href="../../cpp/scripts/run-clang-format.py">run-clang-format.py</a> prints at the end, the exact command that can be run by developers to fix them. This is the easiest way to fix formatting errors. <a class="reference external" href="https://asciinema.org/a/287367">This screencast</a> shows how developers can check for formatting violations in their branches and also how to fix those, before sending out PRs.</p>
<p>In short, to bulk-fix all the formatting violations, execute the following command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python<span class="w"> </span>./cpp/scripts/run-clang-format.py<span class="w"> </span>-inplace
</pre></div>
</div>
<p>From the root of the RAFT repository.</p>
</section>
<section id="clang-format-version">
<h4>clang-format version?<a class="headerlink" href="#clang-format-version" title="Permalink to this heading">#</a></h4>
<p>To avoid spurious code style violations we specify the exact clang-format version required, currently <code class="docutils literal notranslate"><span class="pre">11.1.0</span></code>. This is enforced by the <a class="reference external" href="../../cpp/scripts/run-clang-format.py">run-clang-format.py</a> script itself. Refer <a class="reference external" href="../../cpp/README.md#dependencies">here</a> for the list of build-time dependencies.</p>
</section>
<section id="additional-scripts">
<h4>Additional scripts<a class="headerlink" href="#additional-scripts" title="Permalink to this heading">#</a></h4>
<p>Along with clang, there are an include checker and copyright checker scripts for checking style, which can be performed as part of CI, as well as manually.</p>
<section id="include-style">
<h5>#include style<a class="headerlink" href="#include-style" title="Permalink to this heading">#</a></h5>
<p><a class="reference external" href="../../cpp/scripts/include_checker.py">include_checker.py</a> is used to enforce the include style as follows:</p>
<ol class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">#include</span> <span class="pre">"..."</span></code> should be used for referencing local files only. It is acceptable to be used for referencing files in a sub-folder/parent-folder of the same algorithm, but should never be used to include files in other algorithms or between algorithms and the primitives or other dependencies.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">#include</span> <span class="pre">&lt;...&gt;</span></code> should be used for referencing everything else</p></li>
</ol>
<p>Manually, run the following to bulk-fix include style issues:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python<span class="w"> </span>./cpp/scripts/include_checker.py<span class="w"> </span>--inplace<span class="w"> </span><span class="o">[</span>cpp/include<span class="w"> </span>cpp/test<span class="w"> </span>...<span class="w"> </span>list<span class="w"> </span>of<span class="w"> </span>folders<span class="w"> </span>which<span class="w"> </span>you<span class="w"> </span>want<span class="w"> </span>to<span class="w"> </span>fix<span class="o">]</span>
</pre></div>
</div>
</section>
<section id="copyright-header">
<h5>Copyright header<a class="headerlink" href="#copyright-header" title="Permalink to this heading">#</a></h5>
<p><a class="reference external" href="../../ci/checks/copyright.py">copyright.py</a> checks the Copyright header for all git-modified files</p>
<p>Manually, you can run the following to bulk-fix the header if only the years need to be updated:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python<span class="w"> </span>./ci/checks/copyright.py<span class="w"> </span>--update-current-year
</pre></div>
</div>
<p>Keep in mind that this only applies to files tracked by git and having been modified.</p>
</section>
</section>
</section>
</section>
<section id="error-handling">
<h2>Error handling<a class="headerlink" href="#error-handling" title="Permalink to this heading">#</a></h2>
<p>Call CUDA APIs via the provided helper macros <code class="docutils literal notranslate"><span class="pre">RAFT_CUDA_TRY</span></code>, <code class="docutils literal notranslate"><span class="pre">RAFT_CUBLAS_TRY</span></code> and <code class="docutils literal notranslate"><span class="pre">RAFT_CUSOLVER_TRY</span></code>. These macros take care of checking the return values of the used API calls and generate an exception when the command is not successful. If you need to avoid an exception, e.g. inside a destructor, use <code class="docutils literal notranslate"><span class="pre">RAFT_CUDA_TRY_NO_THROW</span></code>, <code class="docutils literal notranslate"><span class="pre">RAFT_CUBLAS_TRY_NO_THROW</span> </code> and <code class="docutils literal notranslate"><span class="pre">RAFT_CUSOLVER_TRY_NO_THROW</span></code>. These macros log the error but do not throw an exception.</p>
</section>
<section id="logging">
<h2>Logging<a class="headerlink" href="#logging" title="Permalink to this heading">#</a></h2>
<section id="id1">
<h3>Introduction<a class="headerlink" href="#id1" title="Permalink to this heading">#</a></h3>
<p>Anything and everything about logging is defined inside <a class="reference external" href="../../cpp/include/raft/core/logger.hpp">logger.hpp</a>. It uses <a class="reference external" href="https://github.com/gabime/spdlog">spdlog</a> underneath, but this information is transparent to all.</p>
</section>
<section id="usage">
<h3>Usage<a class="headerlink" href="#usage" title="Permalink to this heading">#</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;raft/core/logger.hpp&gt;</span>

<span class="c1">// Inside your method or function, use any of these macros</span>
<span class="n">RAFT_LOG_TRACE</span><span class="p">(</span><span class="s">"Hello %s!"</span><span class="p">,</span><span class="w"> </span><span class="s">"world"</span><span class="p">);</span>
<span class="n">RAFT_LOG_DEBUG</span><span class="p">(</span><span class="s">"Hello %s!"</span><span class="p">,</span><span class="w"> </span><span class="s">"world"</span><span class="p">);</span>
<span class="n">RAFT_LOG_INFO</span><span class="p">(</span><span class="s">"Hello %s!"</span><span class="p">,</span><span class="w"> </span><span class="s">"world"</span><span class="p">);</span>
<span class="n">RAFT_LOG_WARN</span><span class="p">(</span><span class="s">"Hello %s!"</span><span class="p">,</span><span class="w"> </span><span class="s">"world"</span><span class="p">);</span>
<span class="n">RAFT_LOG_ERROR</span><span class="p">(</span><span class="s">"Hello %s!"</span><span class="p">,</span><span class="w"> </span><span class="s">"world"</span><span class="p">);</span>
<span class="n">RAFT_LOG_CRITICAL</span><span class="p">(</span><span class="s">"Hello %s!"</span><span class="p">,</span><span class="w"> </span><span class="s">"world"</span><span class="p">);</span>
</pre></div>
</div>
</section>
<section id="changing-logging-level">
<h3>Changing logging level<a class="headerlink" href="#changing-logging-level" title="Permalink to this heading">#</a></h3>
<p>There are 7 logging levels with each successive level becoming quieter:</p>
<ol class="simple">
<li><p>RAFT_LEVEL_TRACE</p></li>
<li><p>RAFT_LEVEL_DEBUG</p></li>
<li><p>RAFT_LEVEL_INFO</p></li>
<li><p>RAFT_LEVEL_WARN</p></li>
<li><p>RAFT_LEVEL_ERROR</p></li>
<li><p>RAFT_LEVEL_CRITICAL</p></li>
<li><p>RAFT_LEVEL_OFF
Pass one of these as per your needs into the <code class="docutils literal notranslate"><span class="pre">set_level()</span></code> method as follows:</p></li>
</ol>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">raft</span><span class="o">::</span><span class="n">logger</span><span class="o">::</span><span class="n">get</span><span class="p">.</span><span class="n">set_level</span><span class="p">(</span><span class="n">RAFT_LEVEL_WARN</span><span class="p">);</span>
<span class="c1">// From now onwards, this will print only WARN and above kind of messages</span>
</pre></div>
</div>
</section>
<section id="changing-logging-pattern">
<h3>Changing logging pattern<a class="headerlink" href="#changing-logging-pattern" title="Permalink to this heading">#</a></h3>
<p>Pass the <a class="reference external" href="https://github.com/gabime/spdlog/wiki/3.-Custom-formatting">format string</a> as follows in order use a different logging pattern than the default.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">raft</span><span class="o">::</span><span class="n">logger</span><span class="o">::</span><span class="n">get</span><span class="p">.</span><span class="n">set_pattern</span><span class="p">(</span><span class="n">YourFavoriteFormat</span><span class="p">);</span>
</pre></div>
</div>
<p>One can also use the corresponding <code class="docutils literal notranslate"><span class="pre">get_pattern()</span></code> method to know the current format as well.</p>
</section>
<section id="temporarily-changing-the-logging-pattern">
<h3>Temporarily changing the logging pattern<a class="headerlink" href="#temporarily-changing-the-logging-pattern" title="Permalink to this heading">#</a></h3>
<p>Sometimes, we need to temporarily change the log pattern (eg: for reporting decision tree structure). This can be achieved in a RAII-like approach as follows:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">  </span><span class="n">PatternSetter</span><span class="w"> </span><span class="nf">_</span><span class="p">(</span><span class="n">MyNewTempFormat</span><span class="p">);</span>
<span class="w">  </span><span class="c1">// new log format is in effect from here onwards</span>
<span class="w">  </span><span class="n">doStuff</span><span class="p">();</span>
<span class="w">  </span><span class="c1">// once the above temporary object goes out-of-scope, the old format will be restored</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="tips">
<h3>Tips<a class="headerlink" href="#tips" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p>Do NOT end your logging messages with a newline! It is automatically added by spdlog.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">RAFT_LOG_TRACE()</span></code> is by default not compiled due to the <code class="docutils literal notranslate"><span class="pre">RAFT_ACTIVE_LEVEL</span></code> macro setup, for performance reasons. If you need it to be enabled, change this macro accordingly during compilation time</p></li>
</ul>
</section>
</section>
<section id="common-design-considerations">
<h2>Common Design Considerations<a class="headerlink" href="#common-design-considerations" title="Permalink to this heading">#</a></h2>
<ol class="simple">
<li><p>Use the <code class="docutils literal notranslate"><span class="pre">hpp</span></code> extension for files which can be compiled with <code class="docutils literal notranslate"><span class="pre">gcc</span></code> against the CUDA-runtime. Use the <code class="docutils literal notranslate"><span class="pre">cuh</span></code> extension for files which require <code class="docutils literal notranslate"><span class="pre">nvcc</span></code> to be compiled. <code class="docutils literal notranslate"><span class="pre">hpp</span></code> can also be used for functions marked <code class="docutils literal notranslate"><span class="pre">__host__</span> <span class="pre">__device__</span></code> only if proper checks are in place to remove the <code class="docutils literal notranslate"><span class="pre">__device__</span></code> designation when not compiling with <code class="docutils literal notranslate"><span class="pre">nvcc</span></code>.</p></li>
<li><p>When additional classes, structs, or general POCO types are needed to be used for representing data in the public API, place them in a new file called <code class="docutils literal notranslate"><span class="pre">&lt;primitive_name&gt;_types.hpp</span></code>. This tells users they are safe to expose these types on their own public APIs without bringing in device code. At a minimum, the definitions for these types, at least, should not require <code class="docutils literal notranslate"><span class="pre">nvcc</span></code>. In general, these classes should only store very simple state and should not perform their own computations. Instead, new functions should be exposed on the public API which accept these objects, reading or updating their state as necessary.</p></li>
<li><p>Documentation for public APIs should be well documented, easy to use, and it is highly preferred that they include usage instructions.</p></li>
<li><p>Before creating a new primitive, check to see if one exists already. If one exists but the API isn&rsquo;t flexible enough to include your use-case, consider first refactoring the existing primitive. If that is not possible without an extreme number of changes, consider how the public API could be made more flexible. If the new primitive is different enough from all existing primitives, consider whether an existing public API could invoke the new primitive as an option or argument. If the new primitive is different enough from what exists already, add a header for the new public API function to the appropriate subdirectory and namespace.</p></li>
</ol>
</section>
<section id="testing">
<h2>Testing<a class="headerlink" href="#testing" title="Permalink to this heading">#</a></h2>
<p>It&rsquo;s important for RAFT to maintain a high test coverage of the public APIs in order to minimize the potential for downstream projects to encounter unexpected build or runtime behavior as a result of changes.</p>
<p>A well-defined public API can help maintain compile-time stability but means more focus should be placed on testing the functional requirements and verifying execution on the various edge cases within RAFT itself. Ideally, bug fixes and new features should be able to be made to RAFT independently of the consuming projects.</p>
</section>
<section id="documentation">
<h2>Documentation<a class="headerlink" href="#documentation" title="Permalink to this heading">#</a></h2>
<p>Public APIs always require documentation since those will be exposed directly to users. For C++, we use <a class="reference external" href="http://www.doxygen.nl">doxygen</a> and for Python/cython we use <a class="reference external" href="https://docs.python.org/3/library/pydoc.html">pydoc</a>. In addition to summarizing the purpose of each class / function in the public API, the arguments (and relevant templates) should be documented along with brief usage examples.</p>
</section>
<section id="asynchronous-operations-and-stream-ordering">
<h2>Asynchronous operations and stream ordering<a class="headerlink" href="#asynchronous-operations-and-stream-ordering" title="Permalink to this heading">#</a></h2>
<p>All RAFT algorithms should be as asynchronous as possible avoiding the use of the default stream (aka as NULL or <code class="docutils literal notranslate"><span class="pre">0</span></code> stream). Implementations that require only one CUDA Stream should use the stream from <code class="docutils literal notranslate"><span class="pre">raft::resources</span></code>:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;raft/core/resources.hpp&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;raft/core/resource/cuda_stream.hpp&gt;</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">foo</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">raft</span><span class="o">::</span><span class="n">resources</span><span class="o">&amp;</span><span class="w"> </span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="p">...)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">cudaStream_t</span><span class="w"> </span><span class="n">stream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_cuda_stream</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>When multiple streams are needed, e.g. to manage a pipeline, use the internal streams available in <code class="docutils literal notranslate"><span class="pre">raft::resources</span></code> (see <a class="reference external" href="#cuda-resources">CUDA Resources</a>). If multiple streams are used all operations still must be ordered according to <code class="docutils literal notranslate"><span class="pre">raft::resource::get_cuda_stream()</span></code> (from <code class="docutils literal notranslate"><span class="pre">raft/core/resource/cuda_stream.hpp</span></code>). Before any operation in any of the internal CUDA streams is started, all previous work in <code class="docutils literal notranslate"><span class="pre">raft::resource::get_cuda_stream()</span></code> must have completed. Any work enqueued in <code class="docutils literal notranslate"><span class="pre">raft::resource::get_cuda_stream()</span></code> after a RAFT function returns should not start before all work enqueued in the internal streams has completed. E.g. if a RAFT algorithm is called like this:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;raft/core/resources.hpp&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;raft/core/resource/cuda_stream.hpp&gt;</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">foo</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="o">*</span><span class="w"> </span><span class="n">srcdata</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="o">*</span><span class="w"> </span><span class="n">result</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">cudaStream_t</span><span class="w"> </span><span class="n">stream</span><span class="p">;</span>
<span class="w">    </span><span class="n">CUDA_RT_CALL</span><span class="p">(</span><span class="w"> </span><span class="n">cudaStreamCreate</span><span class="p">(</span><span class="w"> </span><span class="o">&amp;</span><span class="n">stream</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">);</span>
<span class="w">    </span><span class="n">raft</span><span class="o">::</span><span class="n">resources</span><span class="w"> </span><span class="n">res</span><span class="p">;</span>
<span class="w">    </span><span class="n">set_cuda_stream</span><span class="p">(</span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="n">stream</span><span class="p">);</span>
<span class="w">    </span>
<span class="w">    </span><span class="p">...</span>
<span class="w">    </span>
<span class="w">    </span><span class="n">RAFT_CUDA_TRY</span><span class="p">(</span><span class="w"> </span><span class="n">cudaMemcpyAsync</span><span class="p">(</span><span class="w"> </span><span class="n">srcdata</span><span class="p">,</span><span class="w"> </span><span class="n">h_srcdata</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span><span class="w"> </span><span class="n">n</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">),</span><span class="w"> </span><span class="n">cudaMemcpyHostToDevice</span><span class="p">,</span><span class="w"> </span><span class="n">stream</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">);</span>

<span class="w">    </span><span class="n">raft</span><span class="o">::</span><span class="n">algo</span><span class="p">(</span><span class="n">raft</span><span class="o">::</span><span class="n">resources</span><span class="p">,</span><span class="w"> </span><span class="n">dopredict</span><span class="p">,</span><span class="w"> </span><span class="n">srcdata</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p">,</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="p">);</span>

<span class="w">    </span><span class="n">RAFT_CUDA_TRY</span><span class="p">(</span><span class="w"> </span><span class="n">cudaMemcpyAsync</span><span class="p">(</span><span class="w"> </span><span class="n">h_result</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span><span class="w"> </span><span class="n">result</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span><span class="w"> </span><span class="n">cudaMemcpyDeviceToHost</span><span class="p">,</span><span class="w"> </span><span class="n">stream</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">);</span>

<span class="w">    </span><span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>No work in any stream should start in <code class="docutils literal notranslate"><span class="pre">raft::algo</span></code> before the <code class="docutils literal notranslate"><span class="pre">cudaMemcpyAsync</span></code> in <code class="docutils literal notranslate"><span class="pre">stream</span></code> launched before the call to <code class="docutils literal notranslate"><span class="pre">raft::algo</span></code> is done. And all work in all streams used in <code class="docutils literal notranslate"><span class="pre">raft::algo</span></code> should be done before the <code class="docutils literal notranslate"><span class="pre">cudaMemcpyAsync</span></code> in <code class="docutils literal notranslate"><span class="pre">stream</span></code> launched after the call to <code class="docutils literal notranslate"><span class="pre">raft::algo</span></code> starts.</p>
<p>This can be ensured by introducing interstream dependencies with CUDA events and <code class="docutils literal notranslate"><span class="pre">cudaStreamWaitEvent</span></code>. For convenience, the header <code class="docutils literal notranslate"><span class="pre">raft/core/device_resources.hpp</span></code> provides the class <code class="docutils literal notranslate"><span class="pre">raft::stream_syncer</span></code> which lets all <code class="docutils literal notranslate"><span class="pre">raft::resources</span></code> internal CUDA streams wait on <code class="docutils literal notranslate"><span class="pre">raft::resource::get_cuda_stream()</span></code> in its constructor and in its destructor and lets <code class="docutils literal notranslate"><span class="pre">raft::resource::get_cuda_stream()</span></code> wait on all work enqueued in the <code class="docutils literal notranslate"><span class="pre">raft::resources</span></code> internal CUDA streams. The intended use would be to create a <code class="docutils literal notranslate"><span class="pre">raft::stream_syncer</span></code> object as the first thing in an entry function of the public RAFT API:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">namespace</span><span class="w"> </span><span class="nn">raft</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="kt">void</span><span class="w"> </span><span class="nf">algo</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">raft</span><span class="o">::</span><span class="n">resources</span><span class="o">&amp;</span><span class="w"> </span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="p">...)</span>
<span class="w">   </span><span class="p">{</span>
<span class="w">       </span><span class="n">raft</span><span class="o">::</span><span class="n">streamSyncer</span><span class="w"> </span><span class="n">_</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
<span class="w">   </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This ensures the stream ordering behavior described above.</p>
<section id="using-thrust">
<h3>Using Thrust<a class="headerlink" href="#using-thrust" title="Permalink to this heading">#</a></h3>
<p>To ensure that thrust algorithms are executed in the intended stream the <code class="docutils literal notranslate"><span class="pre">thrust::cuda::par</span></code> execution policy should be used. To ensure that thrust algorithms allocate temporary memory via the provided device memory allocator, use the <code class="docutils literal notranslate"><span class="pre">rmm::exec_policy</span></code> available in <code class="docutils literal notranslate"><span class="pre">raft/core/resource/thrust_policy.hpp</span></code>, which can be used through <code class="docutils literal notranslate"><span class="pre">raft::resources</span></code>:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;raft/core/resources.hpp&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;raft/core/resource/thrust_policy.hpp&gt;</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">foo</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">raft</span><span class="o">::</span><span class="n">resources</span><span class="o">&amp;</span><span class="w"> </span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="p">...)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">execution_policy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_thrust_policy</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
<span class="w">    </span><span class="n">thrust</span><span class="o">::</span><span class="n">for_each</span><span class="p">(</span><span class="n">execution_policy</span><span class="p">,</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="resource-management">
<h2>Resource Management<a class="headerlink" href="#resource-management" title="Permalink to this heading">#</a></h2>
<p>Do not create reusable CUDA resources directly in implementations of RAFT algorithms. Instead, use the existing resources in <code class="docutils literal notranslate"><span class="pre">raft::resources</span></code> to avoid constant creation and deletion of reusable resources such as CUDA streams, CUDA events or library handles. Please file a feature request if a resource handle is missing in <code class="docutils literal notranslate"><span class="pre">raft::resources</span></code>.
The resources can be obtained like this</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;raft/core/resources.hpp&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;raft/core/resource/cublas_handle.hpp&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;raft/core/resource/cuda_stream_pool.hpp&gt;</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">foo</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">raft</span><span class="o">::</span><span class="n">resources</span><span class="o">&amp;</span><span class="w"> </span><span class="n">h</span><span class="p">,</span><span class="w"> </span><span class="p">...)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">cublasHandle_t</span><span class="w"> </span><span class="n">cublasHandle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_cublas_handle</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">num_streams</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="n">get_stream_pool_size</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">stream_idx</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="p">...</span>
<span class="w">    </span><span class="n">cudaStream_t</span><span class="w"> </span><span class="n">stream</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="n">get_stream_from_stream_pool</span><span class="p">(</span><span class="n">stream_idx</span><span class="p">);</span>
<span class="w">    </span><span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The example below shows one way to create <code class="docutils literal notranslate"><span class="pre">n_stream</span></code> number of internal cuda streams with an <code class="docutils literal notranslate"><span class="pre">rmm::stream_pool</span></code> which can later be used by the algos inside RAFT.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;raft/core/resources.hpp&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;raft/core/resource/cuda_stream_pool.hpp&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;rmm/cuda_stream_pool.hpp&gt;</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="o">**</span><span class="w"> </span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">n_streams</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">argc</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="n">raft</span><span class="o">::</span><span class="n">resources</span><span class="w"> </span><span class="n">res</span><span class="p">;</span>
<span class="w">    </span><span class="n">set_cuda_stream_pool</span><span class="p">(</span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">rmm</span><span class="o">::</span><span class="n">cuda_stream_pool</span><span class="o">&gt;</span><span class="p">(</span><span class="n">n_streams</span><span class="p">));</span>

<span class="w">    </span><span class="n">foo</span><span class="p">(</span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="p">...);</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="multi-gpu">
<h2>Multi-GPU<a class="headerlink" href="#multi-gpu" title="Permalink to this heading">#</a></h2>
<p>The multi-GPU paradigm of RAFT is <strong>O</strong>ne <strong>P</strong>rocess per <strong>G</strong>PU (OPG). Each algorithm should be implemented in a way that it can run with a single GPU without any specific dependencies to a particular communication library. A multi-GPU implementation should use the methods offered by the class <code class="docutils literal notranslate"><span class="pre">raft::comms::comms_t</span></code> from [raft/core/comms.hpp] for inter-rank/GPU communication. It is the responsibility of the user of cuML to create an initialized instance of <code class="docutils literal notranslate"><span class="pre">raft::comms::comms_t</span></code>.</p>
<p>E.g. with a CUDA-aware MPI, a RAFT user could use code like this to inject an initialized instance of <code class="docutils literal notranslate"><span class="pre">raft::comms::mpi_comms</span></code> into a <code class="docutils literal notranslate"><span class="pre">raft::resources</span></code>:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;mpi.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;raft/core/device_resources.hpp&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;raft/comms/mpi_comms.hpp&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;raft/algo.hpp&gt;</span>
<span class="p">...</span>
<span class="kt">int</span><span class="w"> </span><span class="n">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">MPI_Init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">argv</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">rank</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="w">    </span><span class="n">MPI_Comm_rank</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">rank</span><span class="p">);</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">local_rank</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">MPI_Comm</span><span class="w"> </span><span class="n">local_comm</span><span class="p">;</span>
<span class="w">        </span><span class="n">MPI_Comm_split_type</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_COMM_TYPE_SHARED</span><span class="p">,</span><span class="w"> </span><span class="n">rank</span><span class="p">,</span><span class="w"> </span><span class="n">MPI_INFO_NULL</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">local_comm</span><span class="p">);</span>

<span class="w">        </span><span class="n">MPI_Comm_rank</span><span class="p">(</span><span class="n">local_comm</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">local_rank</span><span class="p">);</span>

<span class="w">        </span><span class="n">MPI_Comm_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local_comm</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">cudaSetDevice</span><span class="p">(</span><span class="n">local_rank</span><span class="p">);</span>

<span class="w">    </span><span class="n">mpi_comms</span><span class="w"> </span><span class="n">raft_mpi_comms</span><span class="p">;</span>
<span class="w">    </span><span class="n">MPI_Comm_dup</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">raft_mpi_comms</span><span class="p">);</span>

<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">raft</span><span class="o">::</span><span class="n">device_resources</span><span class="w"> </span><span class="n">res</span><span class="p">;</span>
<span class="w">        </span><span class="n">initialize_mpi_comms</span><span class="p">(</span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="n">raft_mpi_comms</span><span class="p">);</span>

<span class="w">        </span><span class="p">...</span>

<span class="w">        </span><span class="n">raft</span><span class="o">::</span><span class="n">algo</span><span class="p">(</span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">MPI_Comm_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">raft_mpi_comms</span><span class="p">);</span>

<span class="w">    </span><span class="n">MPI_Finalize</span><span class="p">();</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>A RAFT developer can assume the following:</p>
<ul class="simple">
<li><p>A instance of <code class="docutils literal notranslate"><span class="pre">raft::comms::comms_t</span></code> was correctly initialized.</p></li>
<li><p>All processes that are part of <code class="docutils literal notranslate"><span class="pre">raft::comms::comms_t</span></code> call into the RAFT algorithm cooperatively.</p></li>
</ul>
<p>The initialized instance of <code class="docutils literal notranslate"><span class="pre">raft::comms::comms_t</span></code> can be accessed from the <code class="docutils literal notranslate"><span class="pre">raft::resources</span></code> instance:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;raft/core/resources.hpp&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;raft/core/resource/comms.hpp&gt;</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">foo</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">raft</span><span class="o">::</span><span class="n">resources</span><span class="o">&amp;</span><span class="w"> </span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="p">...)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">raft</span><span class="o">::</span><span class="n">comms_t</span><span class="o">&amp;</span><span class="w"> </span><span class="n">communicator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_comms</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">rank</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">communicator</span><span class="p">.</span><span class="n">get_rank</span><span class="p">();</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">communicator</span><span class="p">.</span><span class="n">get_size</span><span class="p">();</span>
<span class="w">    </span><span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>


            </article>
            
            
            
            <footer class="bd-footer-article">
                <!-- Previous / next buttons -->
<div class="prev-next-area">
  <a class="left-prev" href="build.html" id="prev-link" title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
          <p class="prev-next-subtitle">previous</p>
          <p class="prev-next-title">Installation</p>
      </div>
  </a>
  <a class="right-next" href="cpp_api.html" id="next-link" title="next page">
  <div class="prev-next-info">
      <p class="prev-next-subtitle">next</p>
      <p class="prev-next-title">C++ API</p>
  </div>
  <i class="fa-solid fa-angle-right"></i>
  </a>
</div>
            </footer>
            
          </div>
          
          
          
            <div class="bd-sidebar-secondary bd-toc">
              
<div class="toc-item">
  
<div class="tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
</div>
<nav class="page-toc" id="bd-toc-nav">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#general">
   General
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#performance">
   Performance
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#local-development">
   Local Development
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#threading-model">
   Threading Model
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#public-interface">
   Public Interface
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#general-guidelines">
     General guidelines
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#api-stability">
     API stability
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#stateless-c-apis">
     Stateless C++ APIs
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#other-functions-on-state">
     Other functions on state
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#coding-style">
   Coding style
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code-format">
     Code format
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#introduction">
       Introduction
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#how-is-the-check-done">
       How is the check done?
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#as-part-of-ci">
         As part of CI
        </a>
       </li>
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#manually">
         Manually
        </a>
       </li>
      </ul>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#how-to-know-the-formatting-violations">
       How to know the formatting violations?
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#how-to-fix-the-formatting-violations">
       How to fix the formatting violations?
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#clang-format-version">
       clang-format version?
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#additional-scripts">
       Additional scripts
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#include-style">
         #include style
        </a>
       </li>
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#copyright-header">
         Copyright header
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#error-handling">
   Error handling
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#logging">
   Logging
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id1">
     Introduction
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#usage">
     Usage
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#changing-logging-level">
     Changing logging level
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#changing-logging-pattern">
     Changing logging pattern
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#temporarily-changing-the-logging-pattern">
     Temporarily changing the logging pattern
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#tips">
     Tips
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#common-design-considerations">
   Common Design Considerations
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#testing">
   Testing
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#documentation">
   Documentation
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#asynchronous-operations-and-stream-ordering">
   Asynchronous operations and stream ordering
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#using-thrust">
     Using Thrust
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#resource-management">
   Resource Management
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#multi-gpu">
   Multi-GPU
  </a>
 </li>
</ul>

</nav>
</div>

<div class="toc-item">
  
<div id="searchbox"></div>
</div>

<div class="toc-item">
  
</div>

<div class="toc-item">
  
<div class="tocsection sourcelink">
    <a href="_sources/developer_guide.md.txt">
        <i class="fa-solid fa-file-lines"></i> Show Source
    </a>
</div>

</div>

            </div>
          
          
        </div>
        <footer class="bd-footer-content">
          <div class="bd-footer-content__inner">
            
          </div>
        </footer>
        
      </main>
    </div>
  </div>

  
    
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=796348d33e8b1d947c94"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=796348d33e8b1d947c94"></script>

  <footer class="bd-footer"><div class="bd-footer__inner container">
  
  <div class="footer-item">
    
<p class="copyright">

    &copy; Copyright 2023, NVIDIA Corporation.<br>

</p>

  </div>
  
  <div class="footer-item">
    <p class="theme-version">
    Built with the
    <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">
        PyData Sphinx Theme
    </a>
    0.12.0.
</p>
  </div>
  
  <div class="footer-item">
    
<p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 5.3.0.<br>
</p>

  </div>
  
</div>
  </footer>
  
<script defer id="rapids-selector-js" src="/assets/js/custom.js"></script><script id="rapids-selector-pixel-invocation" type="text/javascript">_satellite.pageBottom();</script></body></html>