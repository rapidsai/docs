<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport"><meta content="Docutils 0.18.1: http://docutils.sourceforge.net/" name="generator">

    <title>Using RAFT Comms &mdash; raft 23.04.00 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet">
<link href="_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet">
<link href="_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet">

  
  <link href="_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet">
  <link as="font" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" rel="preload" type="font/woff2">
<link as="font" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" rel="preload" type="font/woff2">
<link as="font" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" rel="preload" type="font/woff2">

    <link href="_static/pygments.css" rel="stylesheet" type="text/css">
    <link href="_static/copybutton.css" rel="stylesheet" type="text/css">
    <link href="_static/references.css" rel="stylesheet" type="text/css">
    <link href="https://docs.rapids.ai/assets/css/custom.css" rel="stylesheet" type="text/css">
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link as="script" href="_static/scripts/bootstrap.js?digest=e353d410970836974a52" rel="preload">
<link as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" rel="preload">

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/sphinx_highlight.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script defer="defer" src="https://docs.rapids.ai/assets/js/custom.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'using_comms';</script>
    <link href="genindex.html" rel="index" title="Index">
    <link href="search.html" rel="search" title="Search">
    <link href="using_libraft.html" rel="next" title="Using The Pre-Compiled Binary">
    <link href="raft_dask_api.html" rel="prev" title="RAFT Dask API">
  <meta content="width=device-width, initial-scale=1" name="viewport">
  <meta content="en" name="docsearch:language">
  <script id="rapids-selector-pixel-src" src="https://assets.adobedtm.com/5d4962a43b79/814eb6e9b4e1/launch-4bc07f1e0b0b.min.js"></script><link href="/assets/css/custom.css" id="rapids-selector-css" rel="stylesheet"></head>
  
  
  <body data-bs-root-margin="0px 0px -60%" data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-default-mode data-offset="180">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input class="sidebar-toggle" id="__primary" name="__primary" type="checkbox">
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input class="sidebar-toggle" id="__secondary" name="__secondary" type="checkbox">
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form action="search.html" class="bd-search d-flex align-items-center" method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input aria-label="Search the docs ..." autocapitalize="off" autocomplete="off" autocorrect="off" class="form-control" id="search-input" name="q" placeholder="Search the docs ..." spellcheck="false" type="search">
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
<div class="bd-header__inner bd-page-width">
  <label class="sidebar-toggle primary-toggle" for="__primary">
    <span class="fa-solid fa-bars"></span>
  </label>
  
  <div class="navbar-header-items__start">
    
      <div class="navbar-item">
  

<a class="navbar-brand logo" href="index.html">
  
  
  
  
  
    <p class="title logo__title">raft 23.04.00 documentation</p>
  
</a></div>
    
  </div>
  
  
  <div class="navbar-header-items">
    
    <div class="ms-auto navbar-header-items__center">
      
        <div class="navbar-item"><nav class="navbar-nav">
  <p aria-label="Site Navigation" aria-level="1" class="sidebar-header-items__title" role="heading">
    Site Navigation
  </p>
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="quick_start.html">
                        Quick Start
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="build.html">
                        Installation
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="developer_guide.html">
                        Developer Guide
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="cpp_api.html">
                        C++ API
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="pylibraft_api.html">
                        Python API
                      </a>
                    </li>
                
            <div class="nav-item dropdown">
                <button aria-expanded="false" aria-haspopup="true" class="btn dropdown-toggle nav-item" data-bs-toggle="dropdown" type="button">
                    More
                </button>
                <div class="dropdown-menu">
                    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="cuda_ann_benchmarks.html">
                        CUDA ANN Benchmarks
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="raft_dask_api.html">
                        RAFT Dask API
                      </a>
                    </li>
                

                    <li class="nav-item current active">
                      <a class="nav-link nav-internal" href="#">
                        Using RAFT Comms
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="using_libraft.html">
                        Using The Pre-Compiled Binary
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="contributing.html">
                        Contributing
                      </a>
                    </li>
                
                </div>
            </div>
            
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          
<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
        </div>
      
      
        <div class="navbar-item">
<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script></div>
      
        <div class="navbar-item"><ul aria-label="Icon Links" class="navbar-icon-links navbar-nav">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a class="nav-link" data-bs-placement="bottom" data-bs-toggle="tooltip" href="https://github.com/rapidsai/raft" rel="noopener" target="_blank" title="GitHub"><span><i class="fa-brands fa-square-github"></i></span>
            <label class="sr-only">GitHub</label></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a class="nav-link" data-bs-placement="bottom" data-bs-toggle="tooltip" href="https://twitter.com/rapidsai" rel="noopener" target="_blank" title="Twitter"><span><i class="fa-brands fa-square-twitter"></i></span>
            <label class="sr-only">Twitter</label></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">
<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
    </div>
  

  
    <label class="sidebar-toggle secondary-toggle" for="__secondary">
      <span class="fa-solid fa-outdent"></span>
    </label>
  
</div>

    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar hide-on-wide"><div id="rapids-pydata-container"><div class="rapids-home-container"><a class="rapids-home-container__home-btn" href="/api">Home</a></div><div class="rapids-selector__container rapids-selector--hidden"><div class="rapids-selector__selected">raft</div><div class="rapids-selector__menu"><a class="rapids-selector__menu-item" href="/api/clx/stable/api.html">clx</a><a class="rapids-selector__menu-item" href="/api/cucim/stable/api.html">cucim</a><a class="rapids-selector__menu-item" href="/api/cudf/stable/index.html">cudf</a><a class="rapids-selector__menu-item" href="/api/cudf-java/stable">cudf-java</a><a class="rapids-selector__menu-item" href="/api/cugraph/stable">cugraph</a><a class="rapids-selector__menu-item" href="/api/cuml/stable/api.html">cuml</a><a class="rapids-selector__menu-item" href="/api/cusignal/stable/api.html">cusignal</a><a class="rapids-selector__menu-item" href="/api/cuspatial/stable">cuspatial</a><a class="rapids-selector__menu-item" href="/api/cuxfilter/stable">cuxfilter</a><a class="rapids-selector__menu-item" href="/api/dask-cuda/stable/api.html">dask-cuda</a><a class="rapids-selector__menu-item" href="/api/kvikio/stable/api.html">kvikio</a><a class="rapids-selector__menu-item" href="/api/libcudf/stable/namespacecudf.html">libcudf</a><a class="rapids-selector__menu-item" href="/api/libcugraph/stable">libcugraph</a><a class="rapids-selector__menu-item" href="/api/libcuml/stable">libcuml</a><a class="rapids-selector__menu-item" href="/api/libcuspatial/stable">libcuspatial</a><a class="rapids-selector__menu-item" href="/api/libkvikio/stable">libkvikio</a><a class="rapids-selector__menu-item" href="/api/librmm/stable/annotated.html">librmm</a><a class="rapids-selector__menu-item rapids-selector__menu-item--selected" href="/api/raft/stable">raft</a><a class="rapids-selector__menu-item" href="/api/rapids-cmake/stable/api.html">rapids-cmake</a><a class="rapids-selector__menu-item" href="/api/rmm/stable/api.html">rmm</a></div></div><div class="rapids-selector__container rapids-selector--hidden"><div class="rapids-selector__selected">nightly (23.04)</div><div class="rapids-selector__menu"><a class="rapids-selector__menu-item rapids-selector__menu-item--selected" href="/api/raft/nightly">nightly (23.04)</a><a class="rapids-selector__menu-item" href="/api/raft/stable">stable (23.02)</a><a class="rapids-selector__menu-item" href="/api/raft/legacy">legacy (22.12)</a></div></div></div>
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          <div class="navbar-item"><nav class="navbar-nav">
  <p aria-label="Site Navigation" aria-level="1" class="sidebar-header-items__title" role="heading">
    Site Navigation
  </p>
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="quick_start.html">
                        Quick Start
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="build.html">
                        Installation
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="developer_guide.html">
                        Developer Guide
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="cpp_api.html">
                        C++ API
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="pylibraft_api.html">
                        Python API
                      </a>
                    </li>
                
            <div class="nav-item dropdown">
                <button aria-expanded="false" aria-haspopup="true" class="btn dropdown-toggle nav-item" data-bs-toggle="dropdown" type="button">
                    More
                </button>
                <div class="dropdown-menu">
                    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="cuda_ann_benchmarks.html">
                        CUDA ANN Benchmarks
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="raft_dask_api.html">
                        RAFT Dask API
                      </a>
                    </li>
                

                    <li class="nav-item current active">
                      <a class="nav-link nav-internal" href="#">
                        Using RAFT Comms
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="using_libraft.html">
                        Using The Pre-Compiled Binary
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="contributing.html">
                        Contributing
                      </a>
                    </li>
                
                </div>
            </div>
            
  </ul>
</nav></div>
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">
<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script></div>
        
          <div class="navbar-item"><ul aria-label="Icon Links" class="navbar-icon-links navbar-nav">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a class="nav-link" data-bs-placement="bottom" data-bs-toggle="tooltip" href="https://github.com/rapidsai/raft" rel="noopener" target="_blank" title="GitHub"><span><i class="fa-brands fa-square-github"></i></span>
            <label class="sr-only">GitHub</label></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a class="nav-link" data-bs-placement="bottom" data-bs-toggle="tooltip" href="https://twitter.com/rapidsai" rel="noopener" target="_blank" title="Twitter"><span><i class="fa-brands fa-square-twitter"></i></span>
            <label class="sr-only">Twitter</label></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main class="bd-main" id="main-content">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumbs">
  <ul aria-label="Breadcrumb" class="bd-breadcrumbs" role="navigation">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a aria-label="Home" class="nav-link" href="index.html">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    <li aria-current="page" class="breadcrumb-item active">Using RAFT Comms</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section id="using-raft-comms">
<h1>Using RAFT Comms<a class="headerlink" href="#using-raft-comms" title="Permalink to this heading">#</a></h1>
<p>RAFT provides a communications abstraction for writing distributed algorithms which can scale up to multiple GPUs and scale out to multiple nodes. The communications abstraction is largely based on MPI and NCCL, and allows the user to decouple the design of algorithms from the environments where the algorithms are executed, enabling &ldquo;write-once deploy everywhere&rdquo; semantics. Currently, the distributed algorithms in both cuGraph and cuML are being deployed in both MPI and Dask clusters while cuML&rsquo;s distributed algorithms are also being deployed on GPUs in Apache Spark clusters. This is a powerful concept as distributed algorithms can be non-trivial to write and so maintainability is eased and bug fixes reach further by increasing reuse as much as possible.</p>
<p>While users of RAFT&rsquo;s communications layer largely get MPI integration for free just by installing MPI and using <code class="xref py py-obj docutils literal notranslate"><span class="pre">mpirun</span></code> to run their applications, the <code class="xref py py-obj docutils literal notranslate"><span class="pre">raft-dask</span></code> Python package provides a mechanism for executing algorithms written using RAFT&rsquo;s communications layer in a Dask cluster. It will help to walk through a small example of how one would build an algorithm with RAFT&rsquo;s communications layer.</p>
<p>First, an instance of <code class="xref py py-obj docutils literal notranslate"><span class="pre">raft::comms_t</span></code> is passed through the <code class="xref py py-obj docutils literal notranslate"><span class="pre">raft::device_resources</span></code> instance and code is written to utilize collective and/or point-to-point communications as needed.</p>
<div class="literal-block-wrapper docutils container" id="id1">
<div class="code-block-caption"><span class="caption-text">Example function written with the RAFT comms API</span><a class="headerlink" href="#id1" title="Permalink to this code">#</a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;raft/core/comms.hpp&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;raft/core/device_mdspan.hpp&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;raft/util/cudart_utils.hpp&gt;</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">test_allreduce</span><span class="p">(</span><span class="n">raft</span><span class="o">::</span><span class="n">device_resources</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">&amp;</span><span class="n">handle</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">root</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">raft</span><span class="o">::</span><span class="n">comms</span><span class="o">::</span><span class="n">comms_t</span><span class="w"> </span><span class="k">const</span><span class="o">&amp;</span><span class="w"> </span><span class="n">communicator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">handle</span><span class="p">.</span><span class="n">get_comms</span><span class="p">();</span>
<span class="w">  </span><span class="n">cudaStream_t</span><span class="w"> </span><span class="n">stream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">handle</span><span class="p">.</span><span class="n">get_stream</span><span class="p">();</span>
<span class="w">  </span><span class="n">raft</span><span class="o">::</span><span class="n">device_scalar</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">temp_scalar</span><span class="p">(</span><span class="n">stream</span><span class="p">);</span>

<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">to_send</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">  </span><span class="n">raft</span><span class="o">::</span><span class="n">copy</span><span class="p">(</span><span class="n">temp_scalar</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">to_send</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">stream</span><span class="p">);</span>
<span class="w">  </span><span class="n">communicator</span><span class="p">.</span><span class="n">allreduce</span><span class="p">(</span><span class="n">temp_scalar</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span><span class="w"> </span><span class="n">temp_scalar</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">                         </span><span class="n">raft</span><span class="o">::</span><span class="n">comms</span><span class="o">::</span><span class="n">opt_t</span><span class="o">::</span><span class="n">SUM</span><span class="p">,</span><span class="w"> </span><span class="n">stream</span><span class="p">);</span>
<span class="w">  </span><span class="n">handle</span><span class="p">.</span><span class="n">sync_stream</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<p>This exact function can now be executed in several different types of GPU clusters. For example, it can be executed with MPI by initializing an instance of <code class="xref py py-obj docutils literal notranslate"><span class="pre">raft::comms::mpi_comms</span></code> with the <code class="xref py py-obj docutils literal notranslate"><span class="pre">MPI_Comm</span></code>:</p>
<div class="literal-block-wrapper docutils container" id="id2">
<div class="code-block-caption"><span class="caption-text">Example of running test_allreduce() in MPI</span><a class="headerlink" href="#id2" title="Permalink to this code">#</a></div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;raft/core/mpi_comms.hpp&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;raft/core/device_resources.hpp&gt;</span>

<span class="n">raft</span><span class="o">::</span><span class="n">device_resources</span><span class="w"> </span><span class="n">resource_handle</span><span class="p">;</span>
<span class="c1">// ...</span>
<span class="c1">// initialize MPI_Comm</span>
<span class="c1">// ...</span>
<span class="n">raft</span><span class="o">::</span><span class="n">comms</span><span class="o">::</span><span class="n">initialize_mpi_comms</span><span class="p">(</span><span class="n">resource_handle</span><span class="p">,</span><span class="w">  </span><span class="n">mpi_comm</span><span class="p">);</span>
<span class="c1">// ...</span>
<span class="n">test_allreduce</span><span class="p">(</span><span class="n">resource_handle</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</pre></div>
</div>
</div>
<p>Deploying our`test_allreduce` function in Dask requires a lightweight Python interface, which we can accomplish using <code class="xref py py-obj docutils literal notranslate"><span class="pre">pylibraft</span></code> and exposing the function through Cython:</p>
<div class="literal-block-wrapper docutils container" id="id3">
<div class="code-block-caption"><span class="caption-text">Example of wrapping test_allreduce() w/ cython</span><a class="headerlink" href="#id3" title="Permalink to this code">#</a></div>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span>from pylibraft.common.handle cimport device_resources
from cython.operator cimport dereference as deref

cdef extern from &ldquo;allreduce_test.hpp&rdquo;:
    void test_allreduce(device_resources const &amp;handle, int root) except +

def run_test_allreduce(handle, root):
    cdef const device_resources* h = &lt;device_resources*&gt;&lt;size_t&gt;handle.getHandle()

test_allreduce(deref(h), root)
</pre></div>
</div>
</div>
<p>Finally, we can use <code class="xref py py-obj docutils literal notranslate"><span class="pre">raft_dask</span></code> to execute our new algorithm in a Dask cluster (please note this also uses <code class="xref py py-obj docutils literal notranslate"><span class="pre">LocalCUDACluster</span></code> from the RAPIDS dask-cuda library):</p>
<div class="literal-block-wrapper docutils container" id="id4">
<div class="code-block-caption"><span class="caption-text">Example of running test_allreduce() in Dask</span><a class="headerlink" href="#id4" title="Permalink to this code">#</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">raft_dask.common</span> <span class="kn">import</span> <span class="n">Comms</span><span class="p">,</span> <span class="n">local_handle</span>
<span class="kn">from</span> <span class="nn">dask.distributed</span> <span class="kn">import</span> <span class="n">Client</span><span class="p">,</span> <span class="n">wait</span>
<span class="kn">from</span> <span class="nn">dask_cuda</span> <span class="kn">import</span> <span class="n">LocalCUDACluster</span>
<span class="n">cluster</span> <span class="o">=</span> <span class="n">LocalCUDACluster</span><span class="p">()</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span>

<span class="c1"># Create and initialize Comms instance</span>
<span class="n">comms</span> <span class="o">=</span> <span class="n">Comms</span><span class="p">(</span><span class="n">client</span><span class="o">=</span><span class="n">client</span><span class="p">)</span>
<span class="n">comms</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">func_run_allreduce</span><span class="p">(</span><span class="n">sessionId</span><span class="p">,</span> <span class="n">root</span><span class="p">):</span>
  <span class="n">handle</span> <span class="o">=</span> <span class="n">local_handle</span><span class="p">(</span><span class="n">sessionId</span><span class="p">)</span>
  <span class="n">run_test_allreduce</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">root</span><span class="p">)</span>

<span class="c1"># Invoke run_test_allreduce on all workers</span>
<span class="n">dfs</span> <span class="o">=</span> <span class="p">[</span>
  <span class="n">client</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span>
    <span class="n">func_run_allreduce</span><span class="p">,</span>
    <span class="n">comms</span><span class="o">.</span><span class="n">sessionId</span><span class="p">,</span>
    <span class="mi">0</span><span class="p">,</span>
    <span class="n">pure</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">workers</span><span class="o">=</span><span class="p">[</span><span class="n">w</span><span class="p">]</span>
  <span class="p">)</span>
  <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">comms</span><span class="o">.</span><span class="n">worker_addresses</span>
<span class="p">]</span>

<span class="c1"># Wait until processing is done</span>
<span class="n">wait</span><span class="p">(</span><span class="n">dfs</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

<span class="n">comms</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
<span class="n">client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="n">cluster</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
</section>


                </article>
              
              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev" href="raft_dask_api.html" title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">RAFT Dask API</p>
      </div>
    </a>
    <a class="right-next" href="using_libraft.html" title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Using The Pre-Compiled Binary</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="tocsection sourcelink">
    <a href="_sources/using_comms.rst.txt">
      <i class="fa-solid fa-file-lines"></i> Show Source
    </a>
  </div>
</div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">
  <p class="copyright">
    
      &copy; Copyright 2023, NVIDIA Corporation.
      <br>
    
  </p>
</div>
      
        <div class="footer-item">
  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 5.3.0.
    <br>
  </p>
</div>
      
    </div>
  
  
    <div class="footer-items__end">
      
        <div class="footer-item"><p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.13.3.
</p></div>
      
    </div>
  
</div>

  </footer>
  
<script defer id="rapids-selector-js" src="/assets/js/custom.js"></script><script id="rapids-selector-pixel-invocation" type="text/javascript">_satellite.pageBottom();</script></body></html>