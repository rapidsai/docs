
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>How to Setup InfiniBand on Azure &#8212; RAPIDS Deployment Documentation  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=796348d33e8b1d947c94" rel="stylesheet">
<link href="../../_static/styles/bootstrap.css?digest=796348d33e8b1d947c94" rel="stylesheet">
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=796348d33e8b1d947c94" rel="stylesheet">

  
  <link href="../../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=796348d33e8b1d947c94" rel="stylesheet">
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2">
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2">
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="https://docs.rapids.ai/assets/css/custom.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/custom.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=796348d33e8b1d947c94">
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=796348d33e8b1d947c94">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script defer="defer" src="https://docs.rapids.ai/assets/js/custom.js"></script>
    <script defer="defer" src="../../_static/js/nav.js"></script>
    <script defer="defer" src="../../_static/js/notebook-gallery.js"></script>
    <script src="../../_static/design-tabs.js"></script>
    <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({startOnLoad:true});</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'guides/azure/infiniband';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Does the Dask scheduler need a GPU?" href="../scheduler-gpu-requirements.html" />
    <link rel="prev" title="Multi-Instance GPU (MIG)" href="../mig.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="docsearch:language" content="en">
  </head>
  
  
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="180" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>

  
  <input type="checkbox" class="sidebar-toggle" name="__primary" id="__primary">
  <label class="overlay overlay-primary" for="__primary"></label>

  
  <input type="checkbox" class="sidebar-toggle" name="__secondary" id="__secondary">
  <label class="overlay overlay-secondary" for="__secondary"></label>

  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
      
<form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
    </div>
  </div>

  
  <nav class="bd-header navbar navbar-expand-lg bd-navbar" id="navbar-main"><div class="bd-header__inner bd-page-width">
  <label class="sidebar-toggle primary-toggle" for="__primary">
      <span class="fa-solid fa-bars"></span>
  </label>
  <div id="navbar-start">
    
    
   


<a class="navbar-brand logo" href="https://docs.rapids.ai/">

  
  
  
  
  
  
  

  
    <img src="../../_static/RAPIDS-logo-purple.png" class="logo__image only-light" alt="Logo image">
    <img src="../../_static/RAPIDS-logo-purple.png" class="logo__image only-dark" alt="Logo image">
  
  
</a>
    
  </div>

  
  <div class=" navbar-header-items">
    <div id="navbar-center" class="ml-auto">
      
      <div class="navbar-center-item">
        <nav class="navbar-nav">
    <p class="sidebar-header-items__title" role="heading" aria-level="1" aria-label="Site Navigation">
        Site Navigation
    </p>
    <ul id="navbar-main-elements" class="navbar-nav">
        
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../local.html">
                        Local
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../cloud/index.html">
                        Cloud
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../hpc.html">
                        HPC
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../platforms/index.html">
                        Platforms
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../tools/index.html">
                        Tools
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../examples/index.html">
                        Workflow Examples
                      </a>
                    </li>
                

                    <li class="nav-item current active">
                      <a class="nav-link nav-internal" href="../index.html">
                        Guides
                      </a>
                    </li>
                
    </ul>
</nav>
      </div>
      
    </div>

    <div id="navbar-end">
      
        <div class="navbar-end-item navbar-persistent--container">
          
<button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-toggle="tooltip">
  <i class="fa-solid fa-magnifying-glass"></i>
</button>
        </div>
      
      
      <div class="navbar-end-item">
        <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
</button>
      </div>
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          <a href="https://github.com/rapidsai/" title="GitHub" class="nav-link" rel="noopener" target="_blank" data-toggle="tooltip"><span><i class="fa-brands fa-square-github"></i></span>
            <label class="sr-only">GitHub</label></a>
        </li>
      </ul>
      </div>
      
    </div>
  </div>


  
  
    <div class="navbar-persistent--mobile">
<button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-toggle="tooltip">
  <i class="fa-solid fa-magnifying-glass"></i>
</button>
    </div>
  

  
  <label class="sidebar-toggle secondary-toggle" for="__secondary">
      <span class="fa-solid fa-outdent"></span>
  </label>
  

</div>
  </nav>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        
  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
      
      <div class="navbar-center-item">
        <nav class="navbar-nav">
    <p class="sidebar-header-items__title" role="heading" aria-level="1" aria-label="Site Navigation">
        Site Navigation
    </p>
    <ul id="navbar-main-elements" class="navbar-nav">
        
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../local.html">
                        Local
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../cloud/index.html">
                        Cloud
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../hpc.html">
                        HPC
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../platforms/index.html">
                        Platforms
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../tools/index.html">
                        Tools
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../examples/index.html">
                        Workflow Examples
                      </a>
                    </li>
                

                    <li class="nav-item current active">
                      <a class="nav-link nav-internal" href="../index.html">
                        Guides
                      </a>
                    </li>
                
    </ul>
</nav>
      </div>
      
      </div>
    

    
    
    <div class="sidebar-header-items__end">
      
      <div class="navbar-end-item">
        <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
</button>
      </div>
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          <a href="https://github.com/rapidsai/" title="GitHub" class="nav-link" rel="noopener" target="_blank" data-toggle="tooltip"><span><i class="fa-brands fa-square-github"></i></span>
            <label class="sr-only">GitHub</label></a>
        </li>
      </ul>
      </div>
      
    </div>
    
  </div>

  
  <div class="sidebar-start-items sidebar-primary__section">
    <div class="sidebar-start-items__item"><nav class="bd-links" id="bd-docs-nav" aria-label="Section navigation">
  <p class="bd-links__title" role="heading" aria-level="1">
    Section Navigation
  </p>
  <div class="bd-toc-item navbar-nav">
    <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../mig.html">Multi-Instance GPU (MIG)</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">How to Setup InfiniBand on Azure</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scheduler-gpu-requirements.html">Does the Dask scheduler need a GPU?</a></li>
</ul>

  </div>
</nav>
    </div>
    <div class="sidebar-start-items__item">
    </div>
  </div>
  

  
  <div class="sidebar-end-items sidebar-primary__section">
    <div class="sidebar-end-items__item">
    </div>
  </div>

  
  <div id="rtd-footer-container"></div>

      </div>
      <main id="main-content" class="bd-main">
        
        
        <div class="bd-content">
          <div class="bd-article-container">
            
            <div class="bd-header-article">
                
            </div>
            
            
            <article class="bd-article" role="main">
              
  <section id="how-to-setup-infiniband-on-azure">
<h1>How to Setup InfiniBand on Azure<a class="headerlink" href="#how-to-setup-infiniband-on-azure" title="Permalink to this heading">#</a></h1>
<p><a class="reference external" href="https://learn.microsoft.com/en-us/azure/virtual-machines/sizes-gpu">Azure GPU optmized virtual machines</a> provide
a low latency and high bandwidth InfiniBand network. This guide walks through the steps to enable InfiniBand to
optimize network performance.</p>
<section id="build-a-virtual-machine">
<h2>Build a Virtual Machine<a class="headerlink" href="#build-a-virtual-machine" title="Permalink to this heading">#</a></h2>
<p>Start by creating a GPU optimized VM from the Azure portal. Below is an example that we will use
for demonstration.</p>
<ul class="simple">
<li><p>Create new VM instance.</p></li>
<li><p>Select <code class="docutils literal notranslate"><span class="pre">East</span> <span class="pre">US</span></code> region.</p></li>
<li><p>Change <code class="docutils literal notranslate"><span class="pre">Availability</span> <span class="pre">options</span></code> to <code class="docutils literal notranslate"><span class="pre">Availability</span> <span class="pre">set</span></code> and create a set.</p>
<ul>
<li><p>If building multiple instances put additional instances in the same set.</p></li>
</ul>
</li>
<li><p>Use the 2nd Gen Ubuntu 20.04 image.</p>
<ul>
<li><p>Search all images for <code class="docutils literal notranslate"><span class="pre">Ubuntu</span> <span class="pre">Server</span> <span class="pre">20.04</span></code> and choose the second one down on the list.</p></li>
</ul>
</li>
<li><p>Change size to <code class="docutils literal notranslate"><span class="pre">ND40rs_v2</span></code>.</p></li>
<li><p>Set password login with credentials.</p>
<ul>
<li><p>User <code class="docutils literal notranslate"><span class="pre">someuser</span></code></p></li>
<li><p>Password <code class="docutils literal notranslate"><span class="pre">somepassword</span></code></p></li>
</ul>
</li>
<li><p>Leave all other options as default.</p></li>
</ul>
<p>Then connect to the VM using your preferred method.</p>
</section>
<section id="install-software">
<h2>Install Software<a class="headerlink" href="#install-software" title="Permalink to this heading">#</a></h2>
<p>Before installing the drivers ensure the system is up to date.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>sudo<span class="w"> </span>apt-get<span class="w"> </span>update
sudo<span class="w"> </span>apt-get<span class="w"> </span>upgrade<span class="w"> </span>-y
</pre></div>
</div>
<section id="nvidia-drivers">
<h3>NVIDIA Drivers<a class="headerlink" href="#nvidia-drivers" title="Permalink to this heading">#</a></h3>
<p>The commands below should work for Ubuntu. See the <a class="reference external" href="https://docs.nvidia.com/cuda/index.html#installation-guides">CUDA Toolkit documentation</a> for details on installing on other operating systems.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>sudo<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>linux-headers-<span class="k">$(</span>uname<span class="w"> </span>-r<span class="k">)</span>
<span class="nv">distribution</span><span class="o">=</span><span class="k">$(</span>.<span class="w"> </span>/etc/os-release<span class="p">;</span><span class="nb">echo</span><span class="w"> </span><span class="nv">$ID$VERSION_ID</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span>-e<span class="w"> </span><span class="s1">&#39;s/\.//g&#39;</span><span class="k">)</span>
wget<span class="w"> </span>https://developer.download.nvidia.com/compute/cuda/repos/<span class="nv">$distribution</span>/x86_64/cuda-keyring_1.0-1_all.deb
sudo<span class="w"> </span>dpkg<span class="w"> </span>-i<span class="w"> </span>cuda-keyring_1.0-1_all.deb
sudo<span class="w"> </span>apt-get<span class="w"> </span>update
sudo<span class="w"> </span>apt-get<span class="w"> </span>-y<span class="w"> </span>install<span class="w"> </span>cuda-drivers
</pre></div>
</div>
<p>Restart VM instance</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>sudo<span class="w"> </span>reboot
</pre></div>
</div>
<p>Once the VM boots, reconnect and run <code class="docutils literal notranslate"><span class="pre">nvidia-smi</span></code> to verify driver installation.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>nvidia-smi
</pre></div>
</div>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>Mon<span class="w"> </span>Nov<span class="w"> </span><span class="m">14</span><span class="w"> </span><span class="m">20</span>:32:39<span class="w"> </span><span class="m">2022</span>
+-----------------------------------------------------------------------------+
<span class="p">|</span><span class="w"> </span>NVIDIA-SMI<span class="w"> </span><span class="m">520</span>.61.05<span class="w">    </span>Driver<span class="w"> </span>Version:<span class="w"> </span><span class="m">520</span>.61.05<span class="w">    </span>CUDA<span class="w"> </span>Version:<span class="w"> </span><span class="m">11</span>.8<span class="w">     </span><span class="p">|</span>
<span class="p">|</span>-------------------------------+----------------------+----------------------+
<span class="p">|</span><span class="w"> </span>GPU<span class="w">  </span>Name<span class="w">        </span>Persistence-M<span class="p">|</span><span class="w"> </span>Bus-Id<span class="w">        </span>Disp.A<span class="w"> </span><span class="p">|</span><span class="w"> </span>Volatile<span class="w"> </span>Uncorr.<span class="w"> </span>ECC<span class="w"> </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span>Fan<span class="w">  </span>Temp<span class="w">  </span>Perf<span class="w">  </span>Pwr:Usage/Cap<span class="p">|</span><span class="w">         </span>Memory-Usage<span class="w"> </span><span class="p">|</span><span class="w"> </span>GPU-Util<span class="w">  </span>Compute<span class="w"> </span>M.<span class="w"> </span><span class="p">|</span>
<span class="p">|</span><span class="w">                               </span><span class="p">|</span><span class="w">                      </span><span class="p">|</span><span class="w">               </span>MIG<span class="w"> </span>M.<span class="w"> </span><span class="p">|</span>
<span class="p">|</span><span class="o">===============================</span>+<span class="o">======================</span>+<span class="o">======================</span><span class="p">|</span>
<span class="p">|</span><span class="w">   </span><span class="m">0</span><span class="w">  </span>Tesla<span class="w"> </span>V100-SXM2...<span class="w">  </span>On<span class="w">   </span><span class="p">|</span><span class="w"> </span><span class="m">00000001</span>:00:00.0<span class="w"> </span>Off<span class="w"> </span><span class="p">|</span><span class="w">                    </span><span class="m">0</span><span class="w"> </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span>N/A<span class="w">   </span>34C<span class="w">    </span>P0<span class="w">    </span>41W<span class="w"> </span>/<span class="w"> </span>300W<span class="w"> </span><span class="p">|</span><span class="w">    </span>445MiB<span class="w"> </span>/<span class="w"> </span>32768MiB<span class="w"> </span><span class="p">|</span><span class="w">      </span><span class="m">0</span>%<span class="w">      </span>Default<span class="w"> </span><span class="p">|</span>
<span class="p">|</span><span class="w">                               </span><span class="p">|</span><span class="w">                      </span><span class="p">|</span><span class="w">                  </span>N/A<span class="w"> </span><span class="p">|</span>
+-------------------------------+----------------------+----------------------+
<span class="p">|</span><span class="w">   </span><span class="m">1</span><span class="w">  </span>Tesla<span class="w"> </span>V100-SXM2...<span class="w">  </span>On<span class="w">   </span><span class="p">|</span><span class="w"> </span><span class="m">00000002</span>:00:00.0<span class="w"> </span>Off<span class="w"> </span><span class="p">|</span><span class="w">                    </span><span class="m">0</span><span class="w"> </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span>N/A<span class="w">   </span>37C<span class="w">    </span>P0<span class="w">    </span>43W<span class="w"> </span>/<span class="w"> </span>300W<span class="w"> </span><span class="p">|</span><span class="w">      </span>4MiB<span class="w"> </span>/<span class="w"> </span>32768MiB<span class="w"> </span><span class="p">|</span><span class="w">      </span><span class="m">0</span>%<span class="w">      </span>Default<span class="w"> </span><span class="p">|</span>
<span class="p">|</span><span class="w">                               </span><span class="p">|</span><span class="w">                      </span><span class="p">|</span><span class="w">                  </span>N/A<span class="w"> </span><span class="p">|</span>
+-------------------------------+----------------------+----------------------+
<span class="p">|</span><span class="w">   </span><span class="m">2</span><span class="w">  </span>Tesla<span class="w"> </span>V100-SXM2...<span class="w">  </span>On<span class="w">   </span><span class="p">|</span><span class="w"> </span><span class="m">00000003</span>:00:00.0<span class="w"> </span>Off<span class="w"> </span><span class="p">|</span><span class="w">                    </span><span class="m">0</span><span class="w"> </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span>N/A<span class="w">   </span>34C<span class="w">    </span>P0<span class="w">    </span>42W<span class="w"> </span>/<span class="w"> </span>300W<span class="w"> </span><span class="p">|</span><span class="w">      </span>4MiB<span class="w"> </span>/<span class="w"> </span>32768MiB<span class="w"> </span><span class="p">|</span><span class="w">      </span><span class="m">0</span>%<span class="w">      </span>Default<span class="w"> </span><span class="p">|</span>
<span class="p">|</span><span class="w">                               </span><span class="p">|</span><span class="w">                      </span><span class="p">|</span><span class="w">                  </span>N/A<span class="w"> </span><span class="p">|</span>
+-------------------------------+----------------------+----------------------+
<span class="p">|</span><span class="w">   </span><span class="m">3</span><span class="w">  </span>Tesla<span class="w"> </span>V100-SXM2...<span class="w">  </span>On<span class="w">   </span><span class="p">|</span><span class="w"> </span><span class="m">00000004</span>:00:00.0<span class="w"> </span>Off<span class="w"> </span><span class="p">|</span><span class="w">                    </span><span class="m">0</span><span class="w"> </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span>N/A<span class="w">   </span>35C<span class="w">    </span>P0<span class="w">    </span>44W<span class="w"> </span>/<span class="w"> </span>300W<span class="w"> </span><span class="p">|</span><span class="w">      </span>4MiB<span class="w"> </span>/<span class="w"> </span>32768MiB<span class="w"> </span><span class="p">|</span><span class="w">      </span><span class="m">0</span>%<span class="w">      </span>Default<span class="w"> </span><span class="p">|</span>
<span class="p">|</span><span class="w">                               </span><span class="p">|</span><span class="w">                      </span><span class="p">|</span><span class="w">                  </span>N/A<span class="w"> </span><span class="p">|</span>
+-------------------------------+----------------------+----------------------+
<span class="p">|</span><span class="w">   </span><span class="m">4</span><span class="w">  </span>Tesla<span class="w"> </span>V100-SXM2...<span class="w">  </span>On<span class="w">   </span><span class="p">|</span><span class="w"> </span><span class="m">00000005</span>:00:00.0<span class="w"> </span>Off<span class="w"> </span><span class="p">|</span><span class="w">                    </span><span class="m">0</span><span class="w"> </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span>N/A<span class="w">   </span>35C<span class="w">    </span>P0<span class="w">    </span>41W<span class="w"> </span>/<span class="w"> </span>300W<span class="w"> </span><span class="p">|</span><span class="w">      </span>4MiB<span class="w"> </span>/<span class="w"> </span>32768MiB<span class="w"> </span><span class="p">|</span><span class="w">      </span><span class="m">0</span>%<span class="w">      </span>Default<span class="w"> </span><span class="p">|</span>
<span class="p">|</span><span class="w">                               </span><span class="p">|</span><span class="w">                      </span><span class="p">|</span><span class="w">                  </span>N/A<span class="w"> </span><span class="p">|</span>
+-------------------------------+----------------------+----------------------+
<span class="p">|</span><span class="w">   </span><span class="m">5</span><span class="w">  </span>Tesla<span class="w"> </span>V100-SXM2...<span class="w">  </span>On<span class="w">   </span><span class="p">|</span><span class="w"> </span><span class="m">00000006</span>:00:00.0<span class="w"> </span>Off<span class="w"> </span><span class="p">|</span><span class="w">                    </span><span class="m">0</span><span class="w"> </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span>N/A<span class="w">   </span>36C<span class="w">    </span>P0<span class="w">    </span>43W<span class="w"> </span>/<span class="w"> </span>300W<span class="w"> </span><span class="p">|</span><span class="w">      </span>4MiB<span class="w"> </span>/<span class="w"> </span>32768MiB<span class="w"> </span><span class="p">|</span><span class="w">      </span><span class="m">0</span>%<span class="w">      </span>Default<span class="w"> </span><span class="p">|</span>
<span class="p">|</span><span class="w">                               </span><span class="p">|</span><span class="w">                      </span><span class="p">|</span><span class="w">                  </span>N/A<span class="w"> </span><span class="p">|</span>
+-------------------------------+----------------------+----------------------+
<span class="p">|</span><span class="w">   </span><span class="m">6</span><span class="w">  </span>Tesla<span class="w"> </span>V100-SXM2...<span class="w">  </span>On<span class="w">   </span><span class="p">|</span><span class="w"> </span><span class="m">00000007</span>:00:00.0<span class="w"> </span>Off<span class="w"> </span><span class="p">|</span><span class="w">                    </span><span class="m">0</span><span class="w"> </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span>N/A<span class="w">   </span>37C<span class="w">    </span>P0<span class="w">    </span>44W<span class="w"> </span>/<span class="w"> </span>300W<span class="w"> </span><span class="p">|</span><span class="w">      </span>4MiB<span class="w"> </span>/<span class="w"> </span>32768MiB<span class="w"> </span><span class="p">|</span><span class="w">      </span><span class="m">0</span>%<span class="w">      </span>Default<span class="w"> </span><span class="p">|</span>
<span class="p">|</span><span class="w">                               </span><span class="p">|</span><span class="w">                      </span><span class="p">|</span><span class="w">                  </span>N/A<span class="w"> </span><span class="p">|</span>
+-------------------------------+----------------------+----------------------+
<span class="p">|</span><span class="w">   </span><span class="m">7</span><span class="w">  </span>Tesla<span class="w"> </span>V100-SXM2...<span class="w">  </span>On<span class="w">   </span><span class="p">|</span><span class="w"> </span><span class="m">00000008</span>:00:00.0<span class="w"> </span>Off<span class="w"> </span><span class="p">|</span><span class="w">                    </span><span class="m">0</span><span class="w"> </span><span class="p">|</span>
<span class="p">|</span><span class="w"> </span>N/A<span class="w">   </span>38C<span class="w">    </span>P0<span class="w">    </span>44W<span class="w"> </span>/<span class="w"> </span>300W<span class="w"> </span><span class="p">|</span><span class="w">      </span>4MiB<span class="w"> </span>/<span class="w"> </span>32768MiB<span class="w"> </span><span class="p">|</span><span class="w">      </span><span class="m">0</span>%<span class="w">      </span>Default<span class="w"> </span><span class="p">|</span>
<span class="p">|</span><span class="w">                               </span><span class="p">|</span><span class="w">                      </span><span class="p">|</span><span class="w">                  </span>N/A<span class="w"> </span><span class="p">|</span>
+-------------------------------+----------------------+----------------------+

+-----------------------------------------------------------------------------+
<span class="p">|</span><span class="w"> </span>Processes:<span class="w">                                                                  </span><span class="p">|</span>
<span class="p">|</span><span class="w">  </span>GPU<span class="w">   </span>GI<span class="w">   </span>CI<span class="w">        </span>PID<span class="w">   </span>Type<span class="w">   </span>Process<span class="w"> </span>name<span class="w">                  </span>GPU<span class="w"> </span>Memory<span class="w"> </span><span class="p">|</span>
<span class="p">|</span><span class="w">        </span>ID<span class="w">   </span>ID<span class="w">                                                   </span>Usage<span class="w">      </span><span class="p">|</span>
<span class="p">|</span><span class="o">=============================================================================</span><span class="p">|</span>
<span class="p">|</span><span class="w">    </span><span class="m">0</span><span class="w">   </span>N/A<span class="w">  </span>N/A<span class="w">      </span><span class="m">1396</span><span class="w">      </span>G<span class="w">   </span>/usr/lib/xorg/Xorg<span class="w">                </span>427MiB<span class="w"> </span><span class="p">|</span>
<span class="p">|</span><span class="w">    </span><span class="m">0</span><span class="w">   </span>N/A<span class="w">  </span>N/A<span class="w">      </span><span class="m">1762</span><span class="w">      </span>G<span class="w">   </span>/usr/bin/gnome-shell<span class="w">               </span>16MiB<span class="w"> </span><span class="p">|</span>
<span class="p">|</span><span class="w">    </span><span class="m">1</span><span class="w">   </span>N/A<span class="w">  </span>N/A<span class="w">      </span><span class="m">1396</span><span class="w">      </span>G<span class="w">   </span>/usr/lib/xorg/Xorg<span class="w">                  </span>4MiB<span class="w"> </span><span class="p">|</span>
<span class="p">|</span><span class="w">    </span><span class="m">2</span><span class="w">   </span>N/A<span class="w">  </span>N/A<span class="w">      </span><span class="m">1396</span><span class="w">      </span>G<span class="w">   </span>/usr/lib/xorg/Xorg<span class="w">                  </span>4MiB<span class="w"> </span><span class="p">|</span>
<span class="p">|</span><span class="w">    </span><span class="m">3</span><span class="w">   </span>N/A<span class="w">  </span>N/A<span class="w">      </span><span class="m">1396</span><span class="w">      </span>G<span class="w">   </span>/usr/lib/xorg/Xorg<span class="w">                  </span>4MiB<span class="w"> </span><span class="p">|</span>
<span class="p">|</span><span class="w">    </span><span class="m">4</span><span class="w">   </span>N/A<span class="w">  </span>N/A<span class="w">      </span><span class="m">1396</span><span class="w">      </span>G<span class="w">   </span>/usr/lib/xorg/Xorg<span class="w">                  </span>4MiB<span class="w"> </span><span class="p">|</span>
<span class="p">|</span><span class="w">    </span><span class="m">5</span><span class="w">   </span>N/A<span class="w">  </span>N/A<span class="w">      </span><span class="m">1396</span><span class="w">      </span>G<span class="w">   </span>/usr/lib/xorg/Xorg<span class="w">                  </span>4MiB<span class="w"> </span><span class="p">|</span>
<span class="p">|</span><span class="w">    </span><span class="m">6</span><span class="w">   </span>N/A<span class="w">  </span>N/A<span class="w">      </span><span class="m">1396</span><span class="w">      </span>G<span class="w">   </span>/usr/lib/xorg/Xorg<span class="w">                  </span>4MiB<span class="w"> </span><span class="p">|</span>
<span class="p">|</span><span class="w">    </span><span class="m">7</span><span class="w">   </span>N/A<span class="w">  </span>N/A<span class="w">      </span><span class="m">1396</span><span class="w">      </span>G<span class="w">   </span>/usr/lib/xorg/Xorg<span class="w">                  </span>4MiB<span class="w"> </span><span class="p">|</span>
+-----------------------------------------------------------------------------+
</pre></div>
</div>
</section>
<section id="infiniband-driver">
<h3>InfiniBand Driver<a class="headerlink" href="#infiniband-driver" title="Permalink to this heading">#</a></h3>
<p>On Ubuntu 20.04</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>sudo<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>automake<span class="w"> </span>dh-make<span class="w"> </span>git<span class="w"> </span>libcap2<span class="w"> </span>libnuma-dev<span class="w"> </span>libtool<span class="w"> </span>make<span class="w"> </span>pkg-config<span class="w"> </span>udev<span class="w"> </span>curl<span class="w"> </span>librdmacm-dev<span class="w"> </span>rdma-core<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>libgfortran5<span class="w"> </span>bison<span class="w"> </span>chrpath<span class="w"> </span>flex<span class="w"> </span>graphviz<span class="w"> </span>gfortran<span class="w"> </span>tk<span class="w"> </span>dpatch<span class="w"> </span>quilt<span class="w"> </span>swig<span class="w"> </span>tcl<span class="w"> </span>ibverbs-utils
</pre></div>
</div>
<p>Check install</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>ibv_devinfo
</pre></div>
</div>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>hca_id:<span class="w"> </span>mlx5_0
<span class="w">        </span>transport:<span class="w">                      </span>InfiniBand<span class="w"> </span><span class="o">(</span><span class="m">0</span><span class="o">)</span>
<span class="w">        </span>fw_ver:<span class="w">                         </span><span class="m">16</span>.28.4000
<span class="w">        </span>node_guid:<span class="w">                      </span><span class="m">0015</span>:5dff:fe33:ff2c
<span class="w">        </span>sys_image_guid:<span class="w">                 </span>0c42:a103:00b3:2f68
<span class="w">        </span>vendor_id:<span class="w">                      </span>0x02c9
<span class="w">        </span>vendor_part_id:<span class="w">                 </span><span class="m">4120</span>
<span class="w">        </span>hw_ver:<span class="w">                         </span>0x0
<span class="w">        </span>board_id:<span class="w">                       </span>MT_0000000010
<span class="w">        </span>phys_port_cnt:<span class="w">                  </span><span class="m">1</span>
<span class="w">                </span>port:<span class="w">   </span><span class="m">1</span>
<span class="w">                        </span>state:<span class="w">                  </span>PORT_ACTIVE<span class="w"> </span><span class="o">(</span><span class="m">4</span><span class="o">)</span>
<span class="w">                        </span>max_mtu:<span class="w">                </span><span class="m">4096</span><span class="w"> </span><span class="o">(</span><span class="m">5</span><span class="o">)</span>
<span class="w">                        </span>active_mtu:<span class="w">             </span><span class="m">4096</span><span class="w"> </span><span class="o">(</span><span class="m">5</span><span class="o">)</span>
<span class="w">                        </span>sm_lid:<span class="w">                 </span><span class="m">7</span>
<span class="w">                        </span>port_lid:<span class="w">               </span><span class="m">115</span>
<span class="w">                        </span>port_lmc:<span class="w">               </span>0x00
<span class="w">                        </span>link_layer:<span class="w">             </span>InfiniBand

hca_id:<span class="w"> </span>rdmaP36305p0s2
<span class="w">        </span>transport:<span class="w">                      </span>InfiniBand<span class="w"> </span><span class="o">(</span><span class="m">0</span><span class="o">)</span>
<span class="w">        </span>fw_ver:<span class="w">                         </span><span class="m">2</span>.43.7008
<span class="w">        </span>node_guid:<span class="w">                      </span><span class="m">6045</span>:bdff:feed:8445
<span class="w">        </span>sys_image_guid:<span class="w">                 </span>043f:7203:0003:d583
<span class="w">        </span>vendor_id:<span class="w">                      </span>0x02c9
<span class="w">        </span>vendor_part_id:<span class="w">                 </span><span class="m">4100</span>
<span class="w">        </span>hw_ver:<span class="w">                         </span>0x0
<span class="w">        </span>board_id:<span class="w">                       </span>MT_1090111019
<span class="w">        </span>phys_port_cnt:<span class="w">                  </span><span class="m">1</span>
<span class="w">                </span>port:<span class="w">   </span><span class="m">1</span>
<span class="w">                        </span>state:<span class="w">                  </span>PORT_ACTIVE<span class="w"> </span><span class="o">(</span><span class="m">4</span><span class="o">)</span>
<span class="w">                        </span>max_mtu:<span class="w">                </span><span class="m">4096</span><span class="w"> </span><span class="o">(</span><span class="m">5</span><span class="o">)</span>
<span class="w">                        </span>active_mtu:<span class="w">             </span><span class="m">1024</span><span class="w"> </span><span class="o">(</span><span class="m">3</span><span class="o">)</span>
<span class="w">                        </span>sm_lid:<span class="w">                 </span><span class="m">0</span>
<span class="w">                        </span>port_lid:<span class="w">               </span><span class="m">0</span>
<span class="w">                        </span>port_lmc:<span class="w">               </span>0x00
<span class="w">                        </span>link_layer:<span class="w">             </span>Ethernet
</pre></div>
</div>
<section id="enable-ipoib">
<h4>Enable IPoIB<a class="headerlink" href="#enable-ipoib" title="Permalink to this heading">#</a></h4>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>sudo<span class="w"> </span>sed<span class="w"> </span>-i<span class="w"> </span>-e<span class="w"> </span><span class="s1">&#39;s/# OS.EnableRDMA=y/OS.EnableRDMA=y/g&#39;</span><span class="w"> </span>/etc/waagent.conf
</pre></div>
</div>
<p>Reboot and reconnect.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>sudo<span class="w"> </span>reboot
</pre></div>
</div>
</section>
<section id="check-ib">
<h4>Check IB<a class="headerlink" href="#check-ib" title="Permalink to this heading">#</a></h4>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>ip<span class="w"> </span>addr<span class="w"> </span>show
</pre></div>
</div>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="m">1</span>:<span class="w"> </span>lo:<span class="w"> </span>&lt;LOOPBACK,UP,LOWER_UP&gt;<span class="w"> </span>mtu<span class="w"> </span><span class="m">65536</span><span class="w"> </span>qdisc<span class="w"> </span>noqueue<span class="w"> </span>state<span class="w"> </span>UNKNOWN<span class="w"> </span>group<span class="w"> </span>default<span class="w"> </span>qlen<span class="w"> </span><span class="m">1000</span>
<span class="w">    </span>link/loopback<span class="w"> </span><span class="m">00</span>:00:00:00:00:00<span class="w"> </span>brd<span class="w"> </span><span class="m">00</span>:00:00:00:00:00
<span class="w">    </span>inet<span class="w"> </span><span class="m">127</span>.0.0.1/8<span class="w"> </span>scope<span class="w"> </span>host<span class="w"> </span>lo
<span class="w">       </span>valid_lft<span class="w"> </span>forever<span class="w"> </span>preferred_lft<span class="w"> </span>forever
<span class="w">    </span>inet6<span class="w"> </span>::1/128<span class="w"> </span>scope<span class="w"> </span>host
<span class="w">       </span>valid_lft<span class="w"> </span>forever<span class="w"> </span>preferred_lft<span class="w"> </span>forever
<span class="m">2</span>:<span class="w"> </span>eth0:<span class="w"> </span>&lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;<span class="w"> </span>mtu<span class="w"> </span><span class="m">1500</span><span class="w"> </span>qdisc<span class="w"> </span>mq<span class="w"> </span>state<span class="w"> </span>UP<span class="w"> </span>group<span class="w"> </span>default<span class="w"> </span>qlen<span class="w"> </span><span class="m">1000</span>
<span class="w">    </span>link/ether<span class="w"> </span><span class="m">60</span>:45:bd:a7:42:cc<span class="w"> </span>brd<span class="w"> </span>ff:ff:ff:ff:ff:ff
<span class="w">    </span>inet<span class="w"> </span><span class="m">10</span>.6.0.5/24<span class="w"> </span>brd<span class="w"> </span><span class="m">10</span>.6.0.255<span class="w"> </span>scope<span class="w"> </span>global<span class="w"> </span>eth0
<span class="w">       </span>valid_lft<span class="w"> </span>forever<span class="w"> </span>preferred_lft<span class="w"> </span>forever
<span class="w">    </span>inet6<span class="w"> </span>fe80::6245:bdff:fea7:42cc/64<span class="w"> </span>scope<span class="w"> </span>link
<span class="w">       </span>valid_lft<span class="w"> </span>forever<span class="w"> </span>preferred_lft<span class="w"> </span>forever
<span class="m">3</span>:<span class="w"> </span>eth1:<span class="w"> </span>&lt;BROADCAST,MULTICAST&gt;<span class="w"> </span>mtu<span class="w"> </span><span class="m">1500</span><span class="w"> </span>qdisc<span class="w"> </span>noop<span class="w"> </span>state<span class="w"> </span>DOWN<span class="w"> </span>group<span class="w"> </span>default<span class="w"> </span>qlen<span class="w"> </span><span class="m">1000</span>
<span class="w">    </span>link/ether<span class="w"> </span><span class="m">00</span>:15:5d:33:ff:16<span class="w"> </span>brd<span class="w"> </span>ff:ff:ff:ff:ff:ff
<span class="m">4</span>:<span class="w"> </span>enP44906s1:<span class="w"> </span>&lt;BROADCAST,MULTICAST,SLAVE,UP,LOWER_UP&gt;<span class="w"> </span>mtu<span class="w"> </span><span class="m">1500</span><span class="w"> </span>qdisc<span class="w"> </span>mq<span class="w"> </span>master<span class="w"> </span>eth0<span class="w"> </span>state<span class="w"> </span>UP<span class="w"> </span>group<span class="w"> </span>default<span class="w"> </span>qlen<span class="w"> </span><span class="m">1000</span>
<span class="w">    </span>link/ether<span class="w"> </span><span class="m">60</span>:45:bd:a7:42:cc<span class="w"> </span>brd<span class="w"> </span>ff:ff:ff:ff:ff:ff
<span class="w">    </span>altname<span class="w"> </span>enP44906p0s2
<span class="m">5</span>:<span class="w"> </span>ibP59423s2:<span class="w"> </span>&lt;BROADCAST,MULTICAST&gt;<span class="w"> </span>mtu<span class="w"> </span><span class="m">4092</span><span class="w"> </span>qdisc<span class="w"> </span>noop<span class="w"> </span>state<span class="w"> </span>DOWN<span class="w"> </span>group<span class="w"> </span>default<span class="w"> </span>qlen<span class="w"> </span><span class="m">256</span>
<span class="w">    </span>link/infiniband<span class="w"> </span><span class="m">00</span>:00:09:27:fe:80:00:00:00:00:00:00:00:15:5d:ff:fd:33:ff:16<span class="w"> </span>brd<span class="w"> </span><span class="m">00</span>:ff:ff:ff:ff:12:40:1b:80:1d:00:00:00:00:00:00:ff:ff:ff:ff
<span class="w">    </span>altname<span class="w"> </span>ibP59423p0s2
</pre></div>
</div>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>nvidia-smi<span class="w"> </span>topo<span class="w"> </span>-m
</pre></div>
</div>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="w">        </span>GPU0<span class="w">  </span>GPU1<span class="w">  </span>GPU2<span class="w">  </span>GPU3<span class="w">  </span>GPU4<span class="w">  </span>GPU5<span class="w">  </span>GPU6<span class="w">  </span>GPU7<span class="w">  </span>mlx5_0<span class="w">  </span>CPU<span class="w"> </span>Affinity<span class="w">  </span>NUMA<span class="w"> </span>Affinity
GPU0<span class="w">    </span>X<span class="w">     </span>NV2<span class="w">   </span>NV1<span class="w">   </span>NV2<span class="w">   </span>NODE<span class="w">  </span>NODE<span class="w">  </span>NV1<span class="w">   </span>NODE<span class="w">  </span>NODE<span class="w">    </span><span class="m">0</span>-19<span class="w">          </span><span class="m">0</span>
GPU1<span class="w">    </span>NV2<span class="w">   </span>X<span class="w">     </span>NV2<span class="w">   </span>NV1<span class="w">   </span>NODE<span class="w">  </span>NODE<span class="w">  </span>NODE<span class="w">  </span>NV1<span class="w">   </span>NODE<span class="w">    </span><span class="m">0</span>-19<span class="w">          </span><span class="m">0</span>
GPU2<span class="w">    </span>NV1<span class="w">   </span>NV2<span class="w">   </span>X<span class="w">     </span>NV1<span class="w">   </span>NV2<span class="w">   </span>NODE<span class="w">  </span>NODE<span class="w">  </span>NODE<span class="w">  </span>NODE<span class="w">    </span><span class="m">0</span>-19<span class="w">          </span><span class="m">0</span>
GPU3<span class="w">    </span>NV2<span class="w">   </span>NV1<span class="w">   </span>NV1<span class="w">   </span>X<span class="w">     </span>NODE<span class="w">  </span>NV2<span class="w">   </span>NODE<span class="w">  </span>NODE<span class="w">  </span>NODE<span class="w">    </span><span class="m">0</span>-19<span class="w">          </span><span class="m">0</span>
GPU4<span class="w">    </span>NODE<span class="w">  </span>NODE<span class="w">  </span>NV2<span class="w">   </span>NODE<span class="w">  </span>X<span class="w">     </span>NV1<span class="w">   </span>NV1<span class="w">   </span>NV2<span class="w">   </span>NODE<span class="w">    </span><span class="m">0</span>-19<span class="w">          </span><span class="m">0</span>
GPU5<span class="w">    </span>NODE<span class="w">  </span>NODE<span class="w">  </span>NODE<span class="w">  </span>NV2<span class="w">   </span>NV1<span class="w">   </span>X<span class="w">     </span>NV2<span class="w">   </span>NV1<span class="w">   </span>NODE<span class="w">    </span><span class="m">0</span>-19<span class="w">          </span><span class="m">0</span>
GPU6<span class="w">    </span>NV1<span class="w">   </span>NODE<span class="w">  </span>NODE<span class="w">  </span>NODE<span class="w">  </span>NV1<span class="w">   </span>NV2<span class="w">   </span>X<span class="w">     </span>NV2<span class="w">   </span>NODE<span class="w">    </span><span class="m">0</span>-19<span class="w">          </span><span class="m">0</span>
GPU7<span class="w">    </span>NODE<span class="w">  </span>NV1<span class="w">   </span>NODE<span class="w">  </span>NODE<span class="w">  </span>NV2<span class="w">   </span>NV1<span class="w">   </span>NV2<span class="w">   </span>X<span class="w">     </span>NODE<span class="w">    </span><span class="m">0</span>-19<span class="w">          </span><span class="m">0</span>
mlx5_0<span class="w">  </span>NODE<span class="w">  </span>NODE<span class="w">  </span>NODE<span class="w">  </span>NODE<span class="w">  </span>NODE<span class="w">  </span>NODE<span class="w">  </span>NODE<span class="w">  </span>NODE<span class="w">  </span>X

Legend:

<span class="w">  </span><span class="nv">X</span><span class="w">    </span><span class="o">=</span><span class="w"> </span>Self
<span class="w">  </span><span class="nv">SYS</span><span class="w">  </span><span class="o">=</span><span class="w"> </span>Connection<span class="w"> </span>traversing<span class="w"> </span>PCIe<span class="w"> </span>as<span class="w"> </span>well<span class="w"> </span>as<span class="w"> </span>the<span class="w"> </span>SMP<span class="w"> </span>interconnect<span class="w"> </span>between<span class="w"> </span>NUMA<span class="w"> </span>nodes<span class="w"> </span><span class="o">(</span>e.g.,<span class="w"> </span>QPI/UPI<span class="o">)</span>
<span class="w">  </span><span class="nv">NODE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Connection<span class="w"> </span>traversing<span class="w"> </span>PCIe<span class="w"> </span>as<span class="w"> </span>well<span class="w"> </span>as<span class="w"> </span>the<span class="w"> </span>interconnect<span class="w"> </span>between<span class="w"> </span>PCIe<span class="w"> </span>Host<span class="w"> </span>Bridges<span class="w"> </span>within<span class="w"> </span>a<span class="w"> </span>NUMA<span class="w"> </span>node
<span class="w">  </span><span class="nv">PHB</span><span class="w">  </span><span class="o">=</span><span class="w"> </span>Connection<span class="w"> </span>traversing<span class="w"> </span>PCIe<span class="w"> </span>as<span class="w"> </span>well<span class="w"> </span>as<span class="w"> </span>a<span class="w"> </span>PCIe<span class="w"> </span>Host<span class="w"> </span>Bridge<span class="w"> </span><span class="o">(</span>typically<span class="w"> </span>the<span class="w"> </span>CPU<span class="o">)</span>
<span class="w">  </span><span class="nv">PXB</span><span class="w">  </span><span class="o">=</span><span class="w"> </span>Connection<span class="w"> </span>traversing<span class="w"> </span>multiple<span class="w"> </span>PCIe<span class="w"> </span>bridges<span class="w"> </span><span class="o">(</span>without<span class="w"> </span>traversing<span class="w"> </span>the<span class="w"> </span>PCIe<span class="w"> </span>Host<span class="w"> </span>Bridge<span class="o">)</span>
<span class="w">  </span><span class="nv">PIX</span><span class="w">  </span><span class="o">=</span><span class="w"> </span>Connection<span class="w"> </span>traversing<span class="w"> </span>at<span class="w"> </span>most<span class="w"> </span>a<span class="w"> </span>single<span class="w"> </span>PCIe<span class="w"> </span>bridge
<span class="w">  </span>NV#<span class="w">  </span><span class="o">=</span><span class="w"> </span>Connection<span class="w"> </span>traversing<span class="w"> </span>a<span class="w"> </span>bonded<span class="w"> </span><span class="nb">set</span><span class="w"> </span>of<span class="w"> </span><span class="c1"># NVLinks</span>
</pre></div>
</div>
</section>
</section>
<section id="install-ucx-py-and-tools">
<h3>Install UCX-Py and tools<a class="headerlink" href="#install-ucx-py-and-tools" title="Permalink to this heading">#</a></h3>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>wget<span class="w"> </span>https://github.com/conda-forge/miniforge/releases/latest/download/Mambaforge-Linux-x86_64.sh
bash<span class="w"> </span>Mambaforge-Linux-x86_64.sh
</pre></div>
</div>
<p>Accept the default and allow conda init to run. Then start a new shell.</p>
<p>Create a conda environment (see <a class="reference external" href="https://ucx-py.readthedocs.io/en/latest/install.html">UCX-Py</a> docs)</p>
<pre class="literal-block">mamba create -n ucxpy -c rapidsai-nightly -c conda-forge -c nvidia rapids=23.04 python=3.10 cudatoolkit=11.5 ipython ucx-proc=*=gpu ucx ucx-py dask distributed numpy cupy pytest pynvml -y
mamba activate ucxpy
</pre>
<p>Clone UCX-Py repo locally</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/rapidsai/ucx-py.git
<span class="nb">cd</span><span class="w"> </span>ucx-py
</pre></div>
</div>
</section>
<section id="run-tests">
<h3>Run Tests<a class="headerlink" href="#run-tests" title="Permalink to this heading">#</a></h3>
<p>Start by running the UCX-Py test suite, from within the <code class="docutils literal notranslate"><span class="pre">ucx-py</span></code> repo:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>pytest<span class="w"> </span>-vs<span class="w"> </span>tests/
pytest<span class="w"> </span>-vs<span class="w"> </span>ucp/_libs/tests/
</pre></div>
</div>
<p>Now check to see if InfiniBand works, for that you can run some of the benchmarks that we include in UCX-Py, for example:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># cd out of the ucx-py directory</span>
<span class="nb">cd</span><span class="w"> </span>..
<span class="c1"># Let UCX pick the best transport (expecting NVLink when available,</span>
<span class="c1"># otherwise InfiniBand, or TCP in worst case) on devices 0 and 1</span>
python<span class="w"> </span>-m<span class="w"> </span>ucp.benchmarks.send_recv<span class="w"> </span>--server-dev<span class="w"> </span><span class="m">0</span><span class="w"> </span>--client-dev<span class="w"> </span><span class="m">1</span><span class="w"> </span>-o<span class="w"> </span>rmm<span class="w"> </span>--reuse-alloc<span class="w"> </span>-n<span class="w"> </span>128MiB

<span class="c1"># Force TCP-only on devices 0 and 1</span>
<span class="nv">UCX_TLS</span><span class="o">=</span>tcp,cuda_copy<span class="w"> </span>python<span class="w"> </span>-m<span class="w"> </span>ucp.benchmarks.send_recv<span class="w"> </span>--server-dev<span class="w"> </span><span class="m">0</span><span class="w"> </span>--client-dev<span class="w"> </span><span class="m">1</span><span class="w"> </span>-o<span class="w"> </span>rmm<span class="w"> </span>--reuse-alloc<span class="w"> </span>-n<span class="w"> </span>128MiB
</pre></div>
</div>
<p>We expect the first case above to have much higher bandwidth than the second. If you happen to have both
NVLink and InfiniBand connectivity, then you may limit to the specific transport by specifying <code class="docutils literal notranslate"><span class="pre">UCX_TLS</span></code>, e.g.:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># NVLink (if available) or TCP</span>
<span class="nv">UCX_TLS</span><span class="o">=</span>tcp,cuda_copy,cuda_ipc

<span class="c1"># InfiniBand (if available) or TCP</span>
<span class="nv">UCX_TLS</span><span class="o">=</span>tcp,cuda_copy,rc
</pre></div>
</div>
</section>
</section>
<section id="run-benchmarks">
<h2>Run Benchmarks<a class="headerlink" href="#run-benchmarks" title="Permalink to this heading">#</a></h2>
<p>Finally, lets run the <a class="reference external" href="https://github.com/rapidsai/dask-cuda/blob/HEAD/dask_cuda/benchmarks/local_cudf_merge.py">merge benchmark</a> from <code class="docutils literal notranslate"><span class="pre">dask-cuda</span></code>.</p>
<p>This benchmark uses Dask to perform a merge of two dataframes that are distributed across all the available GPUs on your
VM. Merges are a challenging benchmark in a distributed setting since they require communication-intensive shuffle
operations of the participating dataframes
(see the <a class="reference external" href="https://docs.dask.org/en/stable/dataframe-best-practices.html#avoid-full-data-shuffling">Dask documentation</a>
for more on this type of operation). To perform the merge, each dataframe is shuffled such that rows with the same join
key appear on the same GPU. This results in an <a class="reference external" href="https://en.wikipedia.org/wiki/All-to-all_(parallel_pattern)">all-to-all</a>
communication pattern which requires a lot of communication between the GPUs. As a result, network
performance will be very important for the throughput of the benchmark.</p>
<p>Below we are running for devices 0 through 7 (inclusive), you will want to adjust that for the number of devices available on your VM, the default
is to run on GPU 0 only. Additionally, <code class="docutils literal notranslate"><span class="pre">--chunk-size</span> <span class="pre">100_000_000</span></code> is a safe value for 32GB GPUs, you may
adjust that proportional to the size of the GPU you have (it scales linearly, so <code class="docutils literal notranslate"><span class="pre">50_000_000</span></code> should
be good for 16GB or <code class="docutils literal notranslate"><span class="pre">150_000_000</span></code> for 48GB).</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># Default Dask TCP communication protocol</span>
python<span class="w"> </span>-m<span class="w"> </span>dask_cuda.benchmarks.local_cudf_merge<span class="w"> </span>--devs<span class="w"> </span><span class="m">0</span>,1,2,3,4,5,6,7<span class="w"> </span>--chunk-size<span class="w"> </span>100_000_000<span class="w"> </span>--no-show-p2p-bandwidth
</pre></div>
</div>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>Merge<span class="w"> </span>benchmark
--------------------------------------------------------------------------------
Backend<span class="w">                   </span><span class="p">|</span><span class="w"> </span>dask
Merge<span class="w"> </span><span class="nb">type</span><span class="w">                </span><span class="p">|</span><span class="w"> </span>gpu
Rows-per-chunk<span class="w">            </span><span class="p">|</span><span class="w"> </span><span class="m">100000000</span>
Base-chunks<span class="w">               </span><span class="p">|</span><span class="w"> </span><span class="m">8</span>
Other-chunks<span class="w">              </span><span class="p">|</span><span class="w"> </span><span class="m">8</span>
Broadcast<span class="w">                 </span><span class="p">|</span><span class="w"> </span>default
Protocol<span class="w">                  </span><span class="p">|</span><span class="w"> </span>tcp
Device<span class="o">(</span>s<span class="o">)</span><span class="w">                 </span><span class="p">|</span><span class="w"> </span><span class="m">0</span>,1,2,3,4,5,6,7
RMM<span class="w"> </span>Pool<span class="w">                  </span><span class="p">|</span><span class="w"> </span>True
Frac-match<span class="w">                </span><span class="p">|</span><span class="w"> </span><span class="m">0</span>.3
Worker<span class="w"> </span>thread<span class="o">(</span>s<span class="o">)</span><span class="w">          </span><span class="p">|</span><span class="w"> </span><span class="m">1</span>
Data<span class="w"> </span>processed<span class="w">            </span><span class="p">|</span><span class="w"> </span><span class="m">23</span>.84<span class="w"> </span>GiB
Number<span class="w"> </span>of<span class="w"> </span>workers<span class="w">         </span><span class="p">|</span><span class="w"> </span><span class="nv">8</span>
<span class="o">================================================================================</span>
Wall<span class="w"> </span>clock<span class="w">                </span><span class="p">|</span><span class="w"> </span>Throughput
--------------------------------------------------------------------------------
<span class="m">48</span>.51<span class="w"> </span>s<span class="w">                   </span><span class="p">|</span><span class="w"> </span><span class="m">503</span>.25<span class="w"> </span>MiB/s
<span class="m">47</span>.85<span class="w"> </span>s<span class="w">                   </span><span class="p">|</span><span class="w"> </span><span class="m">510</span>.23<span class="w"> </span>MiB/s
<span class="m">41</span>.20<span class="w"> </span>s<span class="w">                   </span><span class="p">|</span><span class="w"> </span><span class="m">592</span>.57<span class="w"> </span>MiB/s
<span class="o">================================================================================</span>
Throughput<span class="w">                </span><span class="p">|</span><span class="w"> </span><span class="m">532</span>.43<span class="w"> </span>MiB/s<span class="w"> </span>+/-<span class="w"> </span><span class="m">22</span>.13<span class="w"> </span>MiB/s
Bandwidth<span class="w">                 </span><span class="p">|</span><span class="w"> </span><span class="m">44</span>.76<span class="w"> </span>MiB/s<span class="w"> </span>+/-<span class="w"> </span><span class="m">0</span>.93<span class="w"> </span>MiB/s
Wall<span class="w"> </span>clock<span class="w">                </span><span class="p">|</span><span class="w"> </span><span class="m">45</span>.85<span class="w"> </span>s<span class="w"> </span>+/-<span class="w"> </span><span class="m">3</span>.30<span class="w"> </span>s
</pre></div>
</div>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># UCX protocol</span>
python<span class="w"> </span>-m<span class="w"> </span>dask_cuda.benchmarks.local_cudf_merge<span class="w"> </span>--devs<span class="w"> </span><span class="m">0</span>,1,2,3,4,5,6,7<span class="w"> </span>--chunk-size<span class="w"> </span>100_000_000<span class="w"> </span>--protocol<span class="w"> </span>ucx<span class="w"> </span>--no-show-p2p-bandwidth
</pre></div>
</div>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>Merge<span class="w"> </span>benchmark
--------------------------------------------------------------------------------
Backend<span class="w">                   </span><span class="p">|</span><span class="w"> </span>dask
Merge<span class="w"> </span><span class="nb">type</span><span class="w">                </span><span class="p">|</span><span class="w"> </span>gpu
Rows-per-chunk<span class="w">            </span><span class="p">|</span><span class="w"> </span><span class="m">100000000</span>
Base-chunks<span class="w">               </span><span class="p">|</span><span class="w"> </span><span class="m">8</span>
Other-chunks<span class="w">              </span><span class="p">|</span><span class="w"> </span><span class="m">8</span>
Broadcast<span class="w">                 </span><span class="p">|</span><span class="w"> </span>default
Protocol<span class="w">                  </span><span class="p">|</span><span class="w"> </span>ucx
Device<span class="o">(</span>s<span class="o">)</span><span class="w">                 </span><span class="p">|</span><span class="w"> </span><span class="m">0</span>,1,2,3,4,5,6,7
RMM<span class="w"> </span>Pool<span class="w">                  </span><span class="p">|</span><span class="w"> </span>True
Frac-match<span class="w">                </span><span class="p">|</span><span class="w"> </span><span class="m">0</span>.3
TCP<span class="w">                       </span><span class="p">|</span><span class="w"> </span>None
InfiniBand<span class="w">                </span><span class="p">|</span><span class="w"> </span>None
NVLink<span class="w">                    </span><span class="p">|</span><span class="w"> </span>None
Worker<span class="w"> </span>thread<span class="o">(</span>s<span class="o">)</span><span class="w">          </span><span class="p">|</span><span class="w"> </span><span class="m">1</span>
Data<span class="w"> </span>processed<span class="w">            </span><span class="p">|</span><span class="w"> </span><span class="m">23</span>.84<span class="w"> </span>GiB
Number<span class="w"> </span>of<span class="w"> </span>workers<span class="w">         </span><span class="p">|</span><span class="w"> </span><span class="nv">8</span>
<span class="o">================================================================================</span>
Wall<span class="w"> </span>clock<span class="w">                </span><span class="p">|</span><span class="w"> </span>Throughput
--------------------------------------------------------------------------------
<span class="m">9</span>.57<span class="w"> </span>s<span class="w">                    </span><span class="p">|</span><span class="w"> </span><span class="m">2</span>.49<span class="w"> </span>GiB/s
<span class="m">6</span>.01<span class="w"> </span>s<span class="w">                    </span><span class="p">|</span><span class="w"> </span><span class="m">3</span>.96<span class="w"> </span>GiB/s
<span class="m">9</span>.80<span class="w"> </span>s<span class="w">                    </span><span class="p">|</span><span class="w"> </span><span class="m">2</span>.43<span class="w"> </span>GiB/s
<span class="o">================================================================================</span>
Throughput<span class="w">                </span><span class="p">|</span><span class="w"> </span><span class="m">2</span>.82<span class="w"> </span>GiB/s<span class="w"> </span>+/-<span class="w"> </span><span class="m">341</span>.13<span class="w"> </span>MiB/s
Bandwidth<span class="w">                 </span><span class="p">|</span><span class="w"> </span><span class="m">159</span>.89<span class="w"> </span>MiB/s<span class="w"> </span>+/-<span class="w"> </span><span class="m">8</span>.96<span class="w"> </span>MiB/s
Wall<span class="w"> </span>clock<span class="w">                </span><span class="p">|</span><span class="w"> </span><span class="m">8</span>.46<span class="w"> </span>s<span class="w"> </span>+/-<span class="w"> </span><span class="m">1</span>.73<span class="w"> </span>s
</pre></div>
</div>
</section>
</section>


            </article>
            
            
            
            <footer class="bd-footer-article">
                <!-- Previous / next buttons -->
<div class='prev-next-area'>
  <a class='left-prev' id="prev-link" href="../mig.html" title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
          <p class="prev-next-subtitle">previous</p>
          <p class="prev-next-title">Multi-Instance GPU (MIG)</p>
      </div>
  </a>
  <a class='right-next' id="next-link" href="../scheduler-gpu-requirements.html" title="next page">
  <div class="prev-next-info">
      <p class="prev-next-subtitle">next</p>
      <p class="prev-next-title">Does the Dask scheduler need a GPU?</p>
  </div>
  <i class="fa-solid fa-angle-right"></i>
  </a>
</div>
            </footer>
            
          </div>
          
          
          
            <div class="bd-sidebar-secondary bd-toc">
              
<div class="toc-item">
  
<div class="tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
</div>
<nav id="bd-toc-nav" class="page-toc">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#build-a-virtual-machine">
   Build a Virtual Machine
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#install-software">
   Install Software
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#nvidia-drivers">
     NVIDIA Drivers
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#infiniband-driver">
     InfiniBand Driver
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#enable-ipoib">
       Enable IPoIB
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#check-ib">
       Check IB
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#install-ucx-py-and-tools">
     Install UCX-Py and tools
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#run-tests">
     Run Tests
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#run-benchmarks">
   Run Benchmarks
  </a>
 </li>
</ul>

</nav>
</div>

<div class="toc-item">
  
</div>

<div class="toc-item">
  
</div>

            </div>
          
          
        </div>
        <footer class="bd-footer-content">
          <div class="bd-footer-content__inner">
            
          </div>
        </footer>
        
      </main>
    </div>
  </div>

  
    
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=796348d33e8b1d947c94"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=796348d33e8b1d947c94"></script>

  <footer class="bd-footer"><div class="bd-footer__inner container">
  
  <div class="footer-item">
    
<p class="copyright">

    &copy; Copyright 2023, NVIDIA.<br>

</p>

  </div>
  
  <div class="footer-item">
    <p class="theme-version">
    Built with the
    <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">
        PyData Sphinx Theme
    </a>
    0.12.0.
</p>
  </div>
  
  <div class="footer-item">
    
<p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 5.3.0.<br>
</p>

  </div>
  
</div>
  </footer>
  </body>
</html>